diff -Naur fakechroot-2.18.orig/aclocal.m4 fakechroot/aclocal.m4
--- fakechroot-2.18.orig/aclocal.m4	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/aclocal.m4	2016-11-04 19:09:24.528959192 +0000
@@ -1,6 +1,6 @@
-# generated automatically by aclocal 1.15 -*- Autoconf -*-
+# generated automatically by aclocal 1.13.4 -*- Autoconf -*-
 
-# Copyright (C) 1996-2014 Free Software Foundation, Inc.
+# Copyright (C) 1996-2013 Free Software Foundation, Inc.
 
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -20,7 +20,7 @@
 If you have problems, you may need to regenerate the build system entirely.
 To do so, use the procedure documented by the package, typically 'autoreconf'.])])
 
-# Copyright (C) 2002-2014 Free Software Foundation, Inc.
+# Copyright (C) 2002-2013 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -32,10 +32,10 @@
 # generated from the m4 files accompanying Automake X.Y.
 # (This private macro should not be called outside this file.)
 AC_DEFUN([AM_AUTOMAKE_VERSION],
-[am__api_version='1.15'
+[am__api_version='1.13'
 dnl Some users find AM_AUTOMAKE_VERSION and mistake it for a way to
 dnl require some minimum version.  Point them to the right macro.
-m4_if([$1], [1.15], [],
+m4_if([$1], [1.13.4], [],
       [AC_FATAL([Do not call $0, use AM_INIT_AUTOMAKE([$1]).])])dnl
 ])
 
@@ -51,14 +51,14 @@
 # Call AM_AUTOMAKE_VERSION and AM_AUTOMAKE_VERSION so they can be traced.
 # This function is AC_REQUIREd by AM_INIT_AUTOMAKE.
 AC_DEFUN([AM_SET_CURRENT_AUTOMAKE_VERSION],
-[AM_AUTOMAKE_VERSION([1.15])dnl
+[AM_AUTOMAKE_VERSION([1.13.4])dnl
 m4_ifndef([AC_AUTOCONF_VERSION],
   [m4_copy([m4_PACKAGE_VERSION], [AC_AUTOCONF_VERSION])])dnl
 _AM_AUTOCONF_VERSION(m4_defn([AC_AUTOCONF_VERSION]))])
 
 # AM_AUX_DIR_EXPAND                                         -*- Autoconf -*-
 
-# Copyright (C) 2001-2014 Free Software Foundation, Inc.
+# Copyright (C) 2001-2013 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -103,14 +103,15 @@
 # configured tree to be moved without reconfiguration.
 
 AC_DEFUN([AM_AUX_DIR_EXPAND],
-[AC_REQUIRE([AC_CONFIG_AUX_DIR_DEFAULT])dnl
-# Expand $ac_aux_dir to an absolute path.
-am_aux_dir=`cd "$ac_aux_dir" && pwd`
+[dnl Rely on autoconf to set up CDPATH properly.
+AC_PREREQ([2.50])dnl
+# expand $ac_aux_dir to an absolute path
+am_aux_dir=`cd $ac_aux_dir && pwd`
 ])
 
 # AM_CONDITIONAL                                            -*- Autoconf -*-
 
-# Copyright (C) 1997-2014 Free Software Foundation, Inc.
+# Copyright (C) 1997-2013 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -141,7 +142,7 @@
 Usually this means the macro was only invoked conditionally.]])
 fi])])
 
-# Copyright (C) 1999-2014 Free Software Foundation, Inc.
+# Copyright (C) 1999-2013 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -332,7 +333,7 @@
 
 # Generate code to set up dependency tracking.              -*- Autoconf -*-
 
-# Copyright (C) 1999-2014 Free Software Foundation, Inc.
+# Copyright (C) 1999-2013 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -408,7 +409,7 @@
 
 # Do all the work for Automake.                             -*- Autoconf -*-
 
-# Copyright (C) 1996-2014 Free Software Foundation, Inc.
+# Copyright (C) 1996-2013 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -417,12 +418,6 @@
 # This macro actually does too much.  Some checks are only needed if
 # your package does certain things.  But this isn't really a big deal.
 
-dnl Redefine AC_PROG_CC to automatically invoke _AM_PROG_CC_C_O.
-m4_define([AC_PROG_CC],
-m4_defn([AC_PROG_CC])
-[_AM_PROG_CC_C_O
-])
-
 # AM_INIT_AUTOMAKE(PACKAGE, VERSION, [NO-DEFINE])
 # AM_INIT_AUTOMAKE([OPTIONS])
 # -----------------------------------------------
@@ -498,8 +493,8 @@
 # <http://lists.gnu.org/archive/html/automake/2012-07/msg00001.html>
 # <http://lists.gnu.org/archive/html/automake/2012-07/msg00014.html>
 AC_SUBST([mkdir_p], ['$(MKDIR_P)'])
-# We need awk for the "check" target (and possibly the TAP driver).  The
-# system "awk" is bad on some platforms.
+# We need awk for the "check" target.  The system "awk" is bad on
+# some platforms.
 AC_REQUIRE([AC_PROG_AWK])dnl
 AC_REQUIRE([AC_PROG_MAKE_SET])dnl
 AC_REQUIRE([AM_SET_LEADING_DOT])dnl
@@ -531,51 +526,6 @@
 AC_CONFIG_COMMANDS_PRE(dnl
 [m4_provide_if([_AM_COMPILER_EXEEXT],
   [AM_CONDITIONAL([am__EXEEXT], [test -n "$EXEEXT"])])])dnl
-
-# POSIX will say in a future version that running "rm -f" with no argument
-# is OK; and we want to be able to make that assumption in our Makefile
-# recipes.  So use an aggressive probe to check that the usage we want is
-# actually supported "in the wild" to an acceptable degree.
-# See automake bug#10828.
-# To make any issue more visible, cause the running configure to be aborted
-# by default if the 'rm' program in use doesn't match our expectations; the
-# user can still override this though.
-if rm -f && rm -fr && rm -rf; then : OK; else
-  cat >&2 <<'END'
-Oops!
-
-Your 'rm' program seems unable to run without file operands specified
-on the command line, even when the '-f' option is present.  This is contrary
-to the behaviour of most rm programs out there, and not conforming with
-the upcoming POSIX standard: <http://austingroupbugs.net/view.php?id=542>
-
-Please tell bug-automake@gnu.org about your system, including the value
-of your $PATH and any error possibly output before this message.  This
-can help us improve future automake versions.
-
-END
-  if test x"$ACCEPT_INFERIOR_RM_PROGRAM" = x"yes"; then
-    echo 'Configuration will proceed anyway, since you have set the' >&2
-    echo 'ACCEPT_INFERIOR_RM_PROGRAM variable to "yes"' >&2
-    echo >&2
-  else
-    cat >&2 <<'END'
-Aborting the configuration process, to ensure you take notice of the issue.
-
-You can download and install GNU coreutils to get an 'rm' implementation
-that behaves properly: <http://www.gnu.org/software/coreutils/>.
-
-If you want to complete the configuration process using your problematic
-'rm' anyway, export the environment variable ACCEPT_INFERIOR_RM_PROGRAM
-to "yes", and re-run configure.
-
-END
-    AC_MSG_ERROR([Your 'rm' program is bad, sorry.])
-  fi
-fi
-dnl The trailing newline in this macro's definition is deliberate, for
-dnl backward compatibility and to allow trailing 'dnl'-style comments
-dnl after the AM_INIT_AUTOMAKE invocation. See automake bug#16841.
 ])
 
 dnl Hook into '_AC_COMPILER_EXEEXT' early to learn its expansion.  Do not
@@ -584,6 +534,7 @@
 m4_define([_AC_COMPILER_EXEEXT],
 m4_defn([_AC_COMPILER_EXEEXT])[m4_provide([_AM_COMPILER_EXEEXT])])
 
+
 # When config.status generates a header, we must update the stamp-h file.
 # This file resides in the same directory as the config header
 # that is generated.  The stamp files are numbered to have different names.
@@ -605,7 +556,7 @@
 done
 echo "timestamp for $_am_arg" >`AS_DIRNAME(["$_am_arg"])`/stamp-h[]$_am_stamp_count])
 
-# Copyright (C) 2001-2014 Free Software Foundation, Inc.
+# Copyright (C) 2001-2013 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -616,7 +567,7 @@
 # Define $install_sh.
 AC_DEFUN([AM_PROG_INSTALL_SH],
 [AC_REQUIRE([AM_AUX_DIR_EXPAND])dnl
-if test x"${install_sh+set}" != xset; then
+if test x"${install_sh}" != xset; then
   case $am_aux_dir in
   *\ * | *\	*)
     install_sh="\${SHELL} '$am_aux_dir/install-sh'" ;;
@@ -626,7 +577,7 @@
 fi
 AC_SUBST([install_sh])])
 
-# Copyright (C) 2003-2014 Free Software Foundation, Inc.
+# Copyright (C) 2003-2013 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -648,7 +599,7 @@
 # Add --enable-maintainer-mode option to configure.         -*- Autoconf -*-
 # From Jim Meyering
 
-# Copyright (C) 1996-2014 Free Software Foundation, Inc.
+# Copyright (C) 1996-2013 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -683,7 +634,7 @@
 
 # Check to see how 'make' treats includes.	            -*- Autoconf -*-
 
-# Copyright (C) 2001-2014 Free Software Foundation, Inc.
+# Copyright (C) 2001-2013 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -733,7 +684,7 @@
 
 # Fake the existence of programs that GNU maintainers use.  -*- Autoconf -*-
 
-# Copyright (C) 1997-2014 Free Software Foundation, Inc.
+# Copyright (C) 1997-2013 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -772,7 +723,7 @@
 
 # Helper functions for option handling.                     -*- Autoconf -*-
 
-# Copyright (C) 2001-2014 Free Software Foundation, Inc.
+# Copyright (C) 2001-2013 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -801,73 +752,9 @@
 AC_DEFUN([_AM_IF_OPTION],
 [m4_ifset(_AM_MANGLE_OPTION([$1]), [$2], [$3])])
 
-# Copyright (C) 1999-2014 Free Software Foundation, Inc.
-#
-# This file is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# _AM_PROG_CC_C_O
-# ---------------
-# Like AC_PROG_CC_C_O, but changed for automake.  We rewrite AC_PROG_CC
-# to automatically call this.
-AC_DEFUN([_AM_PROG_CC_C_O],
-[AC_REQUIRE([AM_AUX_DIR_EXPAND])dnl
-AC_REQUIRE_AUX_FILE([compile])dnl
-AC_LANG_PUSH([C])dnl
-AC_CACHE_CHECK(
-  [whether $CC understands -c and -o together],
-  [am_cv_prog_cc_c_o],
-  [AC_LANG_CONFTEST([AC_LANG_PROGRAM([])])
-  # Make sure it works both with $CC and with simple cc.
-  # Following AC_PROG_CC_C_O, we do the test twice because some
-  # compilers refuse to overwrite an existing .o file with -o,
-  # though they will create one.
-  am_cv_prog_cc_c_o=yes
-  for am_i in 1 2; do
-    if AM_RUN_LOG([$CC -c conftest.$ac_ext -o conftest2.$ac_objext]) \
-         && test -f conftest2.$ac_objext; then
-      : OK
-    else
-      am_cv_prog_cc_c_o=no
-      break
-    fi
-  done
-  rm -f core conftest*
-  unset am_i])
-if test "$am_cv_prog_cc_c_o" != yes; then
-   # Losing compiler, so override with the script.
-   # FIXME: It is wrong to rewrite CC.
-   # But if we don't then we get into trouble of one sort or another.
-   # A longer-term fix would be to have automake use am__CC in this case,
-   # and then we could set am__CC="\$(top_srcdir)/compile \$(CC)"
-   CC="$am_aux_dir/compile $CC"
-fi
-AC_LANG_POP([C])])
-
-# For backward compatibility.
-AC_DEFUN_ONCE([AM_PROG_CC_C_O], [AC_REQUIRE([AC_PROG_CC])])
-
-# Copyright (C) 2001-2014 Free Software Foundation, Inc.
-#
-# This file is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# AM_RUN_LOG(COMMAND)
-# -------------------
-# Run COMMAND, save the exit status in ac_status, and log it.
-# (This has been adapted from Autoconf's _AC_RUN_LOG macro.)
-AC_DEFUN([AM_RUN_LOG],
-[{ echo "$as_me:$LINENO: $1" >&AS_MESSAGE_LOG_FD
-   ($1) >&AS_MESSAGE_LOG_FD 2>&AS_MESSAGE_LOG_FD
-   ac_status=$?
-   echo "$as_me:$LINENO: \$? = $ac_status" >&AS_MESSAGE_LOG_FD
-   (exit $ac_status); }])
-
 # Check to make sure that the build environment is sane.    -*- Autoconf -*-
 
-# Copyright (C) 1996-2014 Free Software Foundation, Inc.
+# Copyright (C) 1996-2013 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -948,7 +835,7 @@
 rm -f conftest.file
 ])
 
-# Copyright (C) 2009-2014 Free Software Foundation, Inc.
+# Copyright (C) 2009-2013 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -1008,7 +895,7 @@
 _AM_SUBST_NOTMAKE([AM_BACKSLASH])dnl
 ])
 
-# Copyright (C) 2001-2014 Free Software Foundation, Inc.
+# Copyright (C) 2001-2013 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -1036,7 +923,7 @@
 INSTALL_STRIP_PROGRAM="\$(install_sh) -c -s"
 AC_SUBST([INSTALL_STRIP_PROGRAM])])
 
-# Copyright (C) 2006-2014 Free Software Foundation, Inc.
+# Copyright (C) 2006-2013 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -1055,7 +942,7 @@
 
 # Check how to create a tarball.                            -*- Autoconf -*-
 
-# Copyright (C) 2004-2014 Free Software Foundation, Inc.
+# Copyright (C) 2004-2013 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
diff -Naur fakechroot-2.18.orig/build-aux/compile fakechroot/build-aux/compile
--- fakechroot-2.18.orig/build-aux/compile	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/build-aux/compile	1970-01-01 01:00:00.000000000 +0100
@@ -1,347 +0,0 @@
-#! /bin/sh
-# Wrapper for compilers which do not understand '-c -o'.
-
-scriptversion=2012-10-14.11; # UTC
-
-# Copyright (C) 1999-2014 Free Software Foundation, Inc.
-# Written by Tom Tromey <tromey@cygnus.com>.
-#
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2, or (at your option)
-# any later version.
-#
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-#
-# You should have received a copy of the GNU General Public License
-# along with this program.  If not, see <http://www.gnu.org/licenses/>.
-
-# As a special exception to the GNU General Public License, if you
-# distribute this file as part of a program that contains a
-# configuration script generated by Autoconf, you may include it under
-# the same distribution terms that you use for the rest of that program.
-
-# This file is maintained in Automake, please report
-# bugs to <bug-automake@gnu.org> or send patches to
-# <automake-patches@gnu.org>.
-
-nl='
-'
-
-# We need space, tab and new line, in precisely that order.  Quoting is
-# there to prevent tools from complaining about whitespace usage.
-IFS=" ""	$nl"
-
-file_conv=
-
-# func_file_conv build_file lazy
-# Convert a $build file to $host form and store it in $file
-# Currently only supports Windows hosts. If the determined conversion
-# type is listed in (the comma separated) LAZY, no conversion will
-# take place.
-func_file_conv ()
-{
-  file=$1
-  case $file in
-    / | /[!/]*) # absolute file, and not a UNC file
-      if test -z "$file_conv"; then
-	# lazily determine how to convert abs files
-	case `uname -s` in
-	  MINGW*)
-	    file_conv=mingw
-	    ;;
-	  CYGWIN*)
-	    file_conv=cygwin
-	    ;;
-	  *)
-	    file_conv=wine
-	    ;;
-	esac
-      fi
-      case $file_conv/,$2, in
-	*,$file_conv,*)
-	  ;;
-	mingw/*)
-	  file=`cmd //C echo "$file " | sed -e 's/"\(.*\) " *$/\1/'`
-	  ;;
-	cygwin/*)
-	  file=`cygpath -m "$file" || echo "$file"`
-	  ;;
-	wine/*)
-	  file=`winepath -w "$file" || echo "$file"`
-	  ;;
-      esac
-      ;;
-  esac
-}
-
-# func_cl_dashL linkdir
-# Make cl look for libraries in LINKDIR
-func_cl_dashL ()
-{
-  func_file_conv "$1"
-  if test -z "$lib_path"; then
-    lib_path=$file
-  else
-    lib_path="$lib_path;$file"
-  fi
-  linker_opts="$linker_opts -LIBPATH:$file"
-}
-
-# func_cl_dashl library
-# Do a library search-path lookup for cl
-func_cl_dashl ()
-{
-  lib=$1
-  found=no
-  save_IFS=$IFS
-  IFS=';'
-  for dir in $lib_path $LIB
-  do
-    IFS=$save_IFS
-    if $shared && test -f "$dir/$lib.dll.lib"; then
-      found=yes
-      lib=$dir/$lib.dll.lib
-      break
-    fi
-    if test -f "$dir/$lib.lib"; then
-      found=yes
-      lib=$dir/$lib.lib
-      break
-    fi
-    if test -f "$dir/lib$lib.a"; then
-      found=yes
-      lib=$dir/lib$lib.a
-      break
-    fi
-  done
-  IFS=$save_IFS
-
-  if test "$found" != yes; then
-    lib=$lib.lib
-  fi
-}
-
-# func_cl_wrapper cl arg...
-# Adjust compile command to suit cl
-func_cl_wrapper ()
-{
-  # Assume a capable shell
-  lib_path=
-  shared=:
-  linker_opts=
-  for arg
-  do
-    if test -n "$eat"; then
-      eat=
-    else
-      case $1 in
-	-o)
-	  # configure might choose to run compile as 'compile cc -o foo foo.c'.
-	  eat=1
-	  case $2 in
-	    *.o | *.[oO][bB][jJ])
-	      func_file_conv "$2"
-	      set x "$@" -Fo"$file"
-	      shift
-	      ;;
-	    *)
-	      func_file_conv "$2"
-	      set x "$@" -Fe"$file"
-	      shift
-	      ;;
-	  esac
-	  ;;
-	-I)
-	  eat=1
-	  func_file_conv "$2" mingw
-	  set x "$@" -I"$file"
-	  shift
-	  ;;
-	-I*)
-	  func_file_conv "${1#-I}" mingw
-	  set x "$@" -I"$file"
-	  shift
-	  ;;
-	-l)
-	  eat=1
-	  func_cl_dashl "$2"
-	  set x "$@" "$lib"
-	  shift
-	  ;;
-	-l*)
-	  func_cl_dashl "${1#-l}"
-	  set x "$@" "$lib"
-	  shift
-	  ;;
-	-L)
-	  eat=1
-	  func_cl_dashL "$2"
-	  ;;
-	-L*)
-	  func_cl_dashL "${1#-L}"
-	  ;;
-	-static)
-	  shared=false
-	  ;;
-	-Wl,*)
-	  arg=${1#-Wl,}
-	  save_ifs="$IFS"; IFS=','
-	  for flag in $arg; do
-	    IFS="$save_ifs"
-	    linker_opts="$linker_opts $flag"
-	  done
-	  IFS="$save_ifs"
-	  ;;
-	-Xlinker)
-	  eat=1
-	  linker_opts="$linker_opts $2"
-	  ;;
-	-*)
-	  set x "$@" "$1"
-	  shift
-	  ;;
-	*.cc | *.CC | *.cxx | *.CXX | *.[cC]++)
-	  func_file_conv "$1"
-	  set x "$@" -Tp"$file"
-	  shift
-	  ;;
-	*.c | *.cpp | *.CPP | *.lib | *.LIB | *.Lib | *.OBJ | *.obj | *.[oO])
-	  func_file_conv "$1" mingw
-	  set x "$@" "$file"
-	  shift
-	  ;;
-	*)
-	  set x "$@" "$1"
-	  shift
-	  ;;
-      esac
-    fi
-    shift
-  done
-  if test -n "$linker_opts"; then
-    linker_opts="-link$linker_opts"
-  fi
-  exec "$@" $linker_opts
-  exit 1
-}
-
-eat=
-
-case $1 in
-  '')
-     echo "$0: No command.  Try '$0 --help' for more information." 1>&2
-     exit 1;
-     ;;
-  -h | --h*)
-    cat <<\EOF
-Usage: compile [--help] [--version] PROGRAM [ARGS]
-
-Wrapper for compilers which do not understand '-c -o'.
-Remove '-o dest.o' from ARGS, run PROGRAM with the remaining
-arguments, and rename the output as expected.
-
-If you are trying to build a whole package this is not the
-right script to run: please start by reading the file 'INSTALL'.
-
-Report bugs to <bug-automake@gnu.org>.
-EOF
-    exit $?
-    ;;
-  -v | --v*)
-    echo "compile $scriptversion"
-    exit $?
-    ;;
-  cl | *[/\\]cl | cl.exe | *[/\\]cl.exe )
-    func_cl_wrapper "$@"      # Doesn't return...
-    ;;
-esac
-
-ofile=
-cfile=
-
-for arg
-do
-  if test -n "$eat"; then
-    eat=
-  else
-    case $1 in
-      -o)
-	# configure might choose to run compile as 'compile cc -o foo foo.c'.
-	# So we strip '-o arg' only if arg is an object.
-	eat=1
-	case $2 in
-	  *.o | *.obj)
-	    ofile=$2
-	    ;;
-	  *)
-	    set x "$@" -o "$2"
-	    shift
-	    ;;
-	esac
-	;;
-      *.c)
-	cfile=$1
-	set x "$@" "$1"
-	shift
-	;;
-      *)
-	set x "$@" "$1"
-	shift
-	;;
-    esac
-  fi
-  shift
-done
-
-if test -z "$ofile" || test -z "$cfile"; then
-  # If no '-o' option was seen then we might have been invoked from a
-  # pattern rule where we don't need one.  That is ok -- this is a
-  # normal compilation that the losing compiler can handle.  If no
-  # '.c' file was seen then we are probably linking.  That is also
-  # ok.
-  exec "$@"
-fi
-
-# Name of file we expect compiler to create.
-cofile=`echo "$cfile" | sed 's|^.*[\\/]||; s|^[a-zA-Z]:||; s/\.c$/.o/'`
-
-# Create the lock directory.
-# Note: use '[/\\:.-]' here to ensure that we don't use the same name
-# that we are using for the .o file.  Also, base the name on the expected
-# object file name, since that is what matters with a parallel build.
-lockdir=`echo "$cofile" | sed -e 's|[/\\:.-]|_|g'`.d
-while true; do
-  if mkdir "$lockdir" >/dev/null 2>&1; then
-    break
-  fi
-  sleep 1
-done
-# FIXME: race condition here if user kills between mkdir and trap.
-trap "rmdir '$lockdir'; exit 1" 1 2 15
-
-# Run the compile.
-"$@"
-ret=$?
-
-if test -f "$cofile"; then
-  test "$cofile" = "$ofile" || mv "$cofile" "$ofile"
-elif test -f "${cofile}bj"; then
-  test "${cofile}bj" = "$ofile" || mv "${cofile}bj" "$ofile"
-fi
-
-rmdir "$lockdir"
-exit $ret
-
-# Local Variables:
-# mode: shell-script
-# sh-indentation: 2
-# eval: (add-hook 'write-file-hooks 'time-stamp)
-# time-stamp-start: "scriptversion="
-# time-stamp-format: "%:y-%02m-%02d.%02H"
-# time-stamp-time-zone: "UTC"
-# time-stamp-end: "; # UTC"
-# End:
diff -Naur fakechroot-2.18.orig/build-aux/config.guess fakechroot/build-aux/config.guess
--- fakechroot-2.18.orig/build-aux/config.guess	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/build-aux/config.guess	2016-11-04 19:09:27.102971253 +0000
@@ -1,8 +1,8 @@
 #! /bin/sh
 # Attempt to guess a canonical system name.
-#   Copyright 1992-2015 Free Software Foundation, Inc.
+#   Copyright 1992-2013 Free Software Foundation, Inc.
 
-timestamp='2015-08-20'
+timestamp='2013-06-10'
 
 # This file is free software; you can redistribute it and/or modify it
 # under the terms of the GNU General Public License as published by
@@ -24,12 +24,12 @@
 # program.  This Exception is an additional permission under section 7
 # of the GNU General Public License, version 3 ("GPLv3").
 #
-# Originally written by Per Bothner; maintained since 2000 by Ben Elliston.
+# Originally written by Per Bothner.
 #
 # You can get the latest version of this script from:
 # http://git.savannah.gnu.org/gitweb/?p=config.git;a=blob_plain;f=config.guess;hb=HEAD
 #
-# Please send patches to <config-patches@gnu.org>.
+# Please send patches with a ChangeLog entry to config-patches@gnu.org.
 
 
 me=`echo "$0" | sed -e 's,.*/,,'`
@@ -50,7 +50,7 @@
 GNU config.guess ($timestamp)
 
 Originally written by Per Bothner.
-Copyright 1992-2015 Free Software Foundation, Inc.
+Copyright 1992-2013 Free Software Foundation, Inc.
 
 This is free software; see the source for copying conditions.  There is NO
 warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE."
@@ -149,7 +149,7 @@
 	LIBC=gnu
 	#endif
 	EOF
-	eval `$CC_FOR_BUILD -E $dummy.c 2>/dev/null | grep '^LIBC' | sed 's, ,,g'`
+	eval `$CC_FOR_BUILD -E $dummy.c 2>/dev/null | grep '^LIBC'`
 	;;
 esac
 
@@ -168,27 +168,20 @@
 	# Note: NetBSD doesn't particularly care about the vendor
 	# portion of the name.  We always set it to "unknown".
 	sysctl="sysctl -n hw.machine_arch"
-	UNAME_MACHINE_ARCH=`(uname -p 2>/dev/null || \
-	    /sbin/$sysctl 2>/dev/null || \
-	    /usr/sbin/$sysctl 2>/dev/null || \
-	    echo unknown)`
+	UNAME_MACHINE_ARCH=`(/sbin/$sysctl 2>/dev/null || \
+	    /usr/sbin/$sysctl 2>/dev/null || echo unknown)`
 	case "${UNAME_MACHINE_ARCH}" in
 	    armeb) machine=armeb-unknown ;;
 	    arm*) machine=arm-unknown ;;
 	    sh3el) machine=shl-unknown ;;
 	    sh3eb) machine=sh-unknown ;;
 	    sh5el) machine=sh5le-unknown ;;
-	    earmv*)
-		arch=`echo ${UNAME_MACHINE_ARCH} | sed -e 's,^e\(armv[0-9]\).*$,\1,'`
-		endian=`echo ${UNAME_MACHINE_ARCH} | sed -ne 's,^.*\(eb\)$,\1,p'`
-		machine=${arch}${endian}-unknown
-		;;
 	    *) machine=${UNAME_MACHINE_ARCH}-unknown ;;
 	esac
 	# The Operating System including object format, if it has switched
 	# to ELF recently, or will in the future.
 	case "${UNAME_MACHINE_ARCH}" in
-	    arm*|earm*|i386|m68k|ns32k|sh3*|sparc|vax)
+	    arm*|i386|m68k|ns32k|sh3*|sparc|vax)
 		eval $set_cc_for_build
 		if echo __ELF__ | $CC_FOR_BUILD -E - 2>/dev/null \
 			| grep -q __ELF__
@@ -204,13 +197,6 @@
 		os=netbsd
 		;;
 	esac
-	# Determine ABI tags.
-	case "${UNAME_MACHINE_ARCH}" in
-	    earm*)
-		expr='s/^earmv[0-9]/-eabi/;s/eb$//'
-		abi=`echo ${UNAME_MACHINE_ARCH} | sed -e "$expr"`
-		;;
-	esac
 	# The OS release
 	# Debian GNU/NetBSD machines have a different userland, and
 	# thus, need a distinct triplet. However, they do not need
@@ -221,13 +207,13 @@
 		release='-gnu'
 		;;
 	    *)
-		release=`echo ${UNAME_RELEASE} | sed -e 's/[-_].*//' | cut -d. -f1,2`
+		release=`echo ${UNAME_RELEASE}|sed -e 's/[-_].*/\./'`
 		;;
 	esac
 	# Since CPU_TYPE-MANUFACTURER-KERNEL-OPERATING_SYSTEM:
 	# contains redundant information, the shorter form:
 	# CPU_TYPE-MANUFACTURER-OPERATING_SYSTEM is used.
-	echo "${machine}-${os}${release}${abi}"
+	echo "${machine}-${os}${release}"
 	exit ;;
     *:Bitrig:*:*)
 	UNAME_MACHINE_ARCH=`arch | sed 's/Bitrig.//'`
@@ -249,9 +235,6 @@
     *:MirBSD:*:*)
 	echo ${UNAME_MACHINE}-unknown-mirbsd${UNAME_RELEASE}
 	exit ;;
-    *:Sortix:*:*)
-	echo ${UNAME_MACHINE}-unknown-sortix
-	exit ;;
     alpha:OSF1:*:*)
 	case $UNAME_RELEASE in
 	*4.0)
@@ -596,9 +579,8 @@
 	else
 		IBM_ARCH=powerpc
 	fi
-	if [ -x /usr/bin/lslpp ] ; then
-		IBM_REV=`/usr/bin/lslpp -Lqc bos.rte.libc |
-			   awk -F: '{ print $3 }' | sed s/[0-9]*$/0/`
+	if [ -x /usr/bin/oslevel ] ; then
+		IBM_REV=`/usr/bin/oslevel`
 	else
 		IBM_REV=${UNAME_VERSION}.${UNAME_RELEASE}
 	fi
@@ -844,7 +826,7 @@
     *:MINGW*:*)
 	echo ${UNAME_MACHINE}-pc-mingw32
 	exit ;;
-    *:MSYS*:*)
+    i*:MSYS*:*)
 	echo ${UNAME_MACHINE}-pc-msys
 	exit ;;
     i*:windows32*:*)
@@ -950,9 +932,6 @@
     crisv32:Linux:*:*)
 	echo ${UNAME_MACHINE}-axis-linux-${LIBC}
 	exit ;;
-    e2k:Linux:*:*)
-	echo ${UNAME_MACHINE}-unknown-linux-${LIBC}
-	exit ;;
     frv:Linux:*:*)
 	echo ${UNAME_MACHINE}-unknown-linux-${LIBC}
 	exit ;;
@@ -990,10 +969,10 @@
 	eval `$CC_FOR_BUILD -E $dummy.c 2>/dev/null | grep '^CPU'`
 	test x"${CPU}" != x && { echo "${CPU}-unknown-linux-${LIBC}"; exit; }
 	;;
-    openrisc*:Linux:*:*)
-	echo or1k-unknown-linux-${LIBC}
+    or1k:Linux:*:*)
+	echo ${UNAME_MACHINE}-unknown-linux-${LIBC}
 	exit ;;
-    or32:Linux:*:* | or1k*:Linux:*:*)
+    or32:Linux:*:*)
 	echo ${UNAME_MACHINE}-unknown-linux-${LIBC}
 	exit ;;
     padre:Linux:*:*)
@@ -1041,7 +1020,7 @@
 	echo ${UNAME_MACHINE}-dec-linux-${LIBC}
 	exit ;;
     x86_64:Linux:*:*)
-	echo ${UNAME_MACHINE}-pc-linux-${LIBC}
+	echo ${UNAME_MACHINE}-unknown-linux-${LIBC}
 	exit ;;
     xtensa*:Linux:*:*)
 	echo ${UNAME_MACHINE}-unknown-linux-${LIBC}
@@ -1281,26 +1260,16 @@
 	if test "$UNAME_PROCESSOR" = unknown ; then
 	    UNAME_PROCESSOR=powerpc
 	fi
-	if test `echo "$UNAME_RELEASE" | sed -e 's/\..*//'` -le 10 ; then
-	    if [ "$CC_FOR_BUILD" != 'no_compiler_found' ]; then
-		if (echo '#ifdef __LP64__'; echo IS_64BIT_ARCH; echo '#endif') | \
-		    (CCOPTS= $CC_FOR_BUILD -E - 2>/dev/null) | \
-		    grep IS_64BIT_ARCH >/dev/null
-		then
-		    case $UNAME_PROCESSOR in
-			i386) UNAME_PROCESSOR=x86_64 ;;
-			powerpc) UNAME_PROCESSOR=powerpc64 ;;
-		    esac
-		fi
+	if [ "$CC_FOR_BUILD" != 'no_compiler_found' ]; then
+	    if (echo '#ifdef __LP64__'; echo IS_64BIT_ARCH; echo '#endif') | \
+		(CCOPTS= $CC_FOR_BUILD -E - 2>/dev/null) | \
+		grep IS_64BIT_ARCH >/dev/null
+	    then
+		case $UNAME_PROCESSOR in
+		    i386) UNAME_PROCESSOR=x86_64 ;;
+		    powerpc) UNAME_PROCESSOR=powerpc64 ;;
+		esac
 	    fi
-	elif test "$UNAME_PROCESSOR" = i386 ; then
-	    # Avoid executing cc on OS X 10.9, as it ships with a stub
-	    # that puts up a graphical alert prompting to install
-	    # developer tools.  Any system running Mac OS X 10.7 or
-	    # later (Darwin 11 and later) is required to have a 64-bit
-	    # processor. This is not true of the ARM version of Darwin
-	    # that Apple uses in portable devices.
-	    UNAME_PROCESSOR=x86_64
 	fi
 	echo ${UNAME_PROCESSOR}-apple-darwin${UNAME_RELEASE}
 	exit ;;
@@ -1392,6 +1361,154 @@
 	exit ;;
 esac
 
+eval $set_cc_for_build
+cat >$dummy.c <<EOF
+#ifdef _SEQUENT_
+# include <sys/types.h>
+# include <sys/utsname.h>
+#endif
+main ()
+{
+#if defined (sony)
+#if defined (MIPSEB)
+  /* BFD wants "bsd" instead of "newsos".  Perhaps BFD should be changed,
+     I don't know....  */
+  printf ("mips-sony-bsd\n"); exit (0);
+#else
+#include <sys/param.h>
+  printf ("m68k-sony-newsos%s\n",
+#ifdef NEWSOS4
+	"4"
+#else
+	""
+#endif
+	); exit (0);
+#endif
+#endif
+
+#if defined (__arm) && defined (__acorn) && defined (__unix)
+  printf ("arm-acorn-riscix\n"); exit (0);
+#endif
+
+#if defined (hp300) && !defined (hpux)
+  printf ("m68k-hp-bsd\n"); exit (0);
+#endif
+
+#if defined (NeXT)
+#if !defined (__ARCHITECTURE__)
+#define __ARCHITECTURE__ "m68k"
+#endif
+  int version;
+  version=`(hostinfo | sed -n 's/.*NeXT Mach \([0-9]*\).*/\1/p') 2>/dev/null`;
+  if (version < 4)
+    printf ("%s-next-nextstep%d\n", __ARCHITECTURE__, version);
+  else
+    printf ("%s-next-openstep%d\n", __ARCHITECTURE__, version);
+  exit (0);
+#endif
+
+#if defined (MULTIMAX) || defined (n16)
+#if defined (UMAXV)
+  printf ("ns32k-encore-sysv\n"); exit (0);
+#else
+#if defined (CMU)
+  printf ("ns32k-encore-mach\n"); exit (0);
+#else
+  printf ("ns32k-encore-bsd\n"); exit (0);
+#endif
+#endif
+#endif
+
+#if defined (__386BSD__)
+  printf ("i386-pc-bsd\n"); exit (0);
+#endif
+
+#if defined (sequent)
+#if defined (i386)
+  printf ("i386-sequent-dynix\n"); exit (0);
+#endif
+#if defined (ns32000)
+  printf ("ns32k-sequent-dynix\n"); exit (0);
+#endif
+#endif
+
+#if defined (_SEQUENT_)
+    struct utsname un;
+
+    uname(&un);
+
+    if (strncmp(un.version, "V2", 2) == 0) {
+	printf ("i386-sequent-ptx2\n"); exit (0);
+    }
+    if (strncmp(un.version, "V1", 2) == 0) { /* XXX is V1 correct? */
+	printf ("i386-sequent-ptx1\n"); exit (0);
+    }
+    printf ("i386-sequent-ptx\n"); exit (0);
+
+#endif
+
+#if defined (vax)
+# if !defined (ultrix)
+#  include <sys/param.h>
+#  if defined (BSD)
+#   if BSD == 43
+      printf ("vax-dec-bsd4.3\n"); exit (0);
+#   else
+#    if BSD == 199006
+      printf ("vax-dec-bsd4.3reno\n"); exit (0);
+#    else
+      printf ("vax-dec-bsd\n"); exit (0);
+#    endif
+#   endif
+#  else
+    printf ("vax-dec-bsd\n"); exit (0);
+#  endif
+# else
+    printf ("vax-dec-ultrix\n"); exit (0);
+# endif
+#endif
+
+#if defined (alliant) && defined (i860)
+  printf ("i860-alliant-bsd\n"); exit (0);
+#endif
+
+  exit (1);
+}
+EOF
+
+$CC_FOR_BUILD -o $dummy $dummy.c 2>/dev/null && SYSTEM_NAME=`$dummy` &&
+	{ echo "$SYSTEM_NAME"; exit; }
+
+# Apollos put the system type in the environment.
+
+test -d /usr/apollo && { echo ${ISP}-apollo-${SYSTYPE}; exit; }
+
+# Convex versions that predate uname can use getsysinfo(1)
+
+if [ -x /usr/convex/getsysinfo ]
+then
+    case `getsysinfo -f cpu_type` in
+    c1*)
+	echo c1-convex-bsd
+	exit ;;
+    c2*)
+	if getsysinfo -f scalar_acc
+	then echo c32-convex-bsd
+	else echo c2-convex-bsd
+	fi
+	exit ;;
+    c34*)
+	echo c34-convex-bsd
+	exit ;;
+    c38*)
+	echo c38-convex-bsd
+	exit ;;
+    c4*)
+	echo c4-convex-bsd
+	exit ;;
+    esac
+fi
+
 cat >&2 <<EOF
 $0: unable to guess system type
 
diff -Naur fakechroot-2.18.orig/build-aux/config.sub fakechroot/build-aux/config.sub
--- fakechroot-2.18.orig/build-aux/config.sub	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/build-aux/config.sub	2016-11-04 19:09:27.107971277 +0000
@@ -1,8 +1,8 @@
 #! /bin/sh
 # Configuration validation subroutine script.
-#   Copyright 1992-2015 Free Software Foundation, Inc.
+#   Copyright 1992-2013 Free Software Foundation, Inc.
 
-timestamp='2015-08-20'
+timestamp='2013-04-24'
 
 # This file is free software; you can redistribute it and/or modify it
 # under the terms of the GNU General Public License as published by
@@ -25,7 +25,7 @@
 # of the GNU General Public License, version 3 ("GPLv3").
 
 
-# Please send patches to <config-patches@gnu.org>.
+# Please send patches with a ChangeLog entry to config-patches@gnu.org.
 #
 # Configuration subroutine to validate and canonicalize a configuration type.
 # Supply the specified configuration type as an argument.
@@ -68,7 +68,7 @@
 version="\
 GNU config.sub ($timestamp)
 
-Copyright 1992-2015 Free Software Foundation, Inc.
+Copyright 1992-2013 Free Software Foundation, Inc.
 
 This is free software; see the source for copying conditions.  There is NO
 warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE."
@@ -117,7 +117,7 @@
 case $maybe_os in
   nto-qnx* | linux-gnu* | linux-android* | linux-dietlibc | linux-newlib* | \
   linux-musl* | linux-uclibc* | uclinux-uclibc* | uclinux-gnu* | kfreebsd*-gnu* | \
-  knetbsd*-gnu* | netbsd*-gnu* | netbsd*-eabi* | \
+  knetbsd*-gnu* | netbsd*-gnu* | \
   kopensolaris*-gnu* | \
   storm-chaos* | os2-emx* | rtmk-nova*)
     os=-$maybe_os
@@ -255,18 +255,16 @@
 	| arc | arceb \
 	| arm | arm[bl]e | arme[lb] | armv[2-8] | armv[3-8][lb] | armv7[arm] \
 	| avr | avr32 \
-	| ba \
 	| be32 | be64 \
 	| bfin \
-	| c4x | c8051 | clipper \
+	| c4x | clipper \
 	| d10v | d30v | dlx | dsp16xx \
-	| e2k | epiphany \
-	| fido | fr30 | frv | ft32 \
+	| epiphany \
+	| fido | fr30 | frv \
 	| h8300 | h8500 | hppa | hppa1.[01] | hppa2.0 | hppa2.0[nw] | hppa64 \
 	| hexagon \
 	| i370 | i860 | i960 | ia64 \
 	| ip2k | iq2000 \
-	| k1om \
 	| le32 | le64 \
 	| lm32 \
 	| m32c | m32r | m32rle | m68000 | m68k | m88k \
@@ -284,10 +282,8 @@
 	| mips64vr5900 | mips64vr5900el \
 	| mipsisa32 | mipsisa32el \
 	| mipsisa32r2 | mipsisa32r2el \
-	| mipsisa32r6 | mipsisa32r6el \
 	| mipsisa64 | mipsisa64el \
 	| mipsisa64r2 | mipsisa64r2el \
-	| mipsisa64r6 | mipsisa64r6el \
 	| mipsisa64sb1 | mipsisa64sb1el \
 	| mipsisa64sr71k | mipsisa64sr71kel \
 	| mipsr5900 | mipsr5900el \
@@ -299,14 +295,14 @@
 	| nds32 | nds32le | nds32be \
 	| nios | nios2 | nios2eb | nios2el \
 	| ns16k | ns32k \
-	| open8 | or1k | or1knd | or32 \
+	| open8 \
+	| or1k | or32 \
 	| pdp10 | pdp11 | pj | pjl \
 	| powerpc | powerpc64 | powerpc64le | powerpcle \
 	| pyramid \
-	| riscv32 | riscv64 \
 	| rl78 | rx \
 	| score \
-	| sh | sh[1234] | sh[24]a | sh[24]aeb | sh[23]e | sh[234]eb | sheb | shbe | shle | sh[1234]le | sh3ele \
+	| sh | sh[1234] | sh[24]a | sh[24]aeb | sh[23]e | sh[34]eb | sheb | shbe | shle | sh[1234]le | sh3ele \
 	| sh64 | sh64le \
 	| sparc | sparc64 | sparc64b | sparc64v | sparc86x | sparclet | sparclite \
 	| sparcv8 | sparcv9 | sparcv9b | sparcv9v \
@@ -314,7 +310,6 @@
 	| tahoe | tic4x | tic54x | tic55x | tic6x | tic80 | tron \
 	| ubicom32 \
 	| v850 | v850e | v850e1 | v850e2 | v850es | v850e2v3 \
-	| visium \
 	| we32k \
 	| x86 | xc16x | xstormy16 | xtensa \
 	| z8k | z80)
@@ -329,10 +324,7 @@
 	c6x)
 		basic_machine=tic6x-unknown
 		;;
-	leon|leon[3-9])
-		basic_machine=sparc-$basic_machine
-		;;
-	m6811 | m68hc11 | m6812 | m68hc12 | m68hcs12x | nvptx | picochip)
+	m6811 | m68hc11 | m6812 | m68hc12 | m68hcs12x | picochip)
 		basic_machine=$basic_machine-unknown
 		os=-none
 		;;
@@ -377,20 +369,18 @@
 	| alphapca5[67]-* | alpha64pca5[67]-* | arc-* | arceb-* \
 	| arm-*  | armbe-* | armle-* | armeb-* | armv*-* \
 	| avr-* | avr32-* \
-	| ba-* \
 	| be32-* | be64-* \
 	| bfin-* | bs2000-* \
 	| c[123]* | c30-* | [cjt]90-* | c4x-* \
-	| c8051-* | clipper-* | craynv-* | cydra-* \
+	| clipper-* | craynv-* | cydra-* \
 	| d10v-* | d30v-* | dlx-* \
-	| e2k-* | elxsi-* \
+	| elxsi-* \
 	| f30[01]-* | f700-* | fido-* | fr30-* | frv-* | fx80-* \
 	| h8300-* | h8500-* \
 	| hppa-* | hppa1.[01]-* | hppa2.0-* | hppa2.0[nw]-* | hppa64-* \
 	| hexagon-* \
 	| i*86-* | i860-* | i960-* | ia64-* \
 	| ip2k-* | iq2000-* \
-	| k1om-* \
 	| le32-* | le64-* \
 	| lm32-* \
 	| m32c-* | m32r-* | m32rle-* \
@@ -410,10 +400,8 @@
 	| mips64vr5900-* | mips64vr5900el-* \
 	| mipsisa32-* | mipsisa32el-* \
 	| mipsisa32r2-* | mipsisa32r2el-* \
-	| mipsisa32r6-* | mipsisa32r6el-* \
 	| mipsisa64-* | mipsisa64el-* \
 	| mipsisa64r2-* | mipsisa64r2el-* \
-	| mipsisa64r6-* | mipsisa64r6el-* \
 	| mipsisa64sb1-* | mipsisa64sb1el-* \
 	| mipsisa64sr71k-* | mipsisa64sr71kel-* \
 	| mipsr5900-* | mipsr5900el-* \
@@ -425,18 +413,16 @@
 	| nios-* | nios2-* | nios2eb-* | nios2el-* \
 	| none-* | np1-* | ns16k-* | ns32k-* \
 	| open8-* \
-	| or1k*-* \
 	| orion-* \
 	| pdp10-* | pdp11-* | pj-* | pjl-* | pn-* | power-* \
 	| powerpc-* | powerpc64-* | powerpc64le-* | powerpcle-* \
 	| pyramid-* \
-	| riscv32-* | riscv64-* \
 	| rl78-* | romp-* | rs6000-* | rx-* \
 	| sh-* | sh[1234]-* | sh[24]a-* | sh[24]aeb-* | sh[23]e-* | sh[34]eb-* | sheb-* | shbe-* \
 	| shle-* | sh[1234]le-* | sh3ele-* | sh64-* | sh64le-* \
 	| sparc-* | sparc64-* | sparc64b-* | sparc64v-* | sparc86x-* | sparclet-* \
 	| sparclite-* \
-	| sparcv8-* | sparcv9-* | sparcv9b-* | sparcv9v-* | sv1-* | sx*-* \
+	| sparcv8-* | sparcv9-* | sparcv9b-* | sparcv9v-* | sv1-* | sx?-* \
 	| tahoe-* \
 	| tic30-* | tic4x-* | tic54x-* | tic55x-* | tic6x-* | tic80-* \
 	| tile*-* \
@@ -444,7 +430,6 @@
 	| ubicom32-* \
 	| v850-* | v850e-* | v850e1-* | v850es-* | v850e2-* | v850e2v3-* \
 	| vax-* \
-	| visium-* \
 	| we32k-* \
 	| x86-* | x86_64-* | xc16x-* | xps100-* \
 	| xstormy16-* | xtensa*-* \
@@ -521,9 +506,6 @@
 		basic_machine=i386-pc
 		os=-aros
 		;;
-        asmjs)
-		basic_machine=asmjs-unknown
-		;;
 	aux)
 		basic_machine=m68k-apple
 		os=-aux
@@ -785,9 +767,6 @@
 		basic_machine=m68k-isi
 		os=-sysv
 		;;
-	leon-*|leon[3-9]-*)
-		basic_machine=sparc-`echo $basic_machine | sed 's/-.*//'`
-		;;
 	m68knommu)
 		basic_machine=m68k-unknown
 		os=-linux
@@ -815,7 +794,7 @@
 		os=-mingw64
 		;;
 	mingw32)
-		basic_machine=i686-pc
+		basic_machine=i386-pc
 		os=-mingw32
 		;;
 	mingw32ce)
@@ -843,10 +822,6 @@
 		basic_machine=powerpc-unknown
 		os=-morphos
 		;;
-	moxiebox)
-		basic_machine=moxie-unknown
-		os=-moxiebox
-		;;
 	msdos)
 		basic_machine=i386-pc
 		os=-msdos
@@ -855,7 +830,7 @@
 		basic_machine=`echo $basic_machine | sed -e 's/ms1-/mt-/'`
 		;;
 	msys)
-		basic_machine=i686-pc
+		basic_machine=i386-pc
 		os=-msys
 		;;
 	mvs)
@@ -1031,7 +1006,7 @@
 		;;
 	ppc64)	basic_machine=powerpc64-unknown
 		;;
-	ppc64-*) basic_machine=powerpc64-`echo $basic_machine | sed 's/^[^-]*-//'`
+	ppc64-* | ppc64p7-*) basic_machine=powerpc64-`echo $basic_machine | sed 's/^[^-]*-//'`
 		;;
 	ppc64le | powerpc64little | ppc64-le | powerpc64-little)
 		basic_machine=powerpc64le-unknown
@@ -1379,7 +1354,7 @@
 	      | -hpux* | -unos* | -osf* | -luna* | -dgux* | -auroraux* | -solaris* \
 	      | -sym* | -kopensolaris* | -plan9* \
 	      | -amigaos* | -amigados* | -msdos* | -newsos* | -unicos* | -aof* \
-	      | -aos* | -aros* | -cloudabi* | -sortix* \
+	      | -aos* | -aros* \
 	      | -nindy* | -vxsim* | -vxworks* | -ebmon* | -hms* | -mvs* \
 	      | -clix* | -riscos* | -uniplus* | -iris* | -rtu* | -xenix* \
 	      | -hiux* | -386bsd* | -knetbsd* | -mirbsd* | -netbsd* \
@@ -1392,14 +1367,14 @@
 	      | -cygwin* | -msys* | -pe* | -psos* | -moss* | -proelf* | -rtems* \
 	      | -mingw32* | -mingw64* | -linux-gnu* | -linux-android* \
 	      | -linux-newlib* | -linux-musl* | -linux-uclibc* \
-	      | -uxpv* | -beos* | -mpeix* | -udk* | -moxiebox* \
+	      | -uxpv* | -beos* | -mpeix* | -udk* \
 	      | -interix* | -uwin* | -mks* | -rhapsody* | -darwin* | -opened* \
 	      | -openstep* | -oskit* | -conix* | -pw32* | -nonstopux* \
 	      | -storm-chaos* | -tops10* | -tenex* | -tops20* | -its* \
 	      | -os2* | -vos* | -palmos* | -uclinux* | -nucleus* \
 	      | -morphos* | -superux* | -rtmk* | -rtmk-nova* | -windiss* \
 	      | -powermax* | -dnix* | -nx6 | -nx7 | -sei* | -dragonfly* \
-	      | -skyos* | -haiku* | -rdos* | -toppers* | -drops* | -es* | -tirtos*)
+	      | -skyos* | -haiku* | -rdos* | -toppers* | -drops* | -es*)
 	# Remember, each alternative MUST END IN *, to match a version number.
 		;;
 	-qnx*)
@@ -1571,9 +1546,6 @@
 	c4x-* | tic4x-*)
 		os=-coff
 		;;
-	c8051-*)
-		os=-elf
-		;;
 	hexagon-*)
 		os=-elf
 		;;
@@ -1617,6 +1589,9 @@
 	mips*-*)
 		os=-elf
 		;;
+	or1k-*)
+		os=-elf
+		;;
 	or32-*)
 		os=-coff
 		;;
diff -Naur fakechroot-2.18.orig/build-aux/depcomp fakechroot/build-aux/depcomp
--- fakechroot-2.18.orig/build-aux/depcomp	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/build-aux/depcomp	2016-11-04 19:09:27.399972645 +0000
@@ -3,7 +3,7 @@
 
 scriptversion=2013-05-30.07; # UTC
 
-# Copyright (C) 1999-2014 Free Software Foundation, Inc.
+# Copyright (C) 1999-2013 Free Software Foundation, Inc.
 
 # This program is free software; you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
diff -Naur fakechroot-2.18.orig/build-aux/install-sh fakechroot/build-aux/install-sh
--- fakechroot-2.18.orig/build-aux/install-sh	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/build-aux/install-sh	2016-11-04 19:09:27.112971300 +0000
@@ -1,7 +1,7 @@
 #!/bin/sh
 # install - install a program, script, or datafile
 
-scriptversion=2014-09-12.12; # UTC
+scriptversion=2011-11-20.07; # UTC
 
 # This originates from X11R5 (mit/util/scripts/install.sh), which was
 # later released in X11R6 (xc/config/util/install.sh) with the
@@ -41,15 +41,19 @@
 # This script is compatible with the BSD install script, but was written
 # from scratch.
 
-tab='	'
 nl='
 '
-IFS=" $tab$nl"
+IFS=" ""	$nl"
 
-# Set DOITPROG to "echo" to test this script.
+# set DOITPROG to echo to test this script
 
+# Don't use :- since 4.3BSD and earlier shells don't like it.
 doit=${DOITPROG-}
-doit_exec=${doit:-exec}
+if test -z "$doit"; then
+  doit_exec=exec
+else
+  doit_exec=$doit
+fi
 
 # Put in absolute file names if you don't have them in your path;
 # or use environment vars.
@@ -64,6 +68,17 @@
 rmprog=${RMPROG-rm}
 stripprog=${STRIPPROG-strip}
 
+posix_glob='?'
+initialize_posix_glob='
+  test "$posix_glob" != "?" || {
+    if (set -f) 2>/dev/null; then
+      posix_glob=
+    else
+      posix_glob=:
+    fi
+  }
+'
+
 posix_mkdir=
 
 # Desired mode of installed file.
@@ -82,7 +97,7 @@
 dst_arg=
 
 copy_on_change=false
-is_target_a_directory=possibly
+no_target_directory=
 
 usage="\
 Usage: $0 [OPTION]... [-T] SRCFILE DSTFILE
@@ -122,57 +137,46 @@
     -d) dir_arg=true;;
 
     -g) chgrpcmd="$chgrpprog $2"
-        shift;;
+	shift;;
 
     --help) echo "$usage"; exit $?;;
 
     -m) mode=$2
-        case $mode in
-          *' '* | *"$tab"* | *"$nl"* | *'*'* | *'?'* | *'['*)
-            echo "$0: invalid mode: $mode" >&2
-            exit 1;;
-        esac
-        shift;;
+	case $mode in
+	  *' '* | *'	'* | *'
+'*	  | *'*'* | *'?'* | *'['*)
+	    echo "$0: invalid mode: $mode" >&2
+	    exit 1;;
+	esac
+	shift;;
 
     -o) chowncmd="$chownprog $2"
-        shift;;
+	shift;;
 
     -s) stripcmd=$stripprog;;
 
-    -t)
-        is_target_a_directory=always
-        dst_arg=$2
-        # Protect names problematic for 'test' and other utilities.
-        case $dst_arg in
-          -* | [=\(\)!]) dst_arg=./$dst_arg;;
-        esac
-        shift;;
+    -t) dst_arg=$2
+	# Protect names problematic for 'test' and other utilities.
+	case $dst_arg in
+	  -* | [=\(\)!]) dst_arg=./$dst_arg;;
+	esac
+	shift;;
 
-    -T) is_target_a_directory=never;;
+    -T) no_target_directory=true;;
 
     --version) echo "$0 $scriptversion"; exit $?;;
 
-    --) shift
-        break;;
+    --)	shift
+	break;;
 
-    -*) echo "$0: invalid option: $1" >&2
-        exit 1;;
+    -*)	echo "$0: invalid option: $1" >&2
+	exit 1;;
 
     *)  break;;
   esac
   shift
 done
 
-# We allow the use of options -d and -T together, by making -d
-# take the precedence; this is for compatibility with GNU install.
-
-if test -n "$dir_arg"; then
-  if test -n "$dst_arg"; then
-    echo "$0: target directory not allowed when installing a directory." >&2
-    exit 1
-  fi
-fi
-
 if test $# -ne 0 && test -z "$dir_arg$dst_arg"; then
   # When -d is used, all remaining arguments are directories to create.
   # When -t is used, the destination is already specified.
@@ -204,15 +208,6 @@
 fi
 
 if test -z "$dir_arg"; then
-  if test $# -gt 1 || test "$is_target_a_directory" = always; then
-    if test ! -d "$dst_arg"; then
-      echo "$0: $dst_arg: Is not a directory." >&2
-      exit 1
-    fi
-  fi
-fi
-
-if test -z "$dir_arg"; then
   do_exit='(exit $ret); exit $ret'
   trap "ret=129; $do_exit" 1
   trap "ret=130; $do_exit" 2
@@ -228,16 +223,16 @@
 
     *[0-7])
       if test -z "$stripcmd"; then
-        u_plus_rw=
+	u_plus_rw=
       else
-        u_plus_rw='% 200'
+	u_plus_rw='% 200'
       fi
       cp_umask=`expr '(' 777 - $mode % 1000 ')' $u_plus_rw`;;
     *)
       if test -z "$stripcmd"; then
-        u_plus_rw=
+	u_plus_rw=
       else
-        u_plus_rw=,u+rw
+	u_plus_rw=,u+rw
       fi
       cp_umask=$mode$u_plus_rw;;
   esac
@@ -274,15 +269,41 @@
     # If destination is a directory, append the input filename; won't work
     # if double slashes aren't ignored.
     if test -d "$dst"; then
-      if test "$is_target_a_directory" = never; then
-        echo "$0: $dst_arg: Is a directory" >&2
-        exit 1
+      if test -n "$no_target_directory"; then
+	echo "$0: $dst_arg: Is a directory" >&2
+	exit 1
       fi
       dstdir=$dst
       dst=$dstdir/`basename "$src"`
       dstdir_status=0
     else
-      dstdir=`dirname "$dst"`
+      # Prefer dirname, but fall back on a substitute if dirname fails.
+      dstdir=`
+	(dirname "$dst") 2>/dev/null ||
+	expr X"$dst" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
+	     X"$dst" : 'X\(//\)[^/]' \| \
+	     X"$dst" : 'X\(//\)$' \| \
+	     X"$dst" : 'X\(/\)' \| . 2>/dev/null ||
+	echo X"$dst" |
+	    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{
+		   s//\1/
+		   q
+		 }
+		 /^X\(\/\/\)[^/].*/{
+		   s//\1/
+		   q
+		 }
+		 /^X\(\/\/\)$/{
+		   s//\1/
+		   q
+		 }
+		 /^X\(\/\).*/{
+		   s//\1/
+		   q
+		 }
+		 s/.*/./; q'
+      `
+
       test -d "$dstdir"
       dstdir_status=$?
     fi
@@ -293,81 +314,74 @@
   if test $dstdir_status != 0; then
     case $posix_mkdir in
       '')
-        # Create intermediate dirs using mode 755 as modified by the umask.
-        # This is like FreeBSD 'install' as of 1997-10-28.
-        umask=`umask`
-        case $stripcmd.$umask in
-          # Optimize common cases.
-          *[2367][2367]) mkdir_umask=$umask;;
-          .*0[02][02] | .[02][02] | .[02]) mkdir_umask=22;;
-
-          *[0-7])
-            mkdir_umask=`expr $umask + 22 \
-              - $umask % 100 % 40 + $umask % 20 \
-              - $umask % 10 % 4 + $umask % 2
-            `;;
-          *) mkdir_umask=$umask,go-w;;
-        esac
-
-        # With -d, create the new directory with the user-specified mode.
-        # Otherwise, rely on $mkdir_umask.
-        if test -n "$dir_arg"; then
-          mkdir_mode=-m$mode
-        else
-          mkdir_mode=
-        fi
-
-        posix_mkdir=false
-        case $umask in
-          *[123567][0-7][0-7])
-            # POSIX mkdir -p sets u+wx bits regardless of umask, which
-            # is incompatible with FreeBSD 'install' when (umask & 300) != 0.
-            ;;
-          *)
-            # $RANDOM is not portable (e.g. dash);  use it when possible to
-            # lower collision chance
-            tmpdir=${TMPDIR-/tmp}/ins$RANDOM-$$
-            trap 'ret=$?; rmdir "$tmpdir/a/b" "$tmpdir/a" "$tmpdir" 2>/dev/null; exit $ret' 0
-
-            # As "mkdir -p" follows symlinks and we work in /tmp possibly;  so
-            # create the $tmpdir first (and fail if unsuccessful) to make sure
-            # that nobody tries to guess the $tmpdir name.
-            if (umask $mkdir_umask &&
-                $mkdirprog $mkdir_mode "$tmpdir" &&
-                exec $mkdirprog $mkdir_mode -p -- "$tmpdir/a/b") >/dev/null 2>&1
-            then
-              if test -z "$dir_arg" || {
-                   # Check for POSIX incompatibilities with -m.
-                   # HP-UX 11.23 and IRIX 6.5 mkdir -m -p sets group- or
-                   # other-writable bit of parent directory when it shouldn't.
-                   # FreeBSD 6.1 mkdir -m -p sets mode of existing directory.
-                   test_tmpdir="$tmpdir/a"
-                   ls_ld_tmpdir=`ls -ld "$test_tmpdir"`
-                   case $ls_ld_tmpdir in
-                     d????-?r-*) different_mode=700;;
-                     d????-?--*) different_mode=755;;
-                     *) false;;
-                   esac &&
-                   $mkdirprog -m$different_mode -p -- "$test_tmpdir" && {
-                     ls_ld_tmpdir_1=`ls -ld "$test_tmpdir"`
-                     test "$ls_ld_tmpdir" = "$ls_ld_tmpdir_1"
-                   }
-                 }
-              then posix_mkdir=:
-              fi
-              rmdir "$tmpdir/a/b" "$tmpdir/a" "$tmpdir"
-            else
-              # Remove any dirs left behind by ancient mkdir implementations.
-              rmdir ./$mkdir_mode ./-p ./-- "$tmpdir" 2>/dev/null
-            fi
-            trap '' 0;;
-        esac;;
+	# Create intermediate dirs using mode 755 as modified by the umask.
+	# This is like FreeBSD 'install' as of 1997-10-28.
+	umask=`umask`
+	case $stripcmd.$umask in
+	  # Optimize common cases.
+	  *[2367][2367]) mkdir_umask=$umask;;
+	  .*0[02][02] | .[02][02] | .[02]) mkdir_umask=22;;
+
+	  *[0-7])
+	    mkdir_umask=`expr $umask + 22 \
+	      - $umask % 100 % 40 + $umask % 20 \
+	      - $umask % 10 % 4 + $umask % 2
+	    `;;
+	  *) mkdir_umask=$umask,go-w;;
+	esac
+
+	# With -d, create the new directory with the user-specified mode.
+	# Otherwise, rely on $mkdir_umask.
+	if test -n "$dir_arg"; then
+	  mkdir_mode=-m$mode
+	else
+	  mkdir_mode=
+	fi
+
+	posix_mkdir=false
+	case $umask in
+	  *[123567][0-7][0-7])
+	    # POSIX mkdir -p sets u+wx bits regardless of umask, which
+	    # is incompatible with FreeBSD 'install' when (umask & 300) != 0.
+	    ;;
+	  *)
+	    tmpdir=${TMPDIR-/tmp}/ins$RANDOM-$$
+	    trap 'ret=$?; rmdir "$tmpdir/d" "$tmpdir" 2>/dev/null; exit $ret' 0
+
+	    if (umask $mkdir_umask &&
+		exec $mkdirprog $mkdir_mode -p -- "$tmpdir/d") >/dev/null 2>&1
+	    then
+	      if test -z "$dir_arg" || {
+		   # Check for POSIX incompatibilities with -m.
+		   # HP-UX 11.23 and IRIX 6.5 mkdir -m -p sets group- or
+		   # other-writable bit of parent directory when it shouldn't.
+		   # FreeBSD 6.1 mkdir -m -p sets mode of existing directory.
+		   ls_ld_tmpdir=`ls -ld "$tmpdir"`
+		   case $ls_ld_tmpdir in
+		     d????-?r-*) different_mode=700;;
+		     d????-?--*) different_mode=755;;
+		     *) false;;
+		   esac &&
+		   $mkdirprog -m$different_mode -p -- "$tmpdir" && {
+		     ls_ld_tmpdir_1=`ls -ld "$tmpdir"`
+		     test "$ls_ld_tmpdir" = "$ls_ld_tmpdir_1"
+		   }
+		 }
+	      then posix_mkdir=:
+	      fi
+	      rmdir "$tmpdir/d" "$tmpdir"
+	    else
+	      # Remove any dirs left behind by ancient mkdir implementations.
+	      rmdir ./$mkdir_mode ./-p ./-- 2>/dev/null
+	    fi
+	    trap '' 0;;
+	esac;;
     esac
 
     if
       $posix_mkdir && (
-        umask $mkdir_umask &&
-        $doit_exec $mkdirprog $mkdir_mode -p -- "$dstdir"
+	umask $mkdir_umask &&
+	$doit_exec $mkdirprog $mkdir_mode -p -- "$dstdir"
       )
     then :
     else
@@ -377,51 +391,53 @@
       # directory the slow way, step by step, checking for races as we go.
 
       case $dstdir in
-        /*) prefix='/';;
-        [-=\(\)!]*) prefix='./';;
-        *)  prefix='';;
+	/*) prefix='/';;
+	[-=\(\)!]*) prefix='./';;
+	*)  prefix='';;
       esac
 
+      eval "$initialize_posix_glob"
+
       oIFS=$IFS
       IFS=/
-      set -f
+      $posix_glob set -f
       set fnord $dstdir
       shift
-      set +f
+      $posix_glob set +f
       IFS=$oIFS
 
       prefixes=
 
       for d
       do
-        test X"$d" = X && continue
+	test X"$d" = X && continue
 
-        prefix=$prefix$d
-        if test -d "$prefix"; then
-          prefixes=
-        else
-          if $posix_mkdir; then
-            (umask=$mkdir_umask &&
-             $doit_exec $mkdirprog $mkdir_mode -p -- "$dstdir") && break
-            # Don't fail if two instances are running concurrently.
-            test -d "$prefix" || exit 1
-          else
-            case $prefix in
-              *\'*) qprefix=`echo "$prefix" | sed "s/'/'\\\\\\\\''/g"`;;
-              *) qprefix=$prefix;;
-            esac
-            prefixes="$prefixes '$qprefix'"
-          fi
-        fi
-        prefix=$prefix/
+	prefix=$prefix$d
+	if test -d "$prefix"; then
+	  prefixes=
+	else
+	  if $posix_mkdir; then
+	    (umask=$mkdir_umask &&
+	     $doit_exec $mkdirprog $mkdir_mode -p -- "$dstdir") && break
+	    # Don't fail if two instances are running concurrently.
+	    test -d "$prefix" || exit 1
+	  else
+	    case $prefix in
+	      *\'*) qprefix=`echo "$prefix" | sed "s/'/'\\\\\\\\''/g"`;;
+	      *) qprefix=$prefix;;
+	    esac
+	    prefixes="$prefixes '$qprefix'"
+	  fi
+	fi
+	prefix=$prefix/
       done
 
       if test -n "$prefixes"; then
-        # Don't fail if two instances are running concurrently.
-        (umask $mkdir_umask &&
-         eval "\$doit_exec \$mkdirprog $prefixes") ||
-          test -d "$dstdir" || exit 1
-        obsolete_mkdir_used=true
+	# Don't fail if two instances are running concurrently.
+	(umask $mkdir_umask &&
+	 eval "\$doit_exec \$mkdirprog $prefixes") ||
+	  test -d "$dstdir" || exit 1
+	obsolete_mkdir_used=true
       fi
     fi
   fi
@@ -456,12 +472,15 @@
 
     # If -C, don't bother to copy if it wouldn't change the file.
     if $copy_on_change &&
-       old=`LC_ALL=C ls -dlL "$dst"     2>/dev/null` &&
-       new=`LC_ALL=C ls -dlL "$dsttmp"  2>/dev/null` &&
-       set -f &&
+       old=`LC_ALL=C ls -dlL "$dst"	2>/dev/null` &&
+       new=`LC_ALL=C ls -dlL "$dsttmp"	2>/dev/null` &&
+
+       eval "$initialize_posix_glob" &&
+       $posix_glob set -f &&
        set X $old && old=:$2:$4:$5:$6 &&
        set X $new && new=:$2:$4:$5:$6 &&
-       set +f &&
+       $posix_glob set +f &&
+
        test "$old" = "$new" &&
        $cmpprog "$dst" "$dsttmp" >/dev/null 2>&1
     then
@@ -474,24 +493,24 @@
       # to itself, or perhaps because mv is so ancient that it does not
       # support -f.
       {
-        # Now remove or move aside any old file at destination location.
-        # We try this two ways since rm can't unlink itself on some
-        # systems and the destination file might be busy for other
-        # reasons.  In this case, the final cleanup might fail but the new
-        # file should still install successfully.
-        {
-          test ! -f "$dst" ||
-          $doit $rmcmd -f "$dst" 2>/dev/null ||
-          { $doit $mvcmd -f "$dst" "$rmtmp" 2>/dev/null &&
-            { $doit $rmcmd -f "$rmtmp" 2>/dev/null; :; }
-          } ||
-          { echo "$0: cannot unlink or rename $dst" >&2
-            (exit 1); exit 1
-          }
-        } &&
+	# Now remove or move aside any old file at destination location.
+	# We try this two ways since rm can't unlink itself on some
+	# systems and the destination file might be busy for other
+	# reasons.  In this case, the final cleanup might fail but the new
+	# file should still install successfully.
+	{
+	  test ! -f "$dst" ||
+	  $doit $rmcmd -f "$dst" 2>/dev/null ||
+	  { $doit $mvcmd -f "$dst" "$rmtmp" 2>/dev/null &&
+	    { $doit $rmcmd -f "$rmtmp" 2>/dev/null; :; }
+	  } ||
+	  { echo "$0: cannot unlink or rename $dst" >&2
+	    (exit 1); exit 1
+	  }
+	} &&
 
-        # Now rename the file to the real destination.
-        $doit $mvcmd "$dsttmp" "$dst"
+	# Now rename the file to the real destination.
+	$doit $mvcmd "$dsttmp" "$dst"
       }
     fi || exit 1
 
diff -Naur fakechroot-2.18.orig/build-aux/ltmain.sh fakechroot/build-aux/ltmain.sh
--- fakechroot-2.18.orig/build-aux/ltmain.sh	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/build-aux/ltmain.sh	2016-11-04 19:09:20.982942577 +0000
@@ -70,7 +70,7 @@
 #         compiler:		$LTCC
 #         compiler flags:		$LTCFLAGS
 #         linker:		$LD (gnu? $with_gnu_ld)
-#         $progname:	(GNU libtool) 2.4.2 Debian-2.4.2-1.11
+#         $progname:	(GNU libtool) 2.4.2
 #         automake:	$automake_version
 #         autoconf:	$autoconf_version
 #
@@ -80,7 +80,7 @@
 
 PROGRAM=libtool
 PACKAGE=libtool
-VERSION="2.4.2 Debian-2.4.2-1.11"
+VERSION=2.4.2
 TIMESTAMP=""
 package_revision=1.3337
 
@@ -6124,10 +6124,7 @@
 	case $pass in
 	dlopen) libs="$dlfiles" ;;
 	dlpreopen) libs="$dlprefiles" ;;
-	link)
-	  libs="$deplibs %DEPLIBS%"
-	  test "X$link_all_deplibs" != Xno && libs="$libs $dependency_libs"
-	  ;;
+	link) libs="$deplibs %DEPLIBS% $dependency_libs" ;;
 	esac
       fi
       if test "$linkmode,$pass" = "lib,dlpreopen"; then
@@ -6447,19 +6444,19 @@
 	    # It is a libtool convenience library, so add in its objects.
 	    func_append convenience " $ladir/$objdir/$old_library"
 	    func_append old_convenience " $ladir/$objdir/$old_library"
-	    tmp_libs=
-	    for deplib in $dependency_libs; do
-	      deplibs="$deplib $deplibs"
-	      if $opt_preserve_dup_deps ; then
-		case "$tmp_libs " in
-		*" $deplib "*) func_append specialdeplibs " $deplib" ;;
-		esac
-	      fi
-	      func_append tmp_libs " $deplib"
-	    done
 	  elif test "$linkmode" != prog && test "$linkmode" != lib; then
 	    func_fatal_error "\`$lib' is not a convenience library"
 	  fi
+	  tmp_libs=
+	  for deplib in $dependency_libs; do
+	    deplibs="$deplib $deplibs"
+	    if $opt_preserve_dup_deps ; then
+	      case "$tmp_libs " in
+	      *" $deplib "*) func_append specialdeplibs " $deplib" ;;
+	      esac
+	    fi
+	    func_append tmp_libs " $deplib"
+	  done
 	  continue
 	fi # $pass = conv
 
@@ -7352,9 +7349,6 @@
 	    revision="$number_minor"
 	    lt_irix_increment=no
 	    ;;
-	  *)
-	    func_fatal_configuration "$modename: unknown library version type \`$version_type'"
-	    ;;
 	  esac
 	  ;;
 	no)
diff -Naur fakechroot-2.18.orig/build-aux/missing fakechroot/build-aux/missing
--- fakechroot-2.18.orig/build-aux/missing	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/build-aux/missing	2016-11-04 19:09:27.119971333 +0000
@@ -1,9 +1,9 @@
 #! /bin/sh
 # Common wrapper for a few potentially missing GNU programs.
 
-scriptversion=2013-10-28.13; # UTC
+scriptversion=2012-06-26.16; # UTC
 
-# Copyright (C) 1996-2014 Free Software Foundation, Inc.
+# Copyright (C) 1996-2013 Free Software Foundation, Inc.
 # Originally written by Fran,cois Pinard <pinard@iro.umontreal.ca>, 1996.
 
 # This program is free software; you can redistribute it and/or modify
@@ -160,7 +160,7 @@
       ;;
    autom4te*)
       echo "You might have modified some maintainer files that require"
-      echo "the 'autom4te' program to be rebuilt."
+      echo "the 'automa4te' program to be rebuilt."
       program_details 'autom4te'
       ;;
     bison*|yacc*)
diff -Naur fakechroot-2.18.orig/build-aux/test-driver fakechroot/build-aux/test-driver
--- fakechroot-2.18.orig/build-aux/test-driver	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/build-aux/test-driver	2016-11-04 19:09:27.345972392 +0000
@@ -1,9 +1,9 @@
 #! /bin/sh
 # test-driver - basic testsuite driver script.
 
-scriptversion=2013-07-13.22; # UTC
+scriptversion=2012-06-27.10; # UTC
 
-# Copyright (C) 2011-2014 Free Software Foundation, Inc.
+# Copyright (C) 2011-2013 Free Software Foundation, Inc.
 #
 # This program is free software; you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
@@ -44,12 +44,13 @@
 Usage:
   test-driver --test-name=NAME --log-file=PATH --trs-file=PATH
               [--expect-failure={yes|no}] [--color-tests={yes|no}]
-              [--enable-hard-errors={yes|no}] [--]
-              TEST-SCRIPT [TEST-SCRIPT-ARGUMENTS]
+              [--enable-hard-errors={yes|no}] [--] TEST-SCRIPT
 The '--test-name', '--log-file' and '--trs-file' options are mandatory.
 END
 }
 
+# TODO: better error handling in option parsing (in particular, ensure
+# TODO: $log_file, $trs_file and $test_name are defined).
 test_name= # Used for reporting.
 log_file=  # Where to save the output of the test script.
 trs_file=  # Where to save the metadata of the test run.
@@ -68,23 +69,10 @@
   --enable-hard-errors) enable_hard_errors=$2; shift;;
   --) shift; break;;
   -*) usage_error "invalid option: '$1'";;
-   *) break;;
   esac
   shift
 done
 
-missing_opts=
-test x"$test_name" = x && missing_opts="$missing_opts --test-name"
-test x"$log_file"  = x && missing_opts="$missing_opts --log-file"
-test x"$trs_file"  = x && missing_opts="$missing_opts --trs-file"
-if test x"$missing_opts" != x; then
-  usage_error "the following mandatory options are missing:$missing_opts"
-fi
-
-if test $# -eq 0; then
-  usage_error "missing argument"
-fi
-
 if test $color_tests = yes; then
   # Keep this in sync with 'lib/am/check.am:$(am__tty_colors)'.
   red='[0;31m' # Red.
@@ -106,14 +94,11 @@
 # Test script is run here.
 "$@" >$log_file 2>&1
 estatus=$?
-
 if test $enable_hard_errors = no && test $estatus -eq 99; then
-  tweaked_estatus=1
-else
-  tweaked_estatus=$estatus
+  estatus=1
 fi
 
-case $tweaked_estatus:$expect_failure in
+case $estatus:$expect_failure in
   0:yes) col=$red res=XPASS recheck=yes gcopy=yes;;
   0:*)   col=$grn res=PASS  recheck=no  gcopy=no;;
   77:*)  col=$blu res=SKIP  recheck=no  gcopy=yes;;
@@ -122,12 +107,6 @@
   *:*)   col=$red res=FAIL  recheck=yes gcopy=yes;;
 esac
 
-# Report the test outcome and exit status in the logs, so that one can
-# know whether the test passed or failed simply by looking at the '.log'
-# file, without the need of also peaking into the corresponding '.trs'
-# file (automake bug#11814).
-echo "$res $test_name (exit status: $estatus)" >>$log_file
-
 # Report outcome to console.
 echo "${col}${res}${std}: $test_name"
 
diff -Naur fakechroot-2.18.orig/config.h.in fakechroot/config.h.in
--- fakechroot-2.18.orig/config.h.in	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/config.h.in	2016-11-04 19:09:26.031966235 +0000
@@ -84,6 +84,9 @@
    */
 #undef HAVE_ALLOCA_H
 
+/* Define to 1 if you have the `audit_log_acct_message' function. */
+#undef HAVE_AUDIT_LOG_ACCT_MESSAGE
+
 /* Define to 1 if you have the `bind' function. */
 #undef HAVE_BIND
 
diff -Naur fakechroot-2.18.orig/configure fakechroot/configure
--- fakechroot-2.18.orig/configure	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/configure	2017-02-24 23:26:55.210399294 +0000
@@ -1,6 +1,6 @@
-#! /bin/sh
+#! /bin/bash
 # Guess values for system-dependent variables and create Makefiles.
-# Generated by GNU Autoconf 2.69 for fakechroot 2.18.
+# Generated by GNU Autoconf 2.69 for fakechroot 2.18.1.
 #
 # Report bugs to <dexter@debian.org>.
 #
@@ -590,10 +590,10 @@
 # Identity of this package.
 PACKAGE_NAME='fakechroot'
 PACKAGE_TARNAME='fakechroot'
-PACKAGE_VERSION='2.18'
-PACKAGE_STRING='fakechroot 2.18'
+PACKAGE_VERSION='2.18.1'
+PACKAGE_STRING='fakechroot 2.18.1'
 PACKAGE_BUGREPORT='dexter@debian.org'
-PACKAGE_URL='http://fakechroot.alioth.debian.org/'
+PACKAGE_URL='https://github.com/dex4er/fakechroot'
 
 ac_unique_file="src/libfakechroot.c"
 # Factoring default headers for most tests.
@@ -752,7 +752,6 @@
 docdir
 oldincludedir
 includedir
-runstatedir
 localstatedir
 sharedstatedir
 sysconfdir
@@ -837,7 +836,6 @@
 sysconfdir='${prefix}/etc'
 sharedstatedir='${prefix}/com'
 localstatedir='${prefix}/var'
-runstatedir='${localstatedir}/run'
 includedir='${prefix}/include'
 oldincludedir='/usr/include'
 docdir='${datarootdir}/doc/${PACKAGE_TARNAME}'
@@ -1090,15 +1088,6 @@
   | -silent | --silent | --silen | --sile | --sil)
     silent=yes ;;
 
-  -runstatedir | --runstatedir | --runstatedi | --runstated \
-  | --runstate | --runstat | --runsta | --runst | --runs \
-  | --run | --ru | --r)
-    ac_prev=runstatedir ;;
-  -runstatedir=* | --runstatedir=* | --runstatedi=* | --runstated=* \
-  | --runstate=* | --runstat=* | --runsta=* | --runst=* | --runs=* \
-  | --run=* | --ru=* | --r=*)
-    runstatedir=$ac_optarg ;;
-
   -sbindir | --sbindir | --sbindi | --sbind | --sbin | --sbi | --sb)
     ac_prev=sbindir ;;
   -sbindir=* | --sbindir=* | --sbindi=* | --sbind=* | --sbin=* \
@@ -1236,7 +1225,7 @@
 for ac_var in	exec_prefix prefix bindir sbindir libexecdir datarootdir \
 		datadir sysconfdir sharedstatedir localstatedir includedir \
 		oldincludedir docdir infodir htmldir dvidir pdfdir psdir \
-		libdir localedir mandir runstatedir
+		libdir localedir mandir
 do
   eval ac_val=\$$ac_var
   # Remove trailing slashes.
@@ -1349,7 +1338,7 @@
   # Omit some internal or obsolete options to make the list less imposing.
   # This message is too long to be a string in the A/UX 3.1 sh.
   cat <<_ACEOF
-\`configure' configures fakechroot 2.18 to adapt to many kinds of systems.
+\`configure' configures fakechroot 2.18.1 to adapt to many kinds of systems.
 
 Usage: $0 [OPTION]... [VAR=VALUE]...
 
@@ -1389,7 +1378,6 @@
   --sysconfdir=DIR        read-only single-machine data [PREFIX/etc]
   --sharedstatedir=DIR    modifiable architecture-independent data [PREFIX/com]
   --localstatedir=DIR     modifiable single-machine data [PREFIX/var]
-  --runstatedir=DIR       modifiable per-process data [LOCALSTATEDIR/run]
   --libdir=DIR            object code libraries [EPREFIX/lib]
   --includedir=DIR        C header files [PREFIX/include]
   --oldincludedir=DIR     C header files for non-gcc [/usr/include]
@@ -1420,7 +1408,7 @@
 
 if test -n "$ac_init_help"; then
   case $ac_init_help in
-     short | recursive ) echo "Configuration of fakechroot 2.18:";;
+     short | recursive ) echo "Configuration of fakechroot 2.18.1:";;
    esac
   cat <<\_ACEOF
 
@@ -1474,7 +1462,7 @@
 it to find libraries and programs with nonstandard names/locations.
 
 Report bugs to <dexter@debian.org>.
-fakechroot home page: <http://fakechroot.alioth.debian.org/>.
+fakechroot home page: <https://github.com/dex4er/fakechroot>.
 _ACEOF
 ac_status=$?
 fi
@@ -1537,7 +1525,7 @@
 test -n "$ac_init_help" && exit $ac_status
 if $ac_init_version; then
   cat <<\_ACEOF
-fakechroot configure 2.18
+fakechroot configure 2.18.1
 generated by GNU Autoconf 2.69
 
 Copyright (C) 2012 Free Software Foundation, Inc.
@@ -2071,7 +2059,7 @@
 This file contains any messages produced by compilers while
 running configure, to aid debugging if configure makes a mistake.
 
-It was created by fakechroot $as_me 2.18, which was
+It was created by fakechroot $as_me 2.18.1, which was
 generated by GNU Autoconf 2.69.  Invocation command line was
 
   $ $0 $@
@@ -2454,7 +2442,7 @@
 ac_config_headers="$ac_config_headers config.h"
 
 
-am__api_version='1.15'
+am__api_version='1.13'
 
 # Find a good install program.  We prefer a C program (faster),
 # so one script is as good as another.  But avoid the broken or
@@ -2626,8 +2614,8 @@
 ac_script='s/[\\$]/&&/g;s/;s,x,x,$//'
 program_transform_name=`$as_echo "$program_transform_name" | sed "$ac_script"`
 
-# Expand $ac_aux_dir to an absolute path.
-am_aux_dir=`cd "$ac_aux_dir" && pwd`
+# expand $ac_aux_dir to an absolute path
+am_aux_dir=`cd $ac_aux_dir && pwd`
 
 if test x"${MISSING+set}" != xset; then
   case $am_aux_dir in
@@ -2646,7 +2634,7 @@
 $as_echo "$as_me: WARNING: 'missing' script is too old or missing" >&2;}
 fi
 
-if test x"${install_sh+set}" != xset; then
+if test x"${install_sh}" != xset; then
   case $am_aux_dir in
   *\ * | *\	*)
     install_sh="\${SHELL} '$am_aux_dir/install-sh'" ;;
@@ -2940,7 +2928,7 @@
 
 # Define the identity of the package.
  PACKAGE='fakechroot'
- VERSION='2.18'
+ VERSION='2.18.1'
 
 
 cat >>confdefs.h <<_ACEOF
@@ -2974,8 +2962,8 @@
 # <http://lists.gnu.org/archive/html/automake/2012-07/msg00014.html>
 mkdir_p='$(MKDIR_P)'
 
-# We need awk for the "check" target (and possibly the TAP driver).  The
-# system "awk" is bad on some platforms.
+# We need awk for the "check" target.  The system "awk" is bad on
+# some platforms.
 # Always define AMTAR for backward compatibility.  Yes, it's still used
 # in the wild :-(  We should find a proper way to deprecate it ...
 AMTAR='$${TAR-tar}'
@@ -2991,48 +2979,6 @@
 
 
 
-# POSIX will say in a future version that running "rm -f" with no argument
-# is OK; and we want to be able to make that assumption in our Makefile
-# recipes.  So use an aggressive probe to check that the usage we want is
-# actually supported "in the wild" to an acceptable degree.
-# See automake bug#10828.
-# To make any issue more visible, cause the running configure to be aborted
-# by default if the 'rm' program in use doesn't match our expectations; the
-# user can still override this though.
-if rm -f && rm -fr && rm -rf; then : OK; else
-  cat >&2 <<'END'
-Oops!
-
-Your 'rm' program seems unable to run without file operands specified
-on the command line, even when the '-f' option is present.  This is contrary
-to the behaviour of most rm programs out there, and not conforming with
-the upcoming POSIX standard: <http://austingroupbugs.net/view.php?id=542>
-
-Please tell bug-automake@gnu.org about your system, including the value
-of your $PATH and any error possibly output before this message.  This
-can help us improve future automake versions.
-
-END
-  if test x"$ACCEPT_INFERIOR_RM_PROGRAM" = x"yes"; then
-    echo 'Configuration will proceed anyway, since you have set the' >&2
-    echo 'ACCEPT_INFERIOR_RM_PROGRAM variable to "yes"' >&2
-    echo >&2
-  else
-    cat >&2 <<'END'
-Aborting the configuration process, to ensure you take notice of the issue.
-
-You can download and install GNU coreutils to get an 'rm' implementation
-that behaves properly: <http://www.gnu.org/software/coreutils/>.
-
-If you want to complete the configuration process using your problematic
-'rm' anyway, export the environment variable ACCEPT_INFERIOR_RM_PROGRAM
-to "yes", and re-run configure.
-
-END
-    as_fn_error $? "Your 'rm' program is bad, sorry." "$LINENO" 5
-  fi
-fi
-
 # Check whether --enable-silent-rules was given.
 if test "${enable_silent_rules+set}" = set; then :
   enableval=$enable_silent_rules;
@@ -4117,65 +4063,6 @@
 ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
 ac_compiler_gnu=$ac_cv_c_compiler_gnu
 
-ac_ext=c
-ac_cpp='$CPP $CPPFLAGS'
-ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
-ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
-ac_compiler_gnu=$ac_cv_c_compiler_gnu
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether $CC understands -c and -o together" >&5
-$as_echo_n "checking whether $CC understands -c and -o together... " >&6; }
-if ${am_cv_prog_cc_c_o+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-int
-main ()
-{
-
-  ;
-  return 0;
-}
-_ACEOF
-  # Make sure it works both with $CC and with simple cc.
-  # Following AC_PROG_CC_C_O, we do the test twice because some
-  # compilers refuse to overwrite an existing .o file with -o,
-  # though they will create one.
-  am_cv_prog_cc_c_o=yes
-  for am_i in 1 2; do
-    if { echo "$as_me:$LINENO: $CC -c conftest.$ac_ext -o conftest2.$ac_objext" >&5
-   ($CC -c conftest.$ac_ext -o conftest2.$ac_objext) >&5 2>&5
-   ac_status=$?
-   echo "$as_me:$LINENO: \$? = $ac_status" >&5
-   (exit $ac_status); } \
-         && test -f conftest2.$ac_objext; then
-      : OK
-    else
-      am_cv_prog_cc_c_o=no
-      break
-    fi
-  done
-  rm -f core conftest*
-  unset am_i
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $am_cv_prog_cc_c_o" >&5
-$as_echo "$am_cv_prog_cc_c_o" >&6; }
-if test "$am_cv_prog_cc_c_o" != yes; then
-   # Losing compiler, so override with the script.
-   # FIXME: It is wrong to rewrite CC.
-   # But if we don't then we get into trouble of one sort or another.
-   # A longer-term fix would be to have automake use am__CC in this case,
-   # and then we could set am__CC="\$(top_srcdir)/compile \$(CC)"
-   CC="$am_aux_dir/compile $CC"
-fi
-ac_ext=c
-ac_cpp='$CPP $CPPFLAGS'
-ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
-ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
-ac_compiler_gnu=$ac_cv_c_compiler_gnu
-
-
 depcc="$CC"   am_compiler_list=
 
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking dependency style of $depcc" >&5
@@ -5024,8 +4911,7 @@
     ;;
   *)
     lt_cv_sys_max_cmd_len=`(getconf ARG_MAX) 2> /dev/null`
-    if test -n "$lt_cv_sys_max_cmd_len" && \
-	test undefined != "$lt_cv_sys_max_cmd_len"; then
+    if test -n "$lt_cv_sys_max_cmd_len"; then
       lt_cv_sys_max_cmd_len=`expr $lt_cv_sys_max_cmd_len \/ 4`
       lt_cv_sys_max_cmd_len=`expr $lt_cv_sys_max_cmd_len \* 3`
     else
@@ -5426,6 +5312,10 @@
   fi
   ;;
 
+gnu*)
+  lt_cv_deplibs_check_method=pass_all
+  ;;
+
 haiku*)
   lt_cv_deplibs_check_method=pass_all
   ;;
@@ -5464,11 +5354,11 @@
   ;;
 
 # This must be glibc/ELF.
-linux* | k*bsd*-gnu | kopensolaris*-gnu | gnu*)
+linux* | k*bsd*-gnu | kopensolaris*-gnu)
   lt_cv_deplibs_check_method=pass_all
   ;;
 
-netbsd* | netbsdelf*-gnu)
+netbsd*)
   if echo __ELF__ | $CC -E - | $GREP __ELF__ > /dev/null; then
     lt_cv_deplibs_check_method='match_pattern /lib[^/]+(\.so\.[0-9]+\.[0-9]+|_pic\.a)$'
   else
@@ -6546,7 +6436,7 @@
   rm -rf conftest*
   ;;
 
-x86_64-*kfreebsd*-gnu|x86_64-*linux*|powerpc*-*linux*| \
+x86_64-*kfreebsd*-gnu|x86_64-*linux*|ppc*-*linux*|powerpc*-*linux*| \
 s390*-*linux*|s390*-*tpf*|sparc*-*linux*)
   # Find out which ABI we are using.
   echo 'int i;' > conftest.$ac_ext
@@ -6562,19 +6452,9 @@
 	    LD="${LD-ld} -m elf_i386_fbsd"
 	    ;;
 	  x86_64-*linux*)
-	    case `/usr/bin/file conftest.o` in
-	      *x86-64*)
-		LD="${LD-ld} -m elf32_x86_64"
-		;;
-	      *)
-		LD="${LD-ld} -m elf_i386"
-		;;
-	    esac
-	    ;;
-	  powerpc64le-*)
-	    LD="${LD-ld} -m elf32lppclinux"
+	    LD="${LD-ld} -m elf_i386"
 	    ;;
-	  powerpc64-*)
+	  ppc64-*linux*|powerpc64-*linux*)
 	    LD="${LD-ld} -m elf32ppclinux"
 	    ;;
 	  s390x-*linux*)
@@ -6593,10 +6473,7 @@
 	  x86_64-*linux*)
 	    LD="${LD-ld} -m elf_x86_64"
 	    ;;
-	  powerpcle-*)
-	    LD="${LD-ld} -m elf64lppc"
-	    ;;
-	  powerpc-*)
+	  ppc*-*linux*|powerpc*-*linux*)
 	    LD="${LD-ld} -m elf64ppc"
 	    ;;
 	  s390*-*linux*|s390*-*tpf*)
@@ -8404,7 +8281,7 @@
       lt_prog_compiler_static='-non_shared'
       ;;
 
-    linux* | k*bsd*-gnu | kopensolaris*-gnu | gnu*)
+    linux* | k*bsd*-gnu | kopensolaris*-gnu)
       case $cc_basename in
       # old Intel for x86_64 which still supported -KPIC.
       ecc*)
@@ -8882,9 +8759,6 @@
   openbsd*)
     with_gnu_ld=no
     ;;
-  linux* | k*bsd*-gnu | gnu*)
-    link_all_deplibs=no
-    ;;
   esac
 
   ld_shlibs=yes
@@ -9106,7 +8980,7 @@
       fi
       ;;
 
-    netbsd* | netbsdelf*-gnu)
+    netbsd*)
       if echo __ELF__ | $CC -E - | $GREP __ELF__ >/dev/null; then
 	archive_cmds='$LD -Bshareable $libobjs $deplibs $linker_flags -o $lib'
 	wlarc=
@@ -9283,7 +9157,6 @@
 	if test "$aix_use_runtimelinking" = yes; then
 	  shared_flag="$shared_flag "'${wl}-G'
 	fi
-	link_all_deplibs=no
       else
 	# not using gcc
 	if test "$host_cpu" = ia64; then
@@ -9737,7 +9610,7 @@
       link_all_deplibs=yes
       ;;
 
-    netbsd* | netbsdelf*-gnu)
+    netbsd*)
       if echo __ELF__ | $CC -E - | $GREP __ELF__ >/dev/null; then
 	archive_cmds='$LD -Bshareable -o $lib $libobjs $deplibs $linker_flags'  # a.out
       else
@@ -10574,6 +10447,17 @@
   esac
   ;;
 
+gnu*)
+  version_type=linux # correct to gnu/linux during the next big refactor
+  need_lib_prefix=no
+  need_version=no
+  library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}${major} ${libname}${shared_ext}'
+  soname_spec='${libname}${release}${shared_ext}$major'
+  shlibpath_var=LD_LIBRARY_PATH
+  shlibpath_overrides_runpath=no
+  hardcode_into_libs=yes
+  ;;
+
 haiku*)
   version_type=linux # correct to gnu/linux during the next big refactor
   need_lib_prefix=no
@@ -10690,7 +10574,7 @@
   ;;
 
 # This must be glibc/ELF.
-linux* | k*bsd*-gnu | kopensolaris*-gnu | gnu*)
+linux* | k*bsd*-gnu | kopensolaris*-gnu)
   version_type=linux # correct to gnu/linux during the next big refactor
   need_lib_prefix=no
   need_version=no
@@ -10739,10 +10623,14 @@
   # before this can be enabled.
   hardcode_into_libs=yes
 
+  # Add ABI-specific directories to the system library path.
+  sys_lib_dlsearch_path_spec="/lib64 /usr/lib64 /lib /usr/lib"
+
   # Append ld.so.conf contents to the search path
   if test -f /etc/ld.so.conf; then
     lt_ld_extra=`awk '/^include / { system(sprintf("cd /etc; cat %s 2>/dev/null", \$2)); skip = 1; } { if (!skip) print \$0; skip = 0; }' < /etc/ld.so.conf | $SED -e 's/#.*//;/^[	 ]*hwcap[	 ]/d;s/[:,	]/ /g;s/=[^=]*$//;s/=[^= ]* / /g;s/"//g;/^$/d' | tr '\n' ' '`
-    sys_lib_dlsearch_path_spec="/lib /usr/lib $lt_ld_extra"
+    sys_lib_dlsearch_path_spec="$sys_lib_dlsearch_path_spec $lt_ld_extra"
+
   fi
 
   # We used to test for /lib/ld.so.1 and disable shared libraries on
@@ -10754,18 +10642,6 @@
   dynamic_linker='GNU/Linux ld.so'
   ;;
 
-netbsdelf*-gnu)
-  version_type=linux
-  need_lib_prefix=no
-  need_version=no
-  library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major ${libname}${shared_ext}'
-  soname_spec='${libname}${release}${shared_ext}$major'
-  shlibpath_var=LD_LIBRARY_PATH
-  shlibpath_overrides_runpath=no
-  hardcode_into_libs=yes
-  dynamic_linker='NetBSD ld.elf_so'
-  ;;
-
 netbsd*)
   version_type=sunos
   need_lib_prefix=no
@@ -12371,65 +12247,6 @@
 ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
 ac_compiler_gnu=$ac_cv_c_compiler_gnu
 
-ac_ext=c
-ac_cpp='$CPP $CPPFLAGS'
-ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
-ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
-ac_compiler_gnu=$ac_cv_c_compiler_gnu
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether $CC understands -c and -o together" >&5
-$as_echo_n "checking whether $CC understands -c and -o together... " >&6; }
-if ${am_cv_prog_cc_c_o+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-int
-main ()
-{
-
-  ;
-  return 0;
-}
-_ACEOF
-  # Make sure it works both with $CC and with simple cc.
-  # Following AC_PROG_CC_C_O, we do the test twice because some
-  # compilers refuse to overwrite an existing .o file with -o,
-  # though they will create one.
-  am_cv_prog_cc_c_o=yes
-  for am_i in 1 2; do
-    if { echo "$as_me:$LINENO: $CC -c conftest.$ac_ext -o conftest2.$ac_objext" >&5
-   ($CC -c conftest.$ac_ext -o conftest2.$ac_objext) >&5 2>&5
-   ac_status=$?
-   echo "$as_me:$LINENO: \$? = $ac_status" >&5
-   (exit $ac_status); } \
-         && test -f conftest2.$ac_objext; then
-      : OK
-    else
-      am_cv_prog_cc_c_o=no
-      break
-    fi
-  done
-  rm -f core conftest*
-  unset am_i
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $am_cv_prog_cc_c_o" >&5
-$as_echo "$am_cv_prog_cc_c_o" >&6; }
-if test "$am_cv_prog_cc_c_o" != yes; then
-   # Losing compiler, so override with the script.
-   # FIXME: It is wrong to rewrite CC.
-   # But if we don't then we get into trouble of one sort or another.
-   # A longer-term fix would be to have automake use am__CC in this case,
-   # and then we could set am__CC="\$(top_srcdir)/compile \$(CC)"
-   CC="$am_aux_dir/compile $CC"
-fi
-ac_ext=c
-ac_cpp='$CPP $CPPFLAGS'
-ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
-ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
-ac_compiler_gnu=$ac_cv_c_compiler_gnu
-
-
 depcc="$CC"   am_compiler_list=
 
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking dependency style of $depcc" >&5
@@ -13844,7 +13661,7 @@
 
 
 # Checks for library functions.
-for ac_func in __chk_fail __fxstat64 __fxstatat __fxstatat64 __getcwd_chk __getwd_chk __lxstat __lxstat64 __open __open_2 __open64 __open64_2 __openat_2 __openat64_2 __opendir2 __realpath_chk __readlink_chk __readlinkat_chk __statfs __xmknod __xmknodat __xstat __xstat64 _xftw _xftw64 access acct bind bindtextdomain canonicalize_file_name chdir chmod chown chroot clearenv connect creat creat64 dl_iterate_phdr dladdr dlmopen dlopen eaccess euidaccess execl execle execlp execv execve execvp faccessat fchdir fchmodat fchownat fopen fopen64 freopen freopen64 fstat fstat64 fts_children fts_open fts_read ftw ftw64 futimesat get_current_dir_name getcwd getpeername getsockname getwd getxattr glob glob64 glob_pattern_p inotify_add_watch lchmod lchown lckpwdf lgetxattr link linkat listxattr llistxattr lremovexattr lsetxattr lstat lstat64 lutimes mempcpy mkdir mkdirat mkdtemp mkfifo mkfifoat mknod mknodat mkostemp mkostemp64 mkostemps mkostemps64 mkstemp mkstemp64 mkstemps mkstemps64 mktemp nftw nftw64 open open64 openat openat64 opendir pathconf popen posix_spawn posix_spawnp rawmemchr readlink readlinkat realpath remove removexattr rename renameat revoke rmdir scandir scandir64 setenv setxattr stat stat64 statfs statfs64 statvfs statvfs64 stpcpy strchrnul strlcpy symlink symlinkat system tempnam tmpnam truncate truncate64 unlink unlinkat unsetenv ulckpwdf utime utimensat utimes vfork
+for ac_func in __chk_fail __fxstat64 __fxstatat __fxstatat64 __getcwd_chk __getwd_chk __lxstat __lxstat64 __open __open_2 __open64 __open64_2 __openat_2 __openat64_2 __opendir2 __realpath_chk __readlink_chk __readlinkat_chk __statfs __xmknod __xmknodat __xstat __xstat64 _xftw _xftw64 access acct audit_log_acct_message bind bindtextdomain canonicalize_file_name chdir chmod chown chroot clearenv connect creat creat64 dl_iterate_phdr dladdr dlmopen dlopen eaccess euidaccess execl execle execlp execv execve execvp faccessat fchdir fchmodat fchownat fopen fopen64 freopen freopen64 fstat fstat64 fts_children fts_open fts_read ftw ftw64 futimesat get_current_dir_name getcwd getpeername getsockname getwd getxattr glob glob64 glob_pattern_p inotify_add_watch lchmod lchown lckpwdf lgetxattr link linkat listxattr llistxattr lremovexattr lsetxattr lstat lstat64 lutimes mempcpy mkdir mkdirat mkdtemp mkfifo mkfifoat mknod mknodat mkostemp mkostemp64 mkostemps mkostemps64 mkstemp mkstemp64 mkstemps mkstemps64 mktemp nftw nftw64 open open64 openat openat64 opendir pathconf popen posix_spawn posix_spawnp rawmemchr readlink readlinkat realpath remove removexattr rename renameat revoke rmdir scandir scandir64 setenv setxattr stat stat64 statfs statfs64 statvfs statvfs64 stpcpy strchrnul strlcpy symlink symlinkat system tempnam tmpnam truncate truncate64 unlink unlinkat unsetenv ulckpwdf utime utimensat utimes vfork
 do :
   as_ac_var=`$as_echo "ac_cv_func_$ac_func" | $as_tr_sh`
 ac_fn_c_check_func "$LINENO" "$ac_func" "$as_ac_var"
@@ -16358,7 +16175,7 @@
 # report actual input values of CONFIG_FILES etc. instead of their
 # values after options handling.
 ac_log="
-This file was extended by fakechroot $as_me 2.18, which was
+This file was extended by fakechroot $as_me 2.18.1, which was
 generated by GNU Autoconf 2.69.  Invocation command line was
 
   CONFIG_FILES    = $CONFIG_FILES
@@ -16419,13 +16236,13 @@
 $config_commands
 
 Report bugs to <dexter@debian.org>.
-fakechroot home page: <http://fakechroot.alioth.debian.org/>."
+fakechroot home page: <https://github.com/dex4er/fakechroot>."
 
 _ACEOF
 cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
 ac_cs_config="`$as_echo "$ac_configure_args" | sed 's/^ //; s/[\\""\`\$]/\\\\&/g'`"
 ac_cs_version="\\
-fakechroot config.status 2.18
+fakechroot config.status 2.18.1
 configured by $0, generated by GNU Autoconf 2.69,
   with options \\"\$ac_cs_config\\"
 
diff -Naur fakechroot-2.18.orig/configure.ac fakechroot/configure.ac
--- fakechroot-2.18.orig/configure.ac	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/configure.ac	2017-04-07 16:34:28.738827537 +0100
@@ -1,5 +1,5 @@
 AC_PREREQ(2.64)
-AC_INIT([fakechroot], [2.18], [dexter@debian.org], [fakechroot], [http://fakechroot.alioth.debian.org/])
+AC_INIT([fakechroot], [2.18.1], [dexter@debian.org], [fakechroot], [https://github.com/dex4er/fakechroot])
 
 AC_CONFIG_SRCDIR([src/libfakechroot.c])
 AC_CONFIG_AUX_DIR([build-aux])
@@ -51,7 +51,7 @@
 AC_PATH_PROG([LDCONFIG], [ldconfig], [/sbin/chroot], [/usr/sbin:/sbin:/usr/bin:/bin:/usr/local/bin:/usr/local/sbin:$PATH])
 AC_PATH_PROG([LDD], [ldd], [/usr/bin/ldd], [/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/bin:/usr/local/sbin:$PATH])
 AC_PATH_PROG([PERL], [perl], [/usr/bin/perl], [/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/bin:/usr/local/sbin:$PATH])
-AC_PATH_PROG([SHELL], [bash ksh sh], [/bin/sh], [/usr/sbin:/sbin:/usr/bin:/bin:/usr/local/bin:/usr/local/sbin:$PATH])
+AC_PATH_PROG([SHELL], [bash ksh sh], [/bin/bash], [/bin:/usr/sbin:/sbin:/usr/bin:/usr/local/bin:/usr/local/sbin:$PATH])
 
 # Checks for compilator features
 ACX_CHECK_C_ALIGNOF
@@ -151,6 +151,7 @@
     _xftw64
     access
     acct
+    audit_log_acct_message
     bind
     bindtextdomain
     canonicalize_file_name
diff -Naur fakechroot-2.18.orig/COPYING fakechroot/COPYING
--- fakechroot-2.18.orig/COPYING	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/COPYING	2016-10-28 16:46:25.000000000 +0100
@@ -1,14 +1,25 @@
+Copyright (c) 2003-2015 Piotr Roszatycki <dexter@debian.org>
+
 fakechroot is distributed under the GNU Lesser General Public License (LGPL
 2.1 or greater).
 
 Additional copyrights:
 
+src/libfakechroot.c file
+Copyright (c) 2003-2015 Piotr Roszatycki <dexter@debian.org>
+Copyright (c) 2007 Mark Eichin <eichin@metacarta.com>
+Copyright (c) 2006, 2007 Alexander Shishkin <virtuoso@slind.org>
+Copyright (c) 2006, 2007 Lionel Tricon <lionel.tricon@free.fr>
+
 audit_log_acct_message function taken from Debian bug #745082.
 Copyright (c) 2015 JH Chatenet <jhcha54008@free.fr>
 
 dedotdot function taken from mini_httpd - small HTTP server
 Copyright (C) 1999,2000 by Jef Poskanzer <jef@mail.acme.com>.
 
+dl_iterate_phdr, dladdr and dlopen functions
+Copyright (c) 2014 Robin McCorkell <rmccorkell@karoshi.org.uk>
+
 execl function taken from GNU C Library.
 Copyright (C) 1991,92,94,97,98,99,2002,2005 Free Software Foundation, Inc.
 
@@ -48,6 +59,10 @@
 popen function taken from OpenBSD.
 Copyright (c) 1988, 1993 The Regents of the University of California.
 
+posix_spawnp function taken from the execvp function in the GNU C Library.
+Copyright (C) 1991,92, 1995-99, 2002, 2004, 2005, 2007, 2009
+Free Software Foundation, Inc.
+
 rawmemchr function taken from uClibc
 Copyright (C) 2002 Manuel Novoa III
 Copyright (C) 2000-2005 Erik Andersen <andersen@uclibc.org>
diff -Naur fakechroot-2.18.orig/m4/libtool.m4 fakechroot/m4/libtool.m4
--- fakechroot-2.18.orig/m4/libtool.m4	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/m4/libtool.m4	2016-11-04 19:09:21.115943200 +0000
@@ -1312,7 +1312,7 @@
   rm -rf conftest*
   ;;
 
-x86_64-*kfreebsd*-gnu|x86_64-*linux*|powerpc*-*linux*| \
+x86_64-*kfreebsd*-gnu|x86_64-*linux*|ppc*-*linux*|powerpc*-*linux*| \
 s390*-*linux*|s390*-*tpf*|sparc*-*linux*)
   # Find out which ABI we are using.
   echo 'int i;' > conftest.$ac_ext
@@ -1324,19 +1324,9 @@
 	    LD="${LD-ld} -m elf_i386_fbsd"
 	    ;;
 	  x86_64-*linux*)
-	    case `/usr/bin/file conftest.o` in
-	      *x86-64*)
-		LD="${LD-ld} -m elf32_x86_64"
-		;;
-	      *)
-		LD="${LD-ld} -m elf_i386"
-		;;
-	    esac
-	    ;;
-	  powerpc64le-*)
-	    LD="${LD-ld} -m elf32lppclinux"
+	    LD="${LD-ld} -m elf_i386"
 	    ;;
-	  powerpc64-*)
+	  ppc64-*linux*|powerpc64-*linux*)
 	    LD="${LD-ld} -m elf32ppclinux"
 	    ;;
 	  s390x-*linux*)
@@ -1355,10 +1345,7 @@
 	  x86_64-*linux*)
 	    LD="${LD-ld} -m elf_x86_64"
 	    ;;
-	  powerpcle-*)
-	    LD="${LD-ld} -m elf64lppc"
-	    ;;
-	  powerpc-*)
+	  ppc*-*linux*|powerpc*-*linux*)
 	    LD="${LD-ld} -m elf64ppc"
 	    ;;
 	  s390*-*linux*|s390*-*tpf*)
@@ -1701,8 +1688,7 @@
     ;;
   *)
     lt_cv_sys_max_cmd_len=`(getconf ARG_MAX) 2> /dev/null`
-    if test -n "$lt_cv_sys_max_cmd_len" && \
-	test undefined != "$lt_cv_sys_max_cmd_len"; then
+    if test -n "$lt_cv_sys_max_cmd_len"; then
       lt_cv_sys_max_cmd_len=`expr $lt_cv_sys_max_cmd_len \/ 4`
       lt_cv_sys_max_cmd_len=`expr $lt_cv_sys_max_cmd_len \* 3`
     else
@@ -2526,6 +2512,17 @@
   esac
   ;;
 
+gnu*)
+  version_type=linux # correct to gnu/linux during the next big refactor
+  need_lib_prefix=no
+  need_version=no
+  library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}${major} ${libname}${shared_ext}'
+  soname_spec='${libname}${release}${shared_ext}$major'
+  shlibpath_var=LD_LIBRARY_PATH
+  shlibpath_overrides_runpath=no
+  hardcode_into_libs=yes
+  ;;
+
 haiku*)
   version_type=linux # correct to gnu/linux during the next big refactor
   need_lib_prefix=no
@@ -2642,7 +2639,7 @@
   ;;
 
 # This must be glibc/ELF.
-linux* | k*bsd*-gnu | kopensolaris*-gnu | gnu*)
+linux* | k*bsd*-gnu | kopensolaris*-gnu)
   version_type=linux # correct to gnu/linux during the next big refactor
   need_lib_prefix=no
   need_version=no
@@ -2672,10 +2669,14 @@
   # before this can be enabled.
   hardcode_into_libs=yes
 
+  # Add ABI-specific directories to the system library path.
+  sys_lib_dlsearch_path_spec="/lib64 /usr/lib64 /lib /usr/lib"
+
   # Append ld.so.conf contents to the search path
   if test -f /etc/ld.so.conf; then
     lt_ld_extra=`awk '/^include / { system(sprintf("cd /etc; cat %s 2>/dev/null", \[$]2)); skip = 1; } { if (!skip) print \[$]0; skip = 0; }' < /etc/ld.so.conf | $SED -e 's/#.*//;/^[	 ]*hwcap[	 ]/d;s/[:,	]/ /g;s/=[^=]*$//;s/=[^= ]* / /g;s/"//g;/^$/d' | tr '\n' ' '`
-    sys_lib_dlsearch_path_spec="/lib /usr/lib $lt_ld_extra"
+    sys_lib_dlsearch_path_spec="$sys_lib_dlsearch_path_spec $lt_ld_extra"
+
   fi
 
   # We used to test for /lib/ld.so.1 and disable shared libraries on
@@ -2687,18 +2688,6 @@
   dynamic_linker='GNU/Linux ld.so'
   ;;
 
-netbsdelf*-gnu)
-  version_type=linux
-  need_lib_prefix=no
-  need_version=no
-  library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major ${libname}${shared_ext}'
-  soname_spec='${libname}${release}${shared_ext}$major'
-  shlibpath_var=LD_LIBRARY_PATH
-  shlibpath_overrides_runpath=no
-  hardcode_into_libs=yes
-  dynamic_linker='NetBSD ld.elf_so'
-  ;;
-
 netbsd*)
   version_type=sunos
   need_lib_prefix=no
@@ -3258,6 +3247,10 @@
   fi
   ;;
 
+gnu*)
+  lt_cv_deplibs_check_method=pass_all
+  ;;
+
 haiku*)
   lt_cv_deplibs_check_method=pass_all
   ;;
@@ -3296,11 +3289,11 @@
   ;;
 
 # This must be glibc/ELF.
-linux* | k*bsd*-gnu | kopensolaris*-gnu | gnu*)
+linux* | k*bsd*-gnu | kopensolaris*-gnu)
   lt_cv_deplibs_check_method=pass_all
   ;;
 
-netbsd* | netbsdelf*-gnu)
+netbsd*)
   if echo __ELF__ | $CC -E - | $GREP __ELF__ > /dev/null; then
     lt_cv_deplibs_check_method='match_pattern /lib[[^/]]+(\.so\.[[0-9]]+\.[[0-9]]+|_pic\.a)$'
   else
@@ -4048,7 +4041,7 @@
 	    ;;
 	esac
 	;;
-      linux* | k*bsd*-gnu | kopensolaris*-gnu | gnu*)
+      linux* | k*bsd*-gnu | kopensolaris*-gnu)
 	case $cc_basename in
 	  KCC*)
 	    # KAI C++ Compiler
@@ -4112,7 +4105,7 @@
 	    ;;
 	esac
 	;;
-      netbsd* | netbsdelf*-gnu)
+      netbsd*)
 	;;
       *qnx* | *nto*)
         # QNX uses GNU C++, but need to define -shared option too, otherwise
@@ -4347,7 +4340,7 @@
       _LT_TAGVAR(lt_prog_compiler_static, $1)='-non_shared'
       ;;
 
-    linux* | k*bsd*-gnu | kopensolaris*-gnu | gnu*)
+    linux* | k*bsd*-gnu | kopensolaris*-gnu)
       case $cc_basename in
       # old Intel for x86_64 which still supported -KPIC.
       ecc*)
@@ -4589,9 +4582,6 @@
       ;;
     esac
     ;;
-  linux* | k*bsd*-gnu | gnu*)
-    _LT_TAGVAR(link_all_deplibs, $1)=no
-    ;;
   *)
     _LT_TAGVAR(export_symbols_cmds, $1)='$NM $libobjs $convenience | $global_symbol_pipe | $SED '\''s/.* //'\'' | sort | uniq > $export_symbols'
     ;;
@@ -4654,9 +4644,6 @@
   openbsd*)
     with_gnu_ld=no
     ;;
-  linux* | k*bsd*-gnu | gnu*)
-    _LT_TAGVAR(link_all_deplibs, $1)=no
-    ;;
   esac
 
   _LT_TAGVAR(ld_shlibs, $1)=yes
@@ -4878,7 +4865,7 @@
       fi
       ;;
 
-    netbsd* | netbsdelf*-gnu)
+    netbsd*)
       if echo __ELF__ | $CC -E - | $GREP __ELF__ >/dev/null; then
 	_LT_TAGVAR(archive_cmds, $1)='$LD -Bshareable $libobjs $deplibs $linker_flags -o $lib'
 	wlarc=
@@ -5055,7 +5042,6 @@
 	if test "$aix_use_runtimelinking" = yes; then
 	  shared_flag="$shared_flag "'${wl}-G'
 	fi
-	_LT_TAGVAR(link_all_deplibs, $1)=no
       else
 	# not using gcc
 	if test "$host_cpu" = ia64; then
@@ -5360,7 +5346,7 @@
       _LT_TAGVAR(link_all_deplibs, $1)=yes
       ;;
 
-    netbsd* | netbsdelf*-gnu)
+    netbsd*)
       if echo __ELF__ | $CC -E - | $GREP __ELF__ >/dev/null; then
 	_LT_TAGVAR(archive_cmds, $1)='$LD -Bshareable -o $lib $libobjs $deplibs $linker_flags'  # a.out
       else
@@ -6240,6 +6226,9 @@
         _LT_TAGVAR(ld_shlibs, $1)=yes
         ;;
 
+      gnu*)
+        ;;
+
       haiku*)
         _LT_TAGVAR(archive_cmds, $1)='$CC -shared $libobjs $deplibs $compiler_flags ${wl}-soname $wl$soname -o $lib'
         _LT_TAGVAR(link_all_deplibs, $1)=yes
@@ -6401,7 +6390,7 @@
         _LT_TAGVAR(inherit_rpath, $1)=yes
         ;;
 
-      linux* | k*bsd*-gnu | kopensolaris*-gnu | gnu*)
+      linux* | k*bsd*-gnu | kopensolaris*-gnu)
         case $cc_basename in
           KCC*)
 	    # Kuck and Associates, Inc. (KAI) C++ Compiler
diff -Naur fakechroot-2.18.orig/Makefile.in fakechroot/Makefile.in
--- fakechroot-2.18.orig/Makefile.in	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/Makefile.in	2016-11-04 19:09:27.167971558 +0000
@@ -1,7 +1,7 @@
-# Makefile.in generated by automake 1.15 from Makefile.am.
+# Makefile.in generated by automake 1.13.4 from Makefile.am.
 # @configure_input@
 
-# Copyright (C) 1994-2014 Free Software Foundation, Inc.
+# Copyright (C) 1994-2013 Free Software Foundation, Inc.
 
 # This Makefile.in is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -14,17 +14,7 @@
 
 @SET_MAKE@
 VPATH = @srcdir@
-am__is_gnu_make = { \
-  if test -z '$(MAKELEVEL)'; then \
-    false; \
-  elif test -n '$(MAKE_HOST)'; then \
-    true; \
-  elif test -n '$(MAKE_VERSION)' && test -n '$(CURDIR)'; then \
-    true; \
-  else \
-    false; \
-  fi; \
-}
+am__is_gnu_make = test -n '$(MAKEFILE_LIST)' && test -n '$(MAKELEVEL)'
 am__make_running_with_option = \
   case $${target_option-} in \
       ?) ;; \
@@ -88,6 +78,15 @@
 build_triplet = @build@
 host_triplet = @host@
 subdir = .
+DIST_COMMON = $(srcdir)/Makefile.in $(srcdir)/Makefile.am \
+	$(top_srcdir)/configure $(am__configure_deps) \
+	$(srcdir)/config.h.in COPYING THANKS build-aux/config.guess \
+	build-aux/config.sub build-aux/install-sh build-aux/missing \
+	build-aux/ltmain.sh $(top_srcdir)/build-aux/config.guess \
+	$(top_srcdir)/build-aux/config.sub \
+	$(top_srcdir)/build-aux/install-sh \
+	$(top_srcdir)/build-aux/ltmain.sh \
+	$(top_srcdir)/build-aux/missing
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
 am__aclocal_m4_deps = $(top_srcdir)/m4/check_c_alignof.m4 \
 	$(top_srcdir)/m4/check_c_attribute.m4 \
@@ -104,8 +103,6 @@
 	$(top_srcdir)/m4/prog_prove_opt.m4 $(top_srcdir)/configure.ac
 am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
 	$(ACLOCAL_M4)
-DIST_COMMON = $(srcdir)/Makefile.am $(top_srcdir)/configure \
-	$(am__configure_deps) $(am__DIST_COMMON)
 am__CONFIG_DISTCLEAN_FILES = config.status config.cache config.log \
  configure.lineno config.status.lineno
 mkinstalldirs = $(install_sh) -d
@@ -169,15 +166,6 @@
 CTAGS = ctags
 CSCOPE = cscope
 DIST_SUBDIRS = $(SUBDIRS)
-am__DIST_COMMON = $(srcdir)/Makefile.in $(srcdir)/config.h.in \
-	$(top_srcdir)/build-aux/compile \
-	$(top_srcdir)/build-aux/config.guess \
-	$(top_srcdir)/build-aux/config.sub \
-	$(top_srcdir)/build-aux/install-sh \
-	$(top_srcdir)/build-aux/ltmain.sh \
-	$(top_srcdir)/build-aux/missing COPYING THANKS \
-	build-aux/compile build-aux/config.guess build-aux/config.sub \
-	build-aux/install-sh build-aux/ltmain.sh build-aux/missing
 DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
 distdir = $(PACKAGE)-$(VERSION)
 top_distdir = $(distdir)
@@ -347,7 +335,6 @@
 prefix = @prefix@
 program_transform_name = @program_transform_name@
 psdir = @psdir@
-runstatedir = @runstatedir@
 sbindir = @sbindir@
 sharedstatedir = @sharedstatedir@
 srcdir = @srcdir@
@@ -379,6 +366,7 @@
 	echo ' cd $(top_srcdir) && $(AUTOMAKE) --foreign Makefile'; \
 	$(am__cd) $(top_srcdir) && \
 	  $(AUTOMAKE) --foreign Makefile
+.PRECIOUS: Makefile
 Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
 	@case '$?' in \
 	  *config.status*) \
@@ -399,8 +387,8 @@
 $(am__aclocal_m4_deps):
 
 config.h: stamp-h1
-	@test -f $@ || rm -f stamp-h1
-	@test -f $@ || $(MAKE) $(AM_MAKEFLAGS) stamp-h1
+	@if test ! -f $@; then rm -f stamp-h1; else :; fi
+	@if test ! -f $@; then $(MAKE) $(AM_MAKEFLAGS) stamp-h1; else :; fi
 
 stamp-h1: $(srcdir)/config.h.in $(top_builddir)/config.status
 	@rm -f stamp-h1
@@ -609,16 +597,10 @@
 	$(am__post_remove_distdir)
 
 dist-tarZ: distdir
-	@echo WARNING: "Support for distribution archives compressed with" \
-		       "legacy program 'compress' is deprecated." >&2
-	@echo WARNING: "It will be removed altogether in Automake 2.0" >&2
 	tardir=$(distdir) && $(am__tar) | compress -c >$(distdir).tar.Z
 	$(am__post_remove_distdir)
 
 dist-shar: distdir
-	@echo WARNING: "Support for shar distribution archives is" \
-	               "deprecated." >&2
-	@echo WARNING: "It will be removed altogether in Automake 2.0" >&2
 	shar $(distdir) | GZIP=$(GZIP_ENV) gzip -c >$(distdir).shar.gz
 	$(am__post_remove_distdir)
 
@@ -653,17 +635,16 @@
 	esac
 	chmod -R a-w $(distdir)
 	chmod u+w $(distdir)
-	mkdir $(distdir)/_build $(distdir)/_build/sub $(distdir)/_inst
+	mkdir $(distdir)/_build $(distdir)/_inst
 	chmod a-w $(distdir)
 	test -d $(distdir)/_build || exit 0; \
 	dc_install_base=`$(am__cd) $(distdir)/_inst && pwd | sed -e 's,^[^:\\/]:[\\/],/,'` \
 	  && dc_destdir="$${TMPDIR-/tmp}/am-dc-$$$$/" \
 	  && am__cwd=`pwd` \
-	  && $(am__cd) $(distdir)/_build/sub \
-	  && ../../configure \
+	  && $(am__cd) $(distdir)/_build \
+	  && ../configure --srcdir=.. --prefix="$$dc_install_base" \
 	    $(AM_DISTCHECK_CONFIGURE_FLAGS) \
 	    $(DISTCHECK_CONFIGURE_FLAGS) \
-	    --srcdir=../.. --prefix="$$dc_install_base" \
 	  && $(MAKE) $(AM_MAKEFLAGS) \
 	  && $(MAKE) $(AM_MAKEFLAGS) dvi \
 	  && $(MAKE) $(AM_MAKEFLAGS) check \
@@ -840,8 +821,6 @@
 	mostlyclean-libtool pdf pdf-am ps ps-am tags tags-am uninstall \
 	uninstall-am
 
-.PRECIOUS: Makefile
-
 
 prove: all
 	cd test && $(MAKE) $(AM_MAKEFLAGS) prove
diff -Naur fakechroot-2.18.orig/man/fakechroot.1 fakechroot/man/fakechroot.1
--- fakechroot-2.18.orig/man/fakechroot.1	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/man/fakechroot.1	2016-10-30 22:38:17.080020265 +0000
@@ -1,4 +1,4 @@
-.\" Automatically generated by Pod::Man 2.28 (Pod::Simple 3.28)
+.\" Automatically generated by Pod::Man 2.27 (Pod::Simple 3.28)
 .\"
 .\" Standard preamble:
 .\" ========================================================================
diff -Naur fakechroot-2.18.orig/man/Makefile.in fakechroot/man/Makefile.in
--- fakechroot-2.18.orig/man/Makefile.in	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/man/Makefile.in	2016-11-04 19:09:27.200971713 +0000
@@ -1,7 +1,7 @@
-# Makefile.in generated by automake 1.15 from Makefile.am.
+# Makefile.in generated by automake 1.13.4 from Makefile.am.
 # @configure_input@
 
-# Copyright (C) 1994-2014 Free Software Foundation, Inc.
+# Copyright (C) 1994-2013 Free Software Foundation, Inc.
 
 # This Makefile.in is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -14,17 +14,7 @@
 
 @SET_MAKE@
 VPATH = @srcdir@
-am__is_gnu_make = { \
-  if test -z '$(MAKELEVEL)'; then \
-    false; \
-  elif test -n '$(MAKE_HOST)'; then \
-    true; \
-  elif test -n '$(MAKE_VERSION)' && test -n '$(CURDIR)'; then \
-    true; \
-  else \
-    false; \
-  fi; \
-}
+am__is_gnu_make = test -n '$(MAKEFILE_LIST)' && test -n '$(MAKELEVEL)'
 am__make_running_with_option = \
   case $${target_option-} in \
       ?) ;; \
@@ -88,6 +78,7 @@
 build_triplet = @build@
 host_triplet = @host@
 subdir = man
+DIST_COMMON = $(srcdir)/Makefile.in $(srcdir)/Makefile.am
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
 am__aclocal_m4_deps = $(top_srcdir)/m4/check_c_alignof.m4 \
 	$(top_srcdir)/m4/check_c_attribute.m4 \
@@ -104,7 +95,6 @@
 	$(top_srcdir)/m4/prog_prove_opt.m4 $(top_srcdir)/configure.ac
 am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
 	$(ACLOCAL_M4)
-DIST_COMMON = $(srcdir)/Makefile.am $(am__DIST_COMMON)
 mkinstalldirs = $(install_sh) -d
 CONFIG_HEADER = $(top_builddir)/config.h
 CONFIG_CLEAN_FILES =
@@ -160,7 +150,6 @@
 NROFF = nroff
 MANS = $(man_MANS)
 am__tagged_files = $(HEADERS) $(SOURCES) $(TAGS_FILES) $(LISP)
-am__DIST_COMMON = $(srcdir)/Makefile.in
 DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
 ACLOCAL = @ACLOCAL@
 ALLOCA = @ALLOCA@
@@ -289,7 +278,6 @@
 prefix = @prefix@
 program_transform_name = @program_transform_name@
 psdir = @psdir@
-runstatedir = @runstatedir@
 sbindir = @sbindir@
 sharedstatedir = @sharedstatedir@
 srcdir = @srcdir@
@@ -315,6 +303,7 @@
 	echo ' cd $(top_srcdir) && $(AUTOMAKE) --foreign man/Makefile'; \
 	$(am__cd) $(top_srcdir) && \
 	  $(AUTOMAKE) --foreign man/Makefile
+.PRECIOUS: Makefile
 Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
 	@case '$?' in \
 	  *config.status*) \
@@ -538,8 +527,6 @@
 	ps ps-am tags-am uninstall uninstall-am uninstall-man \
 	uninstall-man1
 
-.PRECIOUS: Makefile
-
 
 fakechroot.1: fakechroot.pod
 	eval $(POD2MAN) `head -n1 $(srcdir)/fakechroot.pod | sed 's/^# pod2man //'` $(srcdir)/fakechroot.pod $@
diff -Naur fakechroot-2.18.orig/scripts/Makefile.in fakechroot/scripts/Makefile.in
--- fakechroot-2.18.orig/scripts/Makefile.in	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/scripts/Makefile.in	2016-11-04 19:09:27.235971877 +0000
@@ -1,7 +1,7 @@
-# Makefile.in generated by automake 1.15 from Makefile.am.
+# Makefile.in generated by automake 1.13.4 from Makefile.am.
 # @configure_input@
 
-# Copyright (C) 1994-2014 Free Software Foundation, Inc.
+# Copyright (C) 1994-2013 Free Software Foundation, Inc.
 
 # This Makefile.in is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -16,17 +16,7 @@
 
 
 VPATH = @srcdir@
-am__is_gnu_make = { \
-  if test -z '$(MAKELEVEL)'; then \
-    false; \
-  elif test -n '$(MAKE_HOST)'; then \
-    true; \
-  elif test -n '$(MAKE_VERSION)' && test -n '$(CURDIR)'; then \
-    true; \
-  else \
-    false; \
-  fi; \
-}
+am__is_gnu_make = test -n '$(MAKEFILE_LIST)' && test -n '$(MAKELEVEL)'
 am__make_running_with_option = \
   case $${target_option-} in \
       ?) ;; \
@@ -90,6 +80,7 @@
 build_triplet = @build@
 host_triplet = @host@
 subdir = scripts
+DIST_COMMON = $(srcdir)/Makefile.in $(srcdir)/Makefile.am
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
 am__aclocal_m4_deps = $(top_srcdir)/m4/check_c_alignof.m4 \
 	$(top_srcdir)/m4/check_c_attribute.m4 \
@@ -106,7 +97,6 @@
 	$(top_srcdir)/m4/prog_prove_opt.m4 $(top_srcdir)/configure.ac
 am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
 	$(ACLOCAL_M4)
-DIST_COMMON = $(srcdir)/Makefile.am $(am__DIST_COMMON)
 mkinstalldirs = $(install_sh) -d
 CONFIG_HEADER = $(top_builddir)/config.h
 CONFIG_CLEAN_FILES =
@@ -162,7 +152,6 @@
   esac
 DATA = $(sysconf_DATA)
 am__tagged_files = $(HEADERS) $(SOURCES) $(TAGS_FILES) $(LISP)
-am__DIST_COMMON = $(srcdir)/Makefile.in
 DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
 ACLOCAL = @ACLOCAL@
 ALLOCA = @ALLOCA@
@@ -291,7 +280,6 @@
 prefix = @prefix@
 program_transform_name = @program_transform_name@
 psdir = @psdir@
-runstatedir = @runstatedir@
 sbindir = @sbindir@
 sharedstatedir = @sharedstatedir@
 srcdir = @srcdir@
@@ -338,6 +326,7 @@
 	echo ' cd $(top_srcdir) && $(AUTOMAKE) --foreign scripts/Makefile'; \
 	$(am__cd) $(top_srcdir) && \
 	  $(AUTOMAKE) --foreign scripts/Makefile
+.PRECIOUS: Makefile
 Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
 	@case '$?' in \
 	  *config.status*) \
@@ -611,8 +600,6 @@
 	tags-am uninstall uninstall-am uninstall-binSCRIPTS \
 	uninstall-sbinSCRIPTS uninstall-sysconfDATA
 
-.PRECIOUS: Makefile
-
 
 chroot.env: $(srcdir)/chroot.env.sh
 	$(do_subst) < $(srcdir)/chroot.env.sh > $@
diff -Naur fakechroot-2.18.orig/src/access.c fakechroot/src/access.c
--- fakechroot-2.18.orig/src/access.c	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/src/access.c	2017-04-06 19:21:54.710173516 +0100
@@ -17,15 +17,62 @@
     Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307  USA
 */
 
-
 #include <config.h>
 
+#include <stdio.h>
+
 #include "libfakechroot.h"
 
+int openmpi_ini_done = 1;
+int access_first_call = 1;
+
+/*
+ * alternate implementation for access() 
+ * during openmpi initialization we get called by openmpi at
+ * a point where openmpi redefined functions are not yet
+ * available (e.g. malloc) also calling dlsym will not work
+ */
+int alt_access(const char * pathname, int mode)
+{
+    char *existing_files = getenv("FAKECHROOT_ACCESS_FILESOK");
+    if (existing_files) {
+        char *match;
+        int p_len = strlen(pathname);
+        if ((match = strstr(existing_files, pathname)) &&
+            (*(match + p_len) == '\0' || *(match + p_len) == ':') &&
+            (match == existing_files || *(match - 1) == ':')) {
+                debug("alt_access: FOUND %s\n", pathname);
+                return 0; /* if pathname in env var then return found */
+        }
+    }
+    debug("alt_access: NOT FOUND %s\n", pathname);
+    return -1;
+}
 
 wrapper(access, int, (const char * pathname, int mode))
 {
     debug("access(\"%s\", %d)", pathname, mode);
+
+/*
+    printf("access: %s %d\n", pathname, (long) malloc);
+*/
+    if (access_first_call) {
+        access_first_call = 0;
+        if (strcmp(pathname, "/sys/class/infiniband") == 0 && !mode) {
+            openmpi_ini_done = 0;
+            return alt_access(pathname, mode);
+        }
+    }
+
+    if (! openmpi_ini_done) {
+        if (strncmp(pathname, "/dev/", 5) == 0) {
+            return alt_access(pathname, mode);
+        }
+        else {
+            openmpi_ini_done = 1;
+        }
+    }
+
     expand_chroot_path(pathname);
     return nextcall(access)(pathname, mode);
 }
diff -Naur fakechroot-2.18.orig/src/close.c fakechroot/src/close.c
--- fakechroot-2.18.orig/src/close.c	1970-01-01 01:00:00.000000000 +0100
+++ fakechroot/src/close.c	2017-04-02 01:47:39.439142879 +0100
@@ -0,0 +1,41 @@
+/*
+    libfakechroot -- fake chroot environment
+    Copyright (c) 2010, 2013 Piotr Roszatycki <dexter@debian.org>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Lesser General Public
+    License as published by the Free Software Foundation; either
+    version 2.1 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Lesser General Public License for more details.
+
+    You should have received a copy of the GNU Lesser General Public
+    License along with this library; if not, write to the Free Software
+    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307  USA
+*/
+
+/* udocker */
+
+#include <config.h>
+
+#include <unistd.h>
+#include "libfakechroot.h"
+
+wrapper_alias(close, int, (int fd))
+{
+    int close_status;
+    char *filename = (char *) 0; 
+
+    debug("close(%d)", fd); 
+    close_status = nextcall(close)(fd);
+
+    if ((close_status == 0) && fakechroot_iswlib(fd, &filename)) {
+        fakechroot_upatch_elf(filename);
+        free(filename);
+    }
+
+    return close_status;
+}
diff -Naur fakechroot-2.18.orig/src/dlopen.c fakechroot/src/dlopen.c
--- fakechroot-2.18.orig/src/dlopen.c	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/src/dlopen.c	2016-11-02 16:24:57.557073025 +0000
@@ -32,5 +32,6 @@
         expand_chroot_path(filename);
         debug("dlopen(\"%s\", %d)", filename, flag);
     }
+
     return nextcall(dlopen)(filename, flag);
 }
diff -Naur fakechroot-2.18.orig/src/execve.c fakechroot/src/execve.c
--- fakechroot-2.18.orig/src/execve.c	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/src/execve.c	2017-03-14 01:35:16.828483921 +0000
@@ -16,7 +16,7 @@
     License along with this library; if not, write to the Free Software
     Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307  USA
 */
-
+#include <stdio.h>
 
 #include <config.h>
 
@@ -28,13 +28,13 @@
 #endif
 #include <stdlib.h>
 #include <fcntl.h>
+#include <alloca.h>
 #include "strchrnul.h"
 #include "libfakechroot.h"
 #include "open.h"
 #include "setenv.h"
 #include "readlink.h"
 
-
 wrapper(execve, int, (const char * filename, char * const argv [], char * const envp []))
 {
     int status;
@@ -57,8 +57,12 @@
     size_t sizeenvp;
     char c;
 
-    char *elfloader = getenv("FAKECHROOT_ELFLOADER");
-    char *elfloader_opt_argv0 = getenv("FAKECHROOT_ELFLOADER_OPT_ARGV0");
+    char *fakechroot_base = fakechroot_preserve_getenv("FAKECHROOT_BASE");
+    char *elfloader = fakechroot_preserve_getenv("FAKECHROOT_ELFLOADER");
+    char *elfloader_opt_argv0 = fakechroot_preserve_getenv("FAKECHROOT_ELFLOADER_OPT_ARGV0");
+    char *fakechroot_disallow_env_changes = fakechroot_preserve_getenv("FAKECHROOT_DISALLOW_ENV_CHANGES");
+    char *fakechroot_library_orig = fakechroot_preserve_getenv("FAKECHROOT_LIBRARY_ORIG");
+    int ld_library_real_pos = -1;
 
     if (elfloader && !*elfloader) elfloader = NULL;
     if (elfloader_opt_argv0 && !*elfloader_opt_argv0) elfloader_opt_argv0 = NULL;
@@ -98,13 +102,13 @@
     /* Preserve old environment variables if not overwritten by new */
     for (j = 0; j < preserve_env_list_count; j++) {
         key = preserve_env_list[j];
-        env = getenv(key);
+        env = fakechroot_preserve_getenv(key);
         if (env != NULL && *env) {
             if (do_cmd_subst && strcmp(key, "FAKECHROOT_BASE") == 0) {
                 key = "FAKECHROOT_BASE_ORIG";
                 is_base_orig = 1;
             }
-            if (envp) {
+            if (envp && !fakechroot_disallow_env_changes) {
                 for (ep = (char **) envp; *ep != NULL; ++ep) {
                     strncpy(tmpkey, *ep, 1024);
                     tmpkey[1023] = 0;
@@ -117,6 +121,8 @@
                 }
             }
             newenvp[newenvppos] = malloc(strlen(key) + strlen(env) + 3);
+            if (strcmp(key, "LD_LIBRARY_REAL") == 0)
+                ld_library_real_pos = newenvppos;
             strcpy(newenvp[newenvppos], key);
             strcat(newenvp[newenvppos], "=");
             strcat(newenvp[newenvppos], env);
@@ -132,11 +138,40 @@
             tmpkey[1023] = 0;
             if ((tp = strchr(tmpkey, '=')) != NULL) {
                 *tp = 0;
+                for (j=0; j < newenvppos; j++) {  /* ignoore env vars already added */
+                    if (strncmp(newenvp[j], tmpkey, strlen(tmpkey)) == 0) {
+                        goto skip2;
+                    }
+                }
                 if (strcmp(tmpkey, "FAKECHROOT") == 0 ||
                     (is_base_orig && strcmp(tmpkey, "FAKECHROOT_BASE") == 0))
                 {
                     goto skip2;
                 }
+                /* broken */
+                if (fakechroot_library_orig && ld_library_real_pos != -1 && *(tp+1) != '\0' &&
+                       strcmp(tmpkey, "LD_LIBRARY_PATH") == 0) {
+                    int newsize, count = 1;
+                    char *dir, *iter, *ld_library_real;
+                    for (iter = *ep + (tp - tmpkey) + 1; *iter; iter++)
+                        if ( *iter == ':') count++;
+                    newsize = sizeof("LD_LIBRARY_REAL=") + strlen(fakechroot_library_orig) +
+                              strlen(tp+1) + (count * (strlen(fakechroot_base) + 1)) + 4;
+                    free(newenvp[ld_library_real_pos]);
+                    ld_library_real = newenvp[ld_library_real_pos] = malloc(newsize);
+                    strcpy(ld_library_real, "LD_LIBRARY_REAL=");
+                    for (iter = dir = *ep + (tp - tmpkey) + 1; *iter ; iter++) {
+                        if (*iter == ':' || *(iter + 1) == 0) {
+                            if (*iter == ':') *iter = 0; 
+                            strcat(ld_library_real, fakechroot_base);
+                            strcat(ld_library_real, "/");
+                            strcat(ld_library_real, dir);
+                            strcat(ld_library_real, ":");
+                            dir = iter + 1; 
+                        } 
+                    }
+                    strcat(ld_library_real, fakechroot_library_orig);
+                }
             }
             newenvp[newenvppos] = *ep;
             newenvppos++;
@@ -163,6 +198,10 @@
     /* Exec substituded command */
     if (do_cmd_subst) {
         debug("nextcall(execve)(\"%s\", {\"%s\", ...}, {\"%s\", ...})", substfilename, argv[0], newenvp[0]);
+
+        /* Indigo udocker */
+        fakechroot_upatch_elf(substfilename);
+
         status = nextcall(execve)(substfilename, (char * const *)argv, newenvp);
         goto error;
     }
@@ -184,8 +223,12 @@
         return -1;
     }
 
-    /* No hashbang in argv */
-    if (hashbang[0] != '#' || hashbang[1] != '!') {
+    /* ELF binary */
+    if (hashbang[0] == 127 && hashbang[1] == 'E' && hashbang[2] == 'L' && hashbang[3] == 'F') {
+
+        /* Indigo udocker */
+        fakechroot_upatch_elf(filename);
+
         if (!elfloader) {
             status = nextcall(execve)(filename, argv, newenvp);
             goto error;
@@ -211,25 +254,39 @@
         goto error;
     }
 
+    /* Indigo udocker fix spaces before #! */
+    for(j = 0; hashbang[j] == ' ' && j < 16; j++);
+    if (j) memmove(hashbang, hashbang + j, i);
+
     /* For hashbang we must fix argv[0] */
-    hashbang[i] = hashbang[i+1] = 0;
-    for (i = j = 2; (hashbang[i] == ' ' || hashbang[i] == '\t') && i < FAKECHROOT_PATH_MAX; i++, j++);
-    for (n = 0; i < FAKECHROOT_PATH_MAX; i++) {
-        c = hashbang[i];
-        if (hashbang[i] == 0 || hashbang[i] == ' ' || hashbang[i] == '\t' || hashbang[i] == '\n') {
-            hashbang[i] = 0;
-            if (i > j) {
-                if (n == 0) {
-                    ptr = &hashbang[j];
-                    expand_chroot_path(ptr);
-                    strcpy(newfilename, ptr);
+    if (hashbang[0] == '#' && hashbang[1] == '!') {
+        hashbang[i] = hashbang[i+1] = 0;
+        for (i = j = 2; (hashbang[i] == ' ' || hashbang[i] == '\t') && i < FAKECHROOT_PATH_MAX; i++, j++);
+        for (n = 0; i < FAKECHROOT_PATH_MAX; i++) {
+            c = hashbang[i];
+            if (hashbang[i] == 0 || hashbang[i] == ' ' || hashbang[i] == '\t' || hashbang[i] == '\n') {
+                hashbang[i] = 0;
+                if (i > j) {
+                    if (n == 0) {
+                        ptr = &hashbang[j];
+                        expand_chroot_path(ptr);
+                        strcpy(newfilename, ptr);
+                    }
+                    newargv[n++] = &hashbang[j];
                 }
-                newargv[n++] = &hashbang[j];
+                j = i + 1;
             }
-            j = i + 1;
+            if (c == '\n' || c == 0)
+                break;
         }
-        if (c == '\n' || c == 0)
-            break;
+    }
+    else {    /* default old behavior no hashbang in first line is shell */
+        char *ptr2;
+        ptr = ptr2 = "/bin/sh";
+        expand_chroot_path(ptr);
+        strcpy(newfilename, ptr);
+        n = 0;
+        newargv[n++] = ptr2;
     }
 
     newargv[n++] = argv0;
@@ -238,9 +295,13 @@
         newargv[n++] = argv[i++];
     }
 
+    /* Indigo udocker */
+    fakechroot_upatch_elf(newfilename);
+
     newargv[n] = 0;
 
     if (!elfloader) {
+        
         status = nextcall(execve)(newfilename, (char * const *)newargv, newenvp);
         goto error;
     }
@@ -261,11 +322,13 @@
         newargv[n++] = argv0;
     }
     newargv[n] = newfilename;
+
     debug("nextcall(execve)(\"%s\", {\"%s\", \"%s\", \"%s\", ...}, {\"%s\", ...})", elfloader, newargv[0], newargv[1], newargv[n], newenvp[0]);
     status = nextcall(execve)(elfloader, (char * const *)newargv, newenvp);
 
 error:
     free(newenvp);
 
+
     return status;
 }
diff -Naur fakechroot-2.18.orig/src/fclose.c fakechroot/src/fclose.c
--- fakechroot-2.18.orig/src/fclose.c	1970-01-01 01:00:00.000000000 +0100
+++ fakechroot/src/fclose.c	2017-04-05 01:13:04.555557745 +0100
@@ -0,0 +1,46 @@
+/*
+    libfakechroot -- fake chroot environment
+    Copyright (c) 2010, 2013 Piotr Roszatycki <dexter@debian.org>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Lesser General Public
+    License as published by the Free Software Foundation; either
+    version 2.1 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Lesser General Public License for more details.
+
+    You should have received a copy of the GNU Lesser General Public
+    License along with this library; if not, write to the Free Software
+    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307  USA
+*/
+
+/* udocker */
+
+#include <config.h>
+#include <stdio.h>
+
+#include <unistd.h>
+#include "libfakechroot.h"
+
+wrapper_alias(fclose, int, (FILE *fp))
+{
+    int close_status;
+    int fd = -1;
+    char *filename = (char *) 0; 
+
+    debug("fclose()"); 
+    if (fp) 
+        fd = fileno(fp);
+
+    close_status = nextcall(fclose)(fp);
+
+    if (fd != -1 && (close_status == 0) && fakechroot_iswlib(fd, &filename)) {
+        fakechroot_upatch_elf(filename);
+        free(filename);
+    }
+
+    return close_status;
+}
diff -Naur fakechroot-2.18.orig/src/fopen64.c fakechroot/src/fopen64.c
--- fakechroot-2.18.orig/src/fopen64.c	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/src/fopen64.c	2017-04-05 00:55:54.707608373 +0100
@@ -24,14 +24,25 @@
 
 #define _LARGEFILE64_SOURCE
 #include <stdio.h>
+#include <string.h>
 #include "libfakechroot.h"
 
 
 wrapper(fopen64, FILE *, (const char * path, const char * mode))
 {
+    FILE *fp;
+    int fd;
+
     debug("fopen64(\"%s\", \"%s\")", path, mode);
     expand_chroot_path(path);
-    return nextcall(fopen64)(path, mode);
+
+    fp = nextcall(fopen64)(path, mode);
+
+    /* udocker */
+    if (fp && mode && (fd = fileno(fp)) != -1 && strstr(mode, "w"))
+        fakechroot_addwlib(fd, (char *) path);
+
+    return fp;
 }
 
 #else
diff -Naur fakechroot-2.18.orig/src/fopen.c fakechroot/src/fopen.c
--- fakechroot-2.18.orig/src/fopen.c	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/src/fopen.c	2017-04-05 00:57:04.189944067 +0100
@@ -21,12 +21,22 @@
 #include <config.h>
 
 #include <stdio.h>
+#include <string.h>
 #include "libfakechroot.h"
 
 
 wrapper(fopen, FILE *, (const char * path, const char * mode))
 {
+    FILE *fp;
+    int fd;
+
     debug("fopen(\"%s\", \"%s\")", path, mode);
     expand_chroot_path(path);
-    return nextcall(fopen)(path, mode);
+    fp = nextcall(fopen)(path, mode);
+
+    /* udocker */
+    if (fp && mode && (fd = fileno(fp)) != -1 && strstr(mode, "w"))
+        fakechroot_addwlib(fd, (char *) path);
+
+    return fp;
 }
diff -Naur fakechroot-2.18.orig/src/freopen64.c fakechroot/src/freopen64.c
--- fakechroot-2.18.orig/src/freopen64.c	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/src/freopen64.c	2017-04-05 00:55:48.726579476 +0100
@@ -24,14 +24,24 @@
 
 #define _LARGEFILE64_SOURCE
 #include <stdio.h>
+#include <string.h>
 #include "libfakechroot.h"
 
 
 wrapper(freopen64, FILE *, (const char *path, const char *mode, FILE *stream))
 {
+    FILE *fp;
+    int fd;
+
     debug("freopen64(\"%s\", \"%s\", &stream)", path, mode);
     expand_chroot_path(path);
-    return nextcall(freopen64)(path, mode, stream);
+    fp = nextcall(freopen64)(path, mode, stream);
+
+    /* udocker */
+    if (fp && mode && (fd = fileno(fp)) != -1 && strstr(mode, "w"))
+        fakechroot_addwlib(fd, (char *) path);
+
+    return fp;
 }
 
 #else
diff -Naur fakechroot-2.18.orig/src/freopen.c fakechroot/src/freopen.c
--- fakechroot-2.18.orig/src/freopen.c	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/src/freopen.c	2017-04-05 00:56:16.396713160 +0100
@@ -21,12 +21,22 @@
 #include <config.h>
 
 #include <stdio.h>
+#include <string.h>
 #include "libfakechroot.h"
 
 
 wrapper(freopen, FILE *, (const char * path, const char * mode, FILE * stream))
 {
+    FILE *fp;
+    int fd;
+
     debug("freopen(\"%s\", \"%s\", &stream)", path, mode);
     expand_chroot_path(path);
-    return nextcall(freopen)(path, mode, stream);
+    fp = nextcall(freopen)(path, mode, stream);
+
+    /* udocker */
+    if (fp && mode && (fd = fileno(fp)) != -1 && strstr(mode, "w"))
+        fakechroot_addwlib(fd, (char *) path);
+
+    return fp;
 }
diff -Naur fakechroot-2.18.orig/src/libfakechroot.c fakechroot/src/libfakechroot.c
--- fakechroot-2.18.orig/src/libfakechroot.c	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/src/libfakechroot.c	2017-04-09 19:16:33.458202872 +0100
@@ -33,19 +33,32 @@
 #include <stdio.h>
 #include <pwd.h>
 #include <dlfcn.h>
+#include <alloca.h>
 
 #include "setenv.h"
 #include "libfakechroot.h"
 #include "getcwd_real.h"
 #include "strchrnul.h"
+#include "strlcpy.h"
 
+int lib_init = 0;
+int fakechroot_disallow_env_changes = -1;
 
 /* Useful to exclude a list of directories or files */
-static char *exclude_list[32];
-static int exclude_length[32];
-static int list_max = 0;
-static int first = 0;
+#define EXCLUDE_SIZE 64
+char *exclude_list[EXCLUDE_SIZE];
+int exclude_length[EXCLUDE_SIZE];
+int list_max = 0;
+
+/* Indigo udocker map hostdirs to container dirs */
+#define MAPDIR_SIZE 64
+int map_list_max = 0;
 
+char *map_host_list[MAPDIR_SIZE];
+int map_host_length[MAPDIR_SIZE];
+
+char *map_cont_list[MAPDIR_SIZE];
+int map_cont_length[MAPDIR_SIZE];
 
 /* List of environment variables to preserve on clearenv() */
 char *preserve_env_list[] = {
@@ -59,11 +72,26 @@
     "FAKECHROOT_VERSION",
     "FAKEROOTKEY",
     "FAKED_MODE",
-    "LD_LIBRARY_PATH",
-    "LD_PRELOAD"
+    "LD_PRELOAD",
+    "LD_LIBRARY_REAL",
+    "LD_DEBUG",
+    "FAKECHROOT_LIBRARY_ORIG",
+    "FAKECHROOT_PATCH_PATCHELF",
+    "FAKECHROOT_PATCH_ELFLOADER",
+    "FAKECHROOT_DIR_MAP",
+    "FAKECHROOT_DISALLOW_ENV_CHANGES",
+    "FAKECHROOT_PATCH_LAST_TIME"
 };
+
 const int preserve_env_list_count = sizeof preserve_env_list / sizeof preserve_env_list[0];
 
+char **preserve_env_values;
+
+LOCAL void fakechroot_preserve_env_values(void);
+LOCAL int fakechroot_load_keyval (char * listkey[], char * listval[], int lenkey[], int lenval[], int list_len, char * env_var);
+LOCAL void fakechroot_dump_list(char * list[], int length[], int list_len);
+LOCAL int fakechroot_load_list (char * list[], int length[], int list_len, char * env_var);
+
 
 LOCAL int fakechroot_debug (const char *fmt, ...)
 {
@@ -73,7 +101,7 @@
     va_list ap;
     va_start(ap, fmt);
 
-    if (!getenv("FAKECHROOT_DEBUG"))
+    if (! getenv("FAKECHROOT_DEBUG"))
         return 0;
 
     sprintf(newfmt, PACKAGE ": %s\n", fmt);
@@ -84,55 +112,122 @@
     return ret;
 }
 
-
 #include "getcwd.h"
 
-
 /* Bootstrap the library */
 void fakechroot_init (void) CONSTRUCTOR;
 void fakechroot_init (void)
 {
-    char *detect = getenv("FAKECHROOT_DETECT");
 
+    if (! lib_init) {
 
-    if (detect) {
-        /* printf causes coredump on FreeBSD */
-        if (write(STDOUT_FILENO, PACKAGE, sizeof(PACKAGE)-1) &&
-            write(STDOUT_FILENO, " ", 1) &&
-            write(STDOUT_FILENO, VERSION, sizeof(VERSION)-1) &&
-            write(STDOUT_FILENO, "\n", 1)) { /* -Wunused-result */ }
-        _Exit(atoi(detect));
-    }
-
-    debug("fakechroot_init()");
-    debug("FAKECHROOT_BASE=\"%s\"", getenv("FAKECHROOT_BASE"));
-    debug("FAKECHROOT_BASE_ORIG=\"%s\"", getenv("FAKECHROOT_BASE_ORIG"));
-    debug("FAKECHROOT_CMD_ORIG=\"%s\"", getenv("FAKECHROOT_CMD_ORIG"));
-
-    if (!first) {
-        char *exclude_path = getenv("FAKECHROOT_EXCLUDE_PATH");
-
-        first = 1;
-
-        /* We get a list of directories or files */
-        if (exclude_path) {
-            int i;
-            for (i = 0; list_max < 32; ) {
-                int j;
-                for (j = i; exclude_path[j] != ':' && exclude_path[j] != '\0'; j++);
-                exclude_list[list_max] = malloc(j - i + 2);
-                memset(exclude_list[list_max], '\0', j - i + 2);
-                strncpy(exclude_list[list_max], &(exclude_path[i]), j - i);
-                exclude_length[list_max] = strlen(exclude_list[list_max]);
-                list_max++;
-                if (exclude_path[j] != ':') break;
-                i = j + 1;
-            }
+        lib_init = 1;
+       
+        char *detect = getenv("FAKECHROOT_DETECT");
+
+        if (detect) {
+            /* printf causes coredump on FreeBSD */
+            if (write(STDOUT_FILENO, PACKAGE, sizeof(PACKAGE)-1) &&
+                write(STDOUT_FILENO, " ", 1) &&
+                write(STDOUT_FILENO, VERSION, sizeof(VERSION)-1) &&
+                write(STDOUT_FILENO, "\n", 1)) { /* -Wunused-result */ }
+            _Exit(atoi(detect));
         }
 
+        debug("fakechroot_init()");
+        debug("FAKECHROOT_BASE=\"%s\"", getenv("FAKECHROOT_BASE"));
+        debug("FAKECHROOT_BASE_ORIG=\"%s\"", getenv("FAKECHROOT_BASE_ORIG"));
+        debug("FAKECHROOT_CMD_ORIG=\"%s\"", getenv("FAKECHROOT_CMD_ORIG"));
+
+        /* We get a list of directories or files to exclude pass from host to guest */
+        list_max = fakechroot_load_list(exclude_list, exclude_length,
+                                        EXCLUDE_SIZE, "FAKECHROOT_EXCLUDE_PATH");
+
+        /* We get a list of maps host_dir!container_dir */
+        map_list_max = fakechroot_load_keyval (map_host_list, map_cont_list,
+                                               map_host_length, map_cont_length,
+                                               MAPDIR_SIZE, "FAKECHROOT_DIR_MAP");
+        /*
+        fakechroot_dump_list(map_host_list, map_host_length, map_list_max);
+        fakechroot_dump_list(map_cont_list, map_cont_length, map_list_max);
+        */
+
         __setenv("FAKECHROOT", "true", 1);
         __setenv("FAKECHROOT_VERSION", FAKECHROOT, 1);
+
+        fakechroot_preserve_env_values();
+        fakechroot_iniwlib();
+
+        lib_init = 2;
+    }
+}
+
+LOCAL void fakechroot_preserve_env_values(void)
+{
+    int j;
+    char *key, *val;
+    preserve_env_values = malloc(sizeof preserve_env_list);
+    for (j = 0; j < preserve_env_list_count; j++) {
+        key = preserve_env_list[j];
+        val = getenv(key);
+        preserve_env_values[j] = 0;
+        if (val) {
+            preserve_env_values[j] = malloc(strlen(val) + 1);
+            strcpy(preserve_env_values[j], val); 
+            debug("env %s = %s\n", preserve_env_list[j], preserve_env_values[j]);
+        }
+        if (strcmp(key, "FAKECHROOT_DISALLOW_ENV_CHANGES"))
+            fakechroot_disallow_env_changes = 1;
+    }
+}
+
+char * fakechroot_preserve_getenv(char * search_key)
+{
+    int j;
+    if (fakechroot_disallow_env_changes == 1) {
+        for (j = 0; j < preserve_env_list_count; j++) {
+            if (strcmp(search_key, preserve_env_list[j]) == 0 && preserve_env_values[j])
+                return preserve_env_values[j];
+        }
+        return NULL;
+    }
+    else {
+        return getenv(search_key);
+    }
+}
+
+LOCAL int fakechroot_load_list (char * list[], int length[], int list_len, char * env_var)
+{
+    int list_pos = 0;
+    char *env_str = getenv(env_var);
+
+    if (env_str) {
+        int i;
+        for (i = 0; list_pos < list_len; ) {
+            int j;
+            for (j = i; env_str[j] != ':' && env_str[j] != '\0'; j++);
+            list[list_pos] = malloc(j - i + 2);
+            memset(list[list_pos], '\0', j - i + 2);
+            strncpy(list[list_pos], &(env_str[i]), j - i);
+            length[list_pos] = strlen(list[list_pos]);
+            list_pos++;
+            if (env_str[j] != ':') break;
+            i = j + 1;
+        }
+    }
+
+    return list_pos;
+}
+
+LOCAL int fakechroot_in_list (char * list[], int length[], int list_len, char * search)
+{
+    int list_pos;
+
+    for (list_pos = 0; list_pos < list_len; list_pos++) {
+        if (! strncmp(list[list_pos], search, strlen(list[list_pos]))) 
+            return 1;
     }
+    return 0;
 }
 
 
@@ -155,12 +250,15 @@
     char *v_path = (char *)p_path;
     char cwd_path[FAKECHROOT_PATH_MAX];
 
-    if (!p_path)
-        return 0;
+    if (! p_path)
+       return 0;
 
-    if (!first)
+    if (! lib_init)
         fakechroot_init();
 
+    if (! list_max)
+        return 0;
+
     /* We need to expand relative paths */
     if (p_path[0] != '/') {
         getcwd_real(cwd_path, FAKECHROOT_PATH_MAX);
@@ -184,7 +282,6 @@
     return 0;
 }
 
-
 /*
  * Parse the FAKECHROOT_CMD_SUBST environment variable (the first
  * parameter) and if there is a match with filename, return the
@@ -222,3 +319,181 @@
 
     return 0;
 }
+
+/*
+ * Indigo udocker **************************************************************
+ */
+
+LOCAL int 
+fakechroot_load_keyval (char * listkey[], char * listval[], int lenkey[], int lenval[], int list_len, char * env_var)
+{
+    int list_pos = 0;
+    char *env_str = getenv(env_var);
+
+    if (env_str) {
+        int i;
+        for (i = 0; list_pos < list_len; ) {
+            int j, k;
+            for (j = i; env_str[j] != ':' && env_str[j] != '\0'; j++);
+            for (k = i; env_str[k] != '!' && k != j; k++);
+            listkey[list_pos] = malloc(k - i + 2);
+            memset(listkey[list_pos], '\0', k - i + 2);
+            strncpy(listkey[list_pos], &(env_str[i]), k - i);
+            lenkey[list_pos] = strlen(listkey[list_pos]);
+            if (env_str[k] == ':') {
+                listval[list_pos] = malloc(k - i + 2);
+                memset(listval[list_pos], '\0', k - i + 2);
+                strncpy(listval[list_pos], &(env_str[i]), k - i);
+                lenval[list_pos] = strlen(listval[list_pos]);
+            }
+            else if (env_str[k] == '!') {
+                listval[list_pos] = malloc(j - k + 1);
+                memset(listval[list_pos], '\0', j - k + 1);
+                strncpy(listval[list_pos], &(env_str[k+1]), j - k - 1);
+                lenval[list_pos] = strlen(listval[list_pos]);
+            }
+            list_pos++;
+            if (env_str[j] == '\0') break;
+            i = j + 1;
+        }
+    }
+
+    return list_pos;
+}
+
+/* Check if path is on container mapped directories list */
+LOCAL int fakechroot_ismapdir (const char * p_path)
+{
+    char *v_path = (char *)p_path;
+    char cwd_path[FAKECHROOT_PATH_MAX];
+
+    if (! p_path)
+        return -1;
+
+    if (! lib_init)
+        fakechroot_init();
+
+    if (! map_list_max)
+        return -1;
+
+    /* We need to expand relative paths */
+    if (p_path[0] != '/') {
+        getcwd(cwd_path, FAKECHROOT_PATH_MAX);
+        strlcpy(cwd_path + strlen(cwd_path), "/", FAKECHROOT_PATH_MAX);
+        strlcpy(cwd_path + strlen(cwd_path), p_path, FAKECHROOT_PATH_MAX);
+        /*
+        int i;
+        i = fakechroot_ishostmapdir(cwd_path);
+        debug("fakechroot_ismapdir %s cwd=%s (%d)", p_path, cwd_path, i);
+        return i; 
+        */
+        /*
+        narrow_chroot_path(v_path);
+        */
+    }
+
+    /* We try to find if we have a mapping to a host file or dir */
+    {
+        const size_t len = strlen(v_path);
+        int i;
+
+        for (i = 0; i < map_list_max; i++) {
+            if (map_cont_length[i] > len ||
+                    v_path[map_cont_length[i] - 1] != (map_cont_list[i])[map_cont_length[i] - 1] ||
+                    strncmp(map_cont_list[i], v_path, map_cont_length[i]) != 0) continue;
+            if (map_cont_length[i] == len || v_path[map_cont_length[i]] == '/') {
+                debug("fakechroot_ismapdir %s matches %s", v_path, map_cont_list[i]);
+                return i;
+            }
+        }
+    }
+
+    return -1;
+}
+
+/* Replace prefix of path with host path */
+LOCAL int fakechroot_getmapdir(const char * p_path, int map_pos, char * resolved)
+{
+    if (p_path[0] != '/') {
+        int len;
+        getcwd(resolved, FAKECHROOT_PATH_MAX);
+        len = strlen(resolved); 
+        resolved[len] =  '/';
+        strlcpy(resolved + len + 1, p_path, strlen(p_path) + 1);
+        debug("fakechroot_getmapdir %s -> %s", p_path, resolved);
+        return 1;
+    } 
+    else {
+        strlcpy(resolved, map_host_list[map_pos], FAKECHROOT_PATH_MAX);
+        strlcpy(resolved + map_host_length[map_pos], p_path + map_cont_length[map_pos], FAKECHROOT_PATH_MAX);
+        debug("fakechroot_getmapdir %s -> %s", p_path, resolved);
+        return 1;
+    }
+}
+
+/* Check if path is in map_host_list */
+LOCAL int fakechroot_ishostmapdir (const char * p_path)
+{
+    char *v_path = (char *)p_path;
+    char cwd_path[FAKECHROOT_PATH_MAX];
+    size_t len;
+
+    if (! p_path)
+        return -1;
+
+    if (! lib_init)
+        fakechroot_init();
+
+    if (! map_list_max)
+        return -1;
+
+    /* We need to expand relative paths */
+    if (p_path[0] != '/') {
+        debug("fakechroot_ishostmapdir %s", p_path);
+        getcwd_real(cwd_path, FAKECHROOT_PATH_MAX);
+        v_path = cwd_path;
+        len = strlen(v_path);
+        v_path[len] = '/';
+        strlcpy(v_path + len + 1, p_path, FAKECHROOT_PATH_MAX);
+    }
+    else {
+        len = strlen(v_path);
+    }
+
+    /* We try to find if we have a mapping to a host file or dir */
+    {
+        int i;
+
+        for (i = 0; i < map_list_max; i++) {
+            if (map_host_length[i] > len ||
+                    v_path[map_host_length[i] - 1] != (map_host_list[i])[map_host_length[i] - 1] ||
+                    strncmp(map_host_list[i], v_path, map_host_length[i]) != 0) continue;
+            if (map_host_length[i] == len || v_path[map_host_length[i]] == '/') {
+                debug("fakechroot_ishostmapdir %s matches %s", v_path, map_host_list[i]);
+                return i;
+            }
+        }
+    }
+    return -1;
+}
+
+/* Replace prefix of path with cont path */
+LOCAL int fakechroot_getcontmapdir(const char * p_path, int map_pos, char * resolved)
+{
+    strlcpy(resolved, map_cont_list[map_pos], FAKECHROOT_PATH_MAX);
+    strlcpy(resolved + map_cont_length[map_pos], p_path + map_host_length[map_pos], FAKECHROOT_PATH_MAX);
+    debug("fakechroot_getcontmapdir %s -> %s", p_path, resolved);
+    return 1;
+}
+
+/* Dump a list content */
+LOCAL void fakechroot_dump_list(char * list[], int length[], int list_len)
+{
+    int list_pos;
+
+    for (list_pos = 0; list_pos < list_len; list_pos++) {
+        debug("%d=\"%s\" : %d", list_pos, list[list_pos], length[list_pos]);
+    }
+}
+
+
diff -Naur fakechroot-2.18.orig/src/libfakechroot.h fakechroot/src/libfakechroot.h
--- fakechroot-2.18.orig/src/libfakechroot.h	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/src/libfakechroot.h	2017-04-06 00:42:36.191846941 +0100
@@ -80,7 +80,38 @@
 # define vfork fork
 #endif
 
+/* Indigo udocker */
+/* convert a host path to a path relative to the container base dir (udocker) */
+#define udocker_host_narrow_chroot_path(path) \
+    { \
+        if ((path) != NULL && *((char *)(path)) != '\0') { \
+            int map_pos; \
+            if ((map_pos = fakechroot_ishostmapdir((path))) != -1) { \
+                char fakechroot_buf[FAKECHROOT_PATH_MAX]; \
+                if (fakechroot_getcontmapdir((path), map_pos, fakechroot_buf)) \
+                    memmove((void *)(path), fakechroot_buf, strlen(fakechroot_buf) + 1); \
+            } \
+            else { \
+                const char *fakechroot_base = getenv("FAKECHROOT_BASE"); \
+                if (fakechroot_base != NULL) { \
+                    char *fakechroot_ptr = strstr((path), fakechroot_base); \
+                    if (fakechroot_ptr == (path)) { \
+                        const size_t fakechroot_base_len = strlen(fakechroot_base); \
+                        const size_t path_len = strlen(path); \
+                        if (path_len == fakechroot_base_len) { \
+                            ((char *)(path))[0] = '/'; \
+                            ((char *)(path))[1] = '\0'; \
+                        } \
+                        else if ( ((char *)(path))[fakechroot_base_len] == '/' ) { \
+                            memmove((void *)(path), (path) + fakechroot_base_len, 1 + path_len - fakechroot_base_len); \
+                        } \
+                    } \
+                } \
+            } \
+        } \
+    }
 
+/* convert path to relative to the container base dir (original implementation) */
 #define narrow_chroot_path(path) \
     { \
         if ((path) != NULL && *((char *)(path)) != '\0') { \
@@ -102,20 +133,33 @@
         } \
     }
 
+/* Indigo udocker */
+/* convert container path to host absolute path */
 #define expand_chroot_rel_path(path) \
     { \
         if (!fakechroot_localdir(path)) { \
-            if ((path) != NULL && *((char *)(path)) == '/') { \
+            int map_pos; \
+            if ((map_pos = fakechroot_ismapdir(path)) != -1) { \
+                char fakechroot_buf[FAKECHROOT_PATH_MAX]; \
+                if (fakechroot_getmapdir((path), map_pos, fakechroot_buf)) \
+                    (path) = fakechroot_buf; \
+            } \
+            else if ((path) != NULL && *((char *)(path)) == '/') { \
                 const char *fakechroot_base = getenv("FAKECHROOT_BASE"); \
                 if (fakechroot_base != NULL ) { \
                     char fakechroot_buf[FAKECHROOT_PATH_MAX]; \
-                    snprintf(fakechroot_buf, FAKECHROOT_PATH_MAX, "%s%s", fakechroot_base, (path)); \
-                    (path) = fakechroot_buf; \
+                    char *fakechroot_ptr = strstr((path), fakechroot_base); \
+                    if (fakechroot_ptr != (path)) { \
+                        snprintf(fakechroot_buf, FAKECHROOT_PATH_MAX, "%s%s", fakechroot_base, (path)); \
+                        (path) = fakechroot_buf; \
+                    } \
                 } \
             } \
         } \
     }
 
+/* Indigo udocker */
+/* convert relative container path to host absolute path */
 #define expand_chroot_path(path) \
     { \
         if (!fakechroot_localdir(path)) { \
@@ -128,6 +172,8 @@
         } \
     }
 
+/* Indigo udocker */
+/* convert relative container path to host absolute path */
 #define expand_chroot_path_at(dirfd, path) \
     { \
         if (!fakechroot_localdir(path)) { \
@@ -204,8 +250,8 @@
     const char *name;
 };
 
-
 extern char *preserve_env_list[];
+extern char **preserve_env_values;
 extern const int preserve_env_list_count;
 
 int fakechroot_debug (const char *, ...);
@@ -217,4 +263,18 @@
 /* We don't want to define _BSD_SOURCE and _DEFAULT_SOURCE and include stdio.h */
 int snprintf(char *, size_t, const char *, ...);
 
+/* Indigo udocker */
+int fakechroot_getmapdir(const char * p_path, int map_pos, char * resolved);
+int fakechroot_ismapdir (const char * p_path);
+char * fakechroot_preserve_getenv(char * search_key);
+int fakechroot_getcontmapdir(const char * p_path, int map_pos, char * resolved);
+int fakechroot_ishostmapdir (const char * p_path);
+void fakechroot_iniwlib(void);
+int fakechroot_addwlib(const int fd, char * wlibnam);
+int fakechroot_iswlib(const int fd, char ** wlibnam);
+int fakechroot_upatch_elf(const char * filename);
+
 #endif
+
+
+
diff -Naur fakechroot-2.18.orig/src/lstat.c fakechroot/src/lstat.c
--- fakechroot-2.18.orig/src/lstat.c	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/src/lstat.c	2017-02-27 00:14:15.181567245 +0000
@@ -33,7 +33,14 @@
     debug("lstat(%d, \"%s\", &buf)", ver, filename);
 
     if (!fakechroot_localdir(filename)) {
-        if (filename != NULL) {
+        /* Indigo udocker host map */
+        int map_pos;
+        if ((map_pos = fakechroot_ismapdir(filename)) != -1) {
+            char fakechroot_buf[FAKECHROOT_PATH_MAX];
+            if (fakechroot_getmapdir(filename, map_pos, fakechroot_buf))
+                filename = fakechroot_buf;
+        }
+        else if (filename != NULL) {
             char abs_filename[FAKECHROOT_PATH_MAX];
             rel2abs(filename, abs_filename);
             filename = abs_filename;
diff -Naur fakechroot-2.18.orig/src/__lxstat64.c fakechroot/src/__lxstat64.c
--- fakechroot-2.18.orig/src/__lxstat64.c	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/src/__lxstat64.c	2017-02-27 00:12:54.982231804 +0000
@@ -40,9 +40,18 @@
     debug("__lxstat64(%d, \"%s\", &buf)", ver, filename);
 
     if (filename && !fakechroot_localdir(filename)) {
-        char abs_filename[FAKECHROOT_PATH_MAX];
-        rel2abs(filename, abs_filename);
-        filename = abs_filename;
+        /* Indigo udocker host map */        
+        int map_pos;
+        if ((map_pos = fakechroot_ismapdir(filename)) != -1) {
+            char fakechroot_buf[FAKECHROOT_PATH_MAX];
+            if (fakechroot_getmapdir(filename, map_pos, fakechroot_buf))
+                filename = fakechroot_buf;
+        }
+        else {
+            char abs_filename[FAKECHROOT_PATH_MAX];
+            rel2abs(filename, abs_filename);
+            filename = abs_filename;
+        }
     }
 
     return __lxstat64_rel(ver, filename, buf);
diff -Naur fakechroot-2.18.orig/src/Makefile.am fakechroot/src/Makefile.am
--- fakechroot-2.18.orig/src/Makefile.am	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/src/Makefile.am	2017-04-05 01:17:33.224845062 +0100
@@ -37,6 +37,7 @@
     chown.c \
     chroot.c \
     clearenv.c \
+    close.c \
     connect.c \
     creat.c \
     creat64.c \
@@ -57,6 +58,7 @@
     faccessat.c \
     fchmodat.c \
     fchownat.c \
+    fclose.c \
     fopen.c \
     fopen64.c \
     freopen.c \
@@ -167,7 +169,8 @@
     unlinkat.c \
     utime.c \
     utimensat.c \
-    utimes.c
+    utimes.c \
+    patchelf.c
 libfakechroot_la_LDFLAGS = -avoid-version
 
 AM_CFLAGS = $(EXTRA_CFLAGS)
diff -Naur fakechroot-2.18.orig/src/Makefile.in fakechroot/src/Makefile.in
--- fakechroot-2.18.orig/src/Makefile.in	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/src/Makefile.in	2017-04-05 01:18:25.976097818 +0100
@@ -1,7 +1,7 @@
-# Makefile.in generated by automake 1.15 from Makefile.am.
+# Makefile.in generated by automake 1.13.4 from Makefile.am.
 # @configure_input@
 
-# Copyright (C) 1994-2014 Free Software Foundation, Inc.
+# Copyright (C) 1994-2013 Free Software Foundation, Inc.
 
 # This Makefile.in is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -15,17 +15,7 @@
 @SET_MAKE@
 
 VPATH = @srcdir@
-am__is_gnu_make = { \
-  if test -z '$(MAKELEVEL)'; then \
-    false; \
-  elif test -n '$(MAKE_HOST)'; then \
-    true; \
-  elif test -n '$(MAKE_VERSION)' && test -n '$(CURDIR)'; then \
-    true; \
-  else \
-    false; \
-  fi; \
-}
+am__is_gnu_make = test -n '$(MAKEFILE_LIST)' && test -n '$(MAKELEVEL)'
 am__make_running_with_option = \
   case $${target_option-} in \
       ?) ;; \
@@ -89,6 +79,8 @@
 build_triplet = @build@
 host_triplet = @host@
 subdir = src
+DIST_COMMON = $(srcdir)/Makefile.in $(srcdir)/Makefile.am \
+	$(top_srcdir)/build-aux/depcomp
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
 am__aclocal_m4_deps = $(top_srcdir)/m4/check_c_alignof.m4 \
 	$(top_srcdir)/m4/check_c_attribute.m4 \
@@ -105,7 +97,6 @@
 	$(top_srcdir)/m4/prog_prove_opt.m4 $(top_srcdir)/configure.ac
 am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
 	$(ACLOCAL_M4)
-DIST_COMMON = $(srcdir)/Makefile.am $(am__DIST_COMMON)
 mkinstalldirs = $(install_sh) -d
 CONFIG_HEADER = $(top_builddir)/config.h
 CONFIG_CLEAN_FILES =
@@ -148,11 +139,11 @@
 	__xmknodat.lo __xstat.lo __xstat64.lo _xftw.lo _xftw64.lo \
 	access.lo acct.lo audit_log_acct_message.lo bind.lo \
 	bindtextdomain.lo canonicalize_file_name.lo chdir.lo chmod.lo \
-	chown.lo chroot.lo clearenv.lo connect.lo creat.lo creat64.lo \
+	chown.lo chroot.lo clearenv.lo close.lo connect.lo creat.lo creat64.lo \
 	dedotdot.lo dl_iterate_phdr.lo dladdr.lo dlmopen.lo dlopen.lo \
 	eaccess.lo euidaccess.lo execl.lo execle.lo execlp.lo execv.lo \
 	execve.lo execvp.lo faccessat.lo fchmodat.lo fchownat.lo \
-	fopen.lo fopen64.lo freopen.lo freopen64.lo fts.lo ftw.lo \
+	fclose.lo fopen.lo fopen64.lo freopen.lo freopen64.lo fts.lo ftw.lo \
 	ftw64.lo futimesat.lo get_current_dir_name.lo getcwd.lo \
 	getcwd_real.lo getpeername.lo getsockname.lo getwd.lo \
 	getxattr.lo glob.lo glob64.lo glob_pattern_p.lo \
@@ -172,7 +163,7 @@
 	statvfs64.lo stpcpy.lo strchrnul.lo strlcpy.lo symlink.lo \
 	symlinkat.lo system.lo tempnam.lo tmpnam.lo truncate.lo \
 	truncate64.lo ulckpwdf.lo unlink.lo unlinkat.lo utime.lo \
-	utimensat.lo utimes.lo
+	utimensat.lo utimes.lo patchelf.lo
 libfakechroot_la_OBJECTS = $(am_libfakechroot_la_OBJECTS)
 AM_V_lt = $(am__v_lt_@AM_V@)
 am__v_lt_ = $(am__v_lt_@AM_DEFAULT_V@)
@@ -242,8 +233,6 @@
   done | $(am__uniquify_input)`
 ETAGS = etags
 CTAGS = ctags
-am__DIST_COMMON = $(srcdir)/Makefile.in \
-	$(top_srcdir)/build-aux/depcomp
 DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
 ACLOCAL = @ACLOCAL@
 ALLOCA = @ALLOCA@
@@ -372,7 +361,6 @@
 prefix = @prefix@
 program_transform_name = @program_transform_name@
 psdir = @psdir@
-runstatedir = @runstatedir@
 sbindir = @sbindir@
 sharedstatedir = @sharedstatedir@
 srcdir = @srcdir@
@@ -420,6 +408,7 @@
     chown.c \
     chroot.c \
     clearenv.c \
+    close.c \
     connect.c \
     creat.c \
     creat64.c \
@@ -440,6 +429,7 @@
     faccessat.c \
     fchmodat.c \
     fchownat.c \
+    fclose.c \
     fopen.c \
     fopen64.c \
     freopen.c \
@@ -550,7 +540,8 @@
     unlinkat.c \
     utime.c \
     utimensat.c \
-    utimes.c
+    utimes.c \
+    patchelf.c
 
 libfakechroot_la_LDFLAGS = -avoid-version
 AM_CFLAGS = $(EXTRA_CFLAGS)
@@ -571,6 +562,7 @@
 	echo ' cd $(top_srcdir) && $(AUTOMAKE) --foreign src/Makefile'; \
 	$(am__cd) $(top_srcdir) && \
 	  $(AUTOMAKE) --foreign src/Makefile
+.PRECIOUS: Makefile
 Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
 	@case '$?' in \
 	  *config.status*) \
@@ -667,6 +659,7 @@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/chown.Plo@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/chroot.Plo@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/clearenv.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/close.Plo@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/connect.Plo@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/creat.Plo@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/creat64.Plo@am__quote@
@@ -686,6 +679,7 @@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/faccessat.Plo@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/fchmodat.Plo@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/fchownat.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/fclose.Plo@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/fopen.Plo@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/fopen64.Plo@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/freopen.Plo@am__quote@
@@ -740,6 +734,7 @@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/openat.Plo@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/openat64.Plo@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/opendir.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/patchelf.Plo@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/pathconf.Plo@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/popen.Plo@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/posix_spawn.Plo@am__quote@
@@ -789,14 +784,14 @@
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(COMPILE) -c -o $@ $<
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(COMPILE) -c $<
 
 .c.obj:
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(COMPILE) -c -o $@ `$(CYGPATH_W) '$<'`
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(COMPILE) -c `$(CYGPATH_W) '$<'`
 
 .c.lo:
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(LTCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
@@ -1018,8 +1013,6 @@
 	pdf pdf-am ps ps-am tags tags-am uninstall uninstall-am \
 	uninstall-pkglibLTLIBRARIES
 
-.PRECIOUS: Makefile
-
 
 # Tell versions [3.59,3.63) of GNU make to not export all variables.
 # Otherwise a system limit (for SysV at least) may be exceeded.
diff -Naur fakechroot-2.18.orig/src/open64.c fakechroot/src/open64.c
--- fakechroot-2.18.orig/src/open64.c	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/src/open64.c	2017-04-04 12:42:43.258609909 +0100
@@ -32,6 +32,7 @@
 wrapper_alias(open64, int, (const char * pathname, int flags, ...))
 {
     int mode = 0;
+    int fd;
 
     va_list arg;
     va_start(arg, flags);
@@ -43,8 +44,13 @@
         mode = va_arg(arg, int);
         va_end(arg);
     }
+ 
+    fd = nextcall(open64)(pathname, flags, mode);
+    /* udocker */
+    if (fd != -1 && flags & (O_CREAT | O_WRONLY))
+        fakechroot_addwlib(fd, (char *) pathname);
 
-    return nextcall(open64)(pathname, flags, mode);
+    return fd;
 }
 
 #else
diff -Naur fakechroot-2.18.orig/src/openat64.c fakechroot/src/openat64.c
--- fakechroot-2.18.orig/src/openat64.c	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/src/openat64.c	2017-04-04 12:41:56.309430086 +0100
@@ -33,6 +33,7 @@
 wrapper_alias(openat64, int, (int dirfd, const char * pathname, int flags, ...))
 {
     int mode = 0;
+    int fd;
 
     va_list arg;
     va_start(arg, flags);
@@ -45,7 +46,12 @@
         va_end(arg);
     }
 
-    return nextcall(openat64)(dirfd, pathname, flags, mode);
+    fd = nextcall(openat64)(dirfd, pathname, flags, mode);
+    /* udocker */
+    if (fd != -1 && flags & (O_CREAT | O_WRONLY))
+        fakechroot_addwlib(fd, 0);
+
+    return fd;
 }
 
 #else
diff -Naur fakechroot-2.18.orig/src/openat.c fakechroot/src/openat.c
--- fakechroot-2.18.orig/src/openat.c	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/src/openat.c	2017-04-04 12:42:11.640488807 +0100
@@ -32,19 +32,27 @@
 wrapper_alias(openat, int, (int dirfd, const char * pathname, int flags, ...))
 {
     int mode = 0;
+    int fd;
 
     va_list arg;
     va_start(arg, flags);
 
     debug("openat(%d, \"%s\", %d, ...)", dirfd, pathname, flags);
     expand_chroot_path_at(dirfd, pathname);
-
+/*
+    debug("openat expanded (%s)", pathname);
+*/
     if (flags & O_CREAT) {
         mode = va_arg(arg, int);
         va_end(arg);
     }
 
-    return nextcall(openat)(dirfd, pathname, flags, mode);
+    fd = nextcall(openat)(dirfd, pathname, flags, mode);
+    /* udocker */
+    if (fd != -1 && flags & (O_CREAT | O_WRONLY))
+        fakechroot_addwlib(fd, 0);
+
+    return fd;
 }
 
 #else
diff -Naur fakechroot-2.18.orig/src/open.c fakechroot/src/open.c
--- fakechroot-2.18.orig/src/open.c	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/src/open.c	2017-04-04 12:42:29.725558075 +0100
@@ -29,6 +29,7 @@
 wrapper_alias(open, int, (const char * pathname, int flags, ...))
 {
     int mode = 0;
+    int fd;
 
     va_list arg;
     va_start(arg, flags);
@@ -40,6 +41,10 @@
         mode = va_arg(arg, int);
         va_end(arg);
     }
+    fd = nextcall(open)(pathname, flags, mode);
+    /* udocker */
+    if (fd != -1 && flags & (O_CREAT | O_WRONLY))
+        fakechroot_addwlib(fd, (char *) pathname);
 
-    return nextcall(open)(pathname, flags, mode);
+    return fd;
 }
diff -Naur fakechroot-2.18.orig/src/patchelf.c fakechroot/src/patchelf.c
--- fakechroot-2.18.orig/src/patchelf.c	1970-01-01 01:00:00.000000000 +0100
+++ fakechroot/src/patchelf.c	2017-04-06 19:52:34.648088525 +0100
@@ -0,0 +1,511 @@
+/*
+    udocker -- run containers in user space
+    Copyright (c) 2016 Jorge Gomes <jorge@lip.pt>
+
+    Licensed under the Apache License, Version 2.0 (the "License");
+    you may not use this file except in compliance with the License.
+    You may obtain a copy of the License at
+
+    http://www.apache.org/licenses/LICENSE-2.0
+
+    Unless required by applicable law or agreed to in writing, software
+    distributed under the License is distributed on an "AS IS" BASIS,
+    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+    See the License for the specific language governing permissions and
+    limitations under the License.
+*/
+
+#define _GNU_SOURCE
+
+#include <stdio.h>
+#include <stdlib.h>
+#include <unistd.h>
+#include <string.h>
+#include <sys/types.h>
+#include <sys/wait.h>
+#include <sys/stat.h>
+#include <fcntl.h>
+#include <dlfcn.h>
+#include <limits.h>
+
+#include <config.h>
+
+#include "libfakechroot.h"
+#include "strlcpy.h"
+
+#ifdef STANDALONE
+#undef  debug
+#define debug(fmt, ...) fprintf(stderr, fmt, __VA_ARGS__); fputc('\n', stderr);
+#endif
+
+static int    patch_init = 0;
+static time_t patch_last_time = 0;
+
+static char * patch_patchelf;
+static char * patch_rpath;
+static char * patch_base;
+static char   patch_elfloader[PATH_MAX];
+
+static int    patch_patchelf_len = 0;
+static int    patch_elfloader_len = 0;
+static int    patch_rpath_len = 0;
+static int    patch_base_len = 0;
+
+static char   print_interpreter[] = "--print-interpreter";
+static char   set_interpreter[] = "--set-interpreter";
+static char   print_rpath[] = "--print-rpath";
+static char   set_rpath[] = "--set-rpath";
+static char   set_root_prefix[] = "--set-root-prefix";
+static char   restore_root_prefix[] = "--restore-root-prefix";
+static char   quiet_mode[] = "-q";
+
+static int    print_interpreter_len = sizeof(print_interpreter) -1;
+static int    set_interpreter_len = sizeof(set_interpreter) -1;
+static int    print_rpath_len = sizeof(print_rpath) -1;
+static int    set_rpath_len = sizeof(set_rpath) -1;
+
+int           (*next_execve)(const char *, char *const [], char *const []);
+char        * (*next_realpath)(const char *, char *);
+ssize_t       (*next_readlink)(const char *, char *, size_t);
+int           (*next_stat)(const char *, struct stat *);
+
+/* track changes to sharable libraries */
+#define MAPWLIB_SIZE 64
+int map_wlib_max = -1;
+char *map_wlibnam_list[MAPWLIB_SIZE];
+int map_wlibfd_list[MAPWLIB_SIZE];
+
+LOCAL void
+fakechroot_patch_loadfuncs()
+{
+
+#ifdef STANDALONE
+    if (! (next_realpath = dlsym(RTLD_DEFAULT, "realpath"))) {
+#else
+    if (! (next_realpath = dlsym(RTLD_NEXT, "realpath"))) {
+#endif
+        char *msg;
+        msg = dlerror();
+        debug("%s: %s: %s\n", PACKAGE, "realpath", msg != NULL ? msg : "unresolved symbol");
+        exit(EXIT_FAILURE);
+    }
+
+#ifdef STANDALONE
+    if (! (next_execve = dlsym(RTLD_DEFAULT, "execve"))) {
+#else
+    if (! (next_execve = dlsym(RTLD_NEXT, "execve"))) {
+#endif
+        char *msg;
+        msg = dlerror();
+        debug("%s: %s: %s\n", PACKAGE, "execve", msg != NULL ? msg : "unresolved symbol");
+        exit(EXIT_FAILURE);
+    }
+
+#ifdef STANDALONE
+    if (! (next_readlink = dlsym(RTLD_DEFAULT, "readlink"))) {
+#else
+    if (! (next_readlink = dlsym(RTLD_NEXT, "readlink"))) {
+#endif
+        char *msg;
+        msg = dlerror();
+        debug("%s: %s: %s\n", PACKAGE, "readlink", msg != NULL ? msg : "unresolved symbol");
+        exit(EXIT_FAILURE);
+    }
+}
+
+int
+fakechroot_patch_init()
+{
+    char *tmp_elfloader;
+    char *tmp_patch_last_time;
+
+    if (! patch_init) {
+        patch_init = 1;
+
+        debug("patch init");
+        fakechroot_patch_loadfuncs();
+
+        tmp_elfloader = 0;
+        if (! ((patch_patchelf = getenv("FAKECHROOT_PATCH_PATCHELF")) &&
+               (patch_base = getenv("FAKECHROOT_BASE")) &&
+               (tmp_elfloader = getenv("FAKECHROOT_PATCH_ELFLOADER")) ) )
+            goto error;
+
+        if (*tmp_elfloader == '/' && next_realpath(tmp_elfloader, patch_elfloader) == NULL)
+            goto error;
+
+        patch_rpath = getenv("FAKECHROOT_PATCH_RPATH");
+
+        if (tmp_patch_last_time = getenv("FAKECHROOT_PATCH_LAST_TIME")) {
+            sscanf((const char *) tmp_patch_last_time, "%lu", &patch_last_time);
+        }
+
+        patch_base_len = strlen(patch_base);
+
+        char *b;
+        for(b = patch_base + patch_base_len; b >= patch_base; b--) {
+            if (*b == '/' || *b == '\0' || *b == ' ') 
+                *b = '\0'; /* remove trailing slashes from base_path */
+            else 
+                break;
+        }
+
+        patch_base_len = strlen(patch_base);
+        patch_patchelf_len = strlen(patch_patchelf);
+        patch_elfloader_len = strlen(patch_elfloader);
+        if (patch_rpath)
+            patch_rpath_len = strlen(patch_rpath);
+
+        if (patch_base_len >= PATH_MAX ||
+            patch_patchelf_len >= PATH_MAX ||
+            patch_elfloader_len >= PATH_MAX ||
+            patch_rpath_len >= PATH_MAX)      {
+               debug("invalid environment variables length check _PATCH_"); 
+               goto error;
+        }
+
+        return patch_init = 2;
+
+    }
+error:
+    patch_init = 2;
+    patch_patchelf = 0;
+    return 0;
+}
+
+LOCAL int
+fakechroot_execute(char *buffer, char *cmd, char *args[])
+{
+    int link[2];
+    pid_t pid;
+    int len = 0;
+
+    if (pipe(link) == -1)
+        return -1;
+
+    if ((pid = fork()) == -1) {
+        return -1;
+
+    } else if (! pid) {
+
+        dup2(link[1], STDOUT_FILENO);
+        close(link[0]);
+        close(link[1]);
+        char *env[] = { NULL };
+        debug("fakechroot_execute (\"%s\")", cmd);
+        next_execve(cmd, args, env);
+        exit(1);
+
+    } else {
+
+        int status = 0;
+        close(link[1]);
+        if (buffer) {
+            if ((len = read(link[0], buffer, PATH_MAX -1)) > -1)
+                buffer[len] = '\0';
+        }
+
+        waitpid(pid, &status, 0);
+        close(link[0]);
+        if (! WIFEXITED(status))
+            return -1;
+
+    }
+    return len;
+}
+
+LOCAL int
+fakechroot_get_interpreter(char *interpreter, char *filename)
+{
+    char buffer[PATH_MAX];
+    int len;
+
+    debug("get_interpreter(\"%s\")", filename); 
+
+    *interpreter = '\0';
+
+    if (! patch_patchelf )
+        return 0;
+
+    char *args[] = { patch_patchelf, print_interpreter, filename, NULL };
+    if ((len = fakechroot_execute(buffer, patch_patchelf, args)) == -1)   
+        return 0;
+
+    char *b;
+    for(b=buffer+len, interpreter[len] = '\0'; b >= buffer ; b--) {
+        if (*b == '\n' || *b == '\r' || *b == ' ') 
+            *b = '\0';
+        interpreter[b - buffer] = *b;
+    }
+
+    debug("get_interpreter return(\"%s\"): %s", filename, interpreter); 
+
+    if (*interpreter != '/')
+        return 0;
+
+    return 1;
+}
+
+LOCAL int
+fakechroot_set_interpreter(char *interpreter, char *filename)
+{
+    debug("set_interpreter(\"%s\", \"%s\")", interpreter, filename); 
+
+    if (! patch_patchelf)
+        return 0;
+
+    char *args[] = { patch_patchelf, set_interpreter, interpreter, filename, NULL };
+    if (fakechroot_execute(0, patch_patchelf, args) == -1)   
+        return 0;
+   
+    return 1;
+}
+
+LOCAL int
+fakechroot_count_char(char *buffer, char ch, int buffer_len)
+{
+    char *b;
+    int count = 0;
+    for(b = buffer; b < buffer + buffer_len; b++)
+        if (*b == ch) count++;
+    return count;
+}
+
+int
+fakechroot_spatch_elf(char *filename)
+{
+    char interpreter[PATH_MAX];
+    char new_interpreter[PATH_MAX];
+    int interpreter_len = 0;
+
+    debug("standard patchelf");
+
+    if (patch_init != 2) {
+        if (patch_init == 1) {
+            int try;
+            for (try=10; patch_init == 1 && try; try--) usleep(1000);
+        }
+        if (patch_init != 2) {
+            fakechroot_patch_init();
+        }
+    }
+
+    if (patch_patchelf && patch_elfloader && filename) {
+
+        if (! fakechroot_get_interpreter(interpreter, filename))
+            return 1;
+
+        if (*interpreter != '/')
+            return 1;
+
+        if (*patch_elfloader == '/') {
+
+            if (! strcmp(interpreter, patch_elfloader))
+                return 1; /* equal no need to patch */
+
+            strlcpy(new_interpreter, patch_elfloader, PATH_MAX);   
+        } 
+        else { /* env FAKECHROOT_PATCH_ELFLOADER has relative path */
+
+            interpreter_len = strlen(interpreter);
+
+            if (! strncmp(interpreter, patch_base, patch_base_len))
+                return 1;      /* already patched */
+
+            char path_interpreter[PATH_MAX];
+            sprintf(path_interpreter, "%s/%s", patch_base, interpreter);
+
+            if ((next_realpath(path_interpreter, new_interpreter)) == NULL)
+                return 0;
+
+        }
+        return fakechroot_set_interpreter(new_interpreter, filename);
+    }
+    return 1;
+}
+
+int
+fakechroot_upatch_elf(const char *filename)
+{
+    debug("patchelf %s", filename);
+
+    if (patch_init != 2) {
+        if (patch_init == 1) {
+            int try;
+            for (try=10; patch_init == 1 && try; try--) usleep(1000);
+        }
+        if (patch_init != 2) {
+            fakechroot_patch_init();
+        }
+    }
+
+    if (patch_patchelf && patch_elfloader && filename) {
+
+        if (patch_last_time) {
+            struct stat fattr;
+            if (stat(filename, &fattr) == -1 || fattr.st_mtime < patch_last_time) {
+                return 0; 
+            }
+        }
+
+/*
+        char *args[] = { patch_patchelf, set_root_prefix, patch_base, (char *) filename, NULL };
+        debug(" %s %s %s %s %s",patch_patchelf, quiet_mode, set_root_prefix, patch_base, filename );
+*/
+
+        char *args[] = { patch_patchelf, quiet_mode, set_root_prefix, patch_base, (char *) filename, NULL };
+
+        if (fakechroot_execute(0, patch_patchelf, args) == -1) return 0;
+   
+        return 1;
+    }
+    return 1;
+}
+
+/* Init the list of sharable libraries open for writing */
+void
+fakechroot_iniwlib(void)
+{
+    int i;
+    for (i = 0; i < MAPWLIB_SIZE; i++) {    
+        map_wlibfd_list[i] = -1;
+        map_wlibnam_list[i] = 0;
+    }
+}
+
+/* Add to the list of sharable libraries open for writing */
+int
+fakechroot_addwlib(const int fd, char * wlibnam)
+{
+    int i, match;
+    int free_pos = -1;
+    char *newnam, *soext_start, *soext_end;
+
+    /* init */
+    if (patch_init != 2) {
+        if (patch_init == 1) {
+            int try;
+            for (try=10; patch_init == 1 && try; try--) usleep(1000);
+        }
+        if (patch_init != 2) {
+            fakechroot_patch_init();
+        }
+    }
+
+    /* get name of file from fd using the symlink /proc/self/fd/NNN */
+    if (! wlibnam) {
+        char fdnam[30];
+        int wliblen;
+
+        wlibnam = alloca(FAKECHROOT_PATH_MAX);
+        snprintf(fdnam, sizeof(fdnam), "/proc/self/fd/%d", fd); 
+        if ((wliblen = next_readlink(fdnam, wlibnam, FAKECHROOT_PATH_MAX)) == -1)
+            return 2;
+        if (wliblen == FAKECHROOT_PATH_MAX)
+            return 2;
+    }
+ 
+    /* look for .so extension */
+    match = 0;
+    if (soext_start = strstr(wlibnam, ".so")) {
+        soext_end = soext_start + 3;
+        if (*soext_end == '\0' || *soext_end == '.') {
+            debug("fakechroot_addwlib found lib %d -> %s", fd, wlibnam);
+            match = 1;
+        }
+    }
+    if (! match)
+        return 2;
+
+    /* find empty slot in map_wlibfd_list */
+    for (i = 0; i < MAPWLIB_SIZE; i++) {    
+        if (map_wlibfd_list[i] == -1) {
+            map_wlibfd_list[i] = fd;
+            if (i > map_wlib_max) 
+                map_wlib_max = i;
+            free_pos = i;
+            if (map_wlibfd_list[i] == fd)
+                break;
+            free_pos = -1;
+        }
+    }
+    if (free_pos == -1)
+        return 0;
+    debug("fakechroot_addwlib free slot (%d) %d -> %s", i, fd, wlibnam);
+
+    /* allocate memory for map_wlibfd_list entry if needed */
+    if (map_wlibnam_list[free_pos] == 0) {
+        if (newnam = malloc(FAKECHROOT_PATH_MAX)) {
+            *newnam = '\0';
+            map_wlibnam_list[free_pos] = newnam;
+        }
+        else {
+            return 0;
+        }
+
+        if (map_wlibnam_list[free_pos] != newnam) {
+            free(newnam);
+            return 0;
+        }
+    } 
+    debug("fakechroot_addwlib copy buff (%d) %d -> %s", i, fd, wlibnam);
+
+    /* copy filename to map_wlibfd_list entry */
+    strlcpy(newnam, wlibnam, FAKECHROOT_PATH_MAX);
+    return 1;
+}
+
+/* Is it in the list of sharable libraries open for writing */
+int
+fakechroot_iswlib(const int fd, char ** wlibnam)
+{
+    int i, last_open=-1;
+    debug("fakechroot_iswlib max %d", map_wlib_max);
+    for (i = 0; i <= map_wlib_max; i++) {    
+/*
+        debug("fakechroot_iswlib (%d) fd %d -> %s", i, fd, map_wlibnam_list[i]);
+*/
+        if (map_wlibfd_list[i] == fd) {
+            if (map_wlibnam_list[i] && *map_wlibnam_list[i] != '\0') {
+                if (*wlibnam == 0)
+                    *wlibnam = malloc(FAKECHROOT_PATH_MAX);
+                if (*wlibnam) {
+                    strlcpy(*wlibnam, map_wlibnam_list[i], FAKECHROOT_PATH_MAX);
+                    *map_wlibnam_list[i] = '\0';
+                    map_wlibfd_list[i] = -1;
+                    debug("fakechroot_iswlib found %s", *wlibnam);
+                    return 1;
+                }
+            }
+            debug("fakechroot_iswlib error (%d) fd %d", i, fd);
+            *map_wlibnam_list[i] = '\0';
+            map_wlibfd_list[i] = -1;
+            return 0;
+        }
+    }
+    return 0; 
+}
+
+
+
+#ifdef STANDALONE
+int
+main(int argc, char *argv[]) {
+    char interpreter[PATH_MAX];
+
+    /*
+    fakechroot_get_interpreter(interpreter, "/usr/bin/true");
+    printf("%s\n", interpreter);
+
+    strcpy(interpreter, "/lib64/ld-2.17.so"); 
+    fakechroot_set_interpreter(interpreter, "/usr/bin/true");
+
+    fakechroot_get_interpreter(interpreter, "/usr/bin/true");
+    printf("%s\n", interpreter);
+    */
+
+    fakechroot_upatch_elf("/tmp/x");
+    fakechroot_get_interpreter(interpreter, "/tmp/x");
+    printf("%s\n", interpreter);
+}
+#endif
diff -Naur fakechroot-2.18.orig/src/patchelf.sh fakechroot/src/patchelf.sh
--- fakechroot-2.18.orig/src/patchelf.sh	1970-01-01 01:00:00.000000000 +0100
+++ fakechroot/src/patchelf.sh	2016-11-05 03:43:34.218880344 +0000
@@ -0,0 +1,25 @@
+#!/bin/bash
+
+# Compile in standalone for testing
+#cc -DSTANDALONE -o pelf -g -O0 -I. -I.. patchelf.c -ldl
+
+# full host OS pathname to patchelf executable compiled preferrably as static 
+export FAKECHROOT_PATCH_PATCHELF=/home/jorge/mysoft/indigo/udocker/fake/bin/patchelf
+
+# ELFLOADER can be the full host OS pathname to a loader or simply "true"
+# if "true" the FAKECHROOT_BASE will be prepended to the executable loader
+#export FAKECHROOT_PATCH_ELFLOADER=/lib64/ld-2.17.so
+export FAKECHROOT_PATCH_ELFLOADER=/lib64/ld-linux-x86-64.so.2
+#export FAKECHROOT_PATCH_ELFLOADER=true
+
+# The standard FAKECHROOT_BASE as usual points to the top of the directory tree
+export FAKECHROOT_BASE=/home/jorge/.udocker/containers/64d5abf3-d0b4-30fd-89a5-5df244dfa2ea/ROOT
+
+# Test
+./pelf
+
+# Set or get manually the elf loader in this case CentOS 7
+#/home/jorge/mysoft/indigo/udocker/fake/bin/patchelf --set-interpreter /lib64/ld-2.17.so /bin/true
+#/home/jorge/mysoft/indigo/udocker/fake/bin/patchelf --get-interpreter /bin/true
+
+
diff -Naur fakechroot-2.18.orig/src/posix_spawn.c fakechroot/src/posix_spawn.c
--- fakechroot-2.18.orig/src/posix_spawn.c	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/src/posix_spawn.c	2017-03-14 01:35:19.478494819 +0000
@@ -61,8 +61,13 @@
     size_t sizeenvp;
     char c;
 
+    char *fakechroot_base = fakechroot_preserve_getenv("FAKECHROOT_BASE");
     char *elfloader = getenv("FAKECHROOT_ELFLOADER");
     char *elfloader_opt_argv0 = getenv("FAKECHROOT_ELFLOADER_OPT_ARGV0");
+    char *fakechroot_disallow_env_changes = fakechroot_preserve_getenv("FAKECHROOT_DISALLOW_ENV_CHANGES");
+    char *fakechroot_library_orig = fakechroot_preserve_getenv("FAKECHROOT_LIBRARY_ORIG");
+    int ld_library_real_pos = -1;
+
 
     if (elfloader && !*elfloader) elfloader = NULL;
     if (elfloader_opt_argv0 && !*elfloader_opt_argv0) elfloader_opt_argv0 = NULL;
@@ -102,13 +107,13 @@
     /* Preserve old environment variables if not overwritten by new */
     for (j = 0; j < preserve_env_list_count; j++) {
         key = preserve_env_list[j];
-        env = getenv(key);
+        env = fakechroot_preserve_getenv(key);
         if (env != NULL && *env) {
             if (do_cmd_subst && strcmp(key, "FAKECHROOT_BASE") == 0) {
                 key = "FAKECHROOT_BASE_ORIG";
                 is_base_orig = 1;
             }
-            if (envp) {
+            if (envp && !fakechroot_disallow_env_changes) {
                 for (ep = (char **) envp; *ep != NULL; ++ep) {
                     strncpy(tmpkey, *ep, 1024);
                     tmpkey[1023] = 0;
@@ -121,6 +126,8 @@
                 }
             }
             newenvp[newenvppos] = malloc(strlen(key) + strlen(env) + 3);
+            if (strcmp(key, "LD_LIBRARY_REAL") == 0)
+                ld_library_real_pos = newenvppos;
             strcpy(newenvp[newenvppos], key);
             strcat(newenvp[newenvppos], "=");
             strcat(newenvp[newenvppos], env);
@@ -136,11 +143,41 @@
             tmpkey[1023] = 0;
             if ((tp = strchr(tmpkey, '=')) != NULL) {
                 *tp = 0;
+                for (j=0; j < newenvppos; j++) {  /* ignoore env vars already added */
+                    if (strncmp(newenvp[j], tmpkey, strlen(tmpkey)) == 0) {
+                        goto skip2;
+                    }
+                }
                 if (strcmp(tmpkey, "FAKECHROOT") == 0 ||
                     (is_base_orig && strcmp(tmpkey, "FAKECHROOT_BASE") == 0))
                 {
                     goto skip2;
                 }
+                /* broken */
+                if (fakechroot_library_orig && ld_library_real_pos != -1 && *(tp+1) != '\0' &&
+                       strcmp(tmpkey, "LD_LIBRARY_PATH") == 0) {
+                    int newsize, count = 1;
+                    char *dir, *iter, *ld_library_real;
+                    for (iter = *ep + (tp - tmpkey) + 1; *iter; iter++)
+                        if ( *iter == ':') count++; 
+                    newsize = sizeof("LD_LIBRARY_REAL=") + strlen(fakechroot_library_orig) +
+                              strlen(tp+1) + (count * (strlen(fakechroot_base) + 1)) + 4;
+                    free(newenvp[ld_library_real_pos]);
+                    ld_library_real = newenvp[ld_library_real_pos] = malloc(newsize);
+                    strcpy(ld_library_real, "LD_LIBRARY_REAL=");
+                    for (iter = dir = *ep + (tp - tmpkey) + 1; *iter ; iter++) {
+                        if (*iter == ':' || *(iter + 1) == 0) {
+                            if (*iter == ':') *iter = 0; 
+                            strcat(ld_library_real, fakechroot_base);
+                            strcat(ld_library_real, "/");
+                            strcat(ld_library_real, dir);
+                            strcat(ld_library_real, ":");
+                            dir = iter + 1; 
+                        }
+                    }
+                    strcat(ld_library_real, fakechroot_library_orig);
+                }
+
             }
             newenvp[newenvppos] = *ep;
             newenvppos++;
@@ -167,6 +204,10 @@
     /* Exec substituded command */
     if (do_cmd_subst) {
         debug("nextcall(posix_spawn)(\"%s\", {\"%s\", ...}, {\"%s\", ...})", substfilename, argv[0], newenvp[0]);
+
+        /* Indigo udocker */
+        fakechroot_upatch_elf(substfilename);
+
         status = nextcall(posix_spawn)(pid, substfilename, file_actions, attrp, (char * const *)argv, newenvp);
         goto error;
     }
@@ -188,8 +229,12 @@
         return errno;
     }
 
-    /* No hashbang in argv */
-    if (hashbang[0] != '#' || hashbang[1] != '!') {
+    /* ELF binary */
+    if (hashbang[0] == 127 && hashbang[1] == 'E' && hashbang[2] == 'L' && hashbang[3] == 'F') {
+
+        /* Indigo udocker */
+        fakechroot_upatch_elf(filename);
+
         if (!elfloader) {
             status = nextcall(posix_spawn)(pid, filename, file_actions, attrp, argv, newenvp);
             goto error;
@@ -215,25 +260,39 @@
         goto error;
     }
 
+    /* Indigo udocker fix spaces before #! */
+    for(j = 0; hashbang[j] == ' ' && j < 16; j++);
+    if (j) memmove(hashbang, hashbang + j, i);
+
     /* For hashbang we must fix argv[0] */
-    hashbang[i] = hashbang[i+1] = 0;
-    for (i = j = 2; (hashbang[i] == ' ' || hashbang[i] == '\t') && i < FAKECHROOT_PATH_MAX; i++, j++);
-    for (n = 0; i < FAKECHROOT_PATH_MAX; i++) {
-        c = hashbang[i];
-        if (hashbang[i] == 0 || hashbang[i] == ' ' || hashbang[i] == '\t' || hashbang[i] == '\n') {
-            hashbang[i] = 0;
-            if (i > j) {
-                if (n == 0) {
-                    ptr = &hashbang[j];
-                    expand_chroot_path(ptr);
-                    strcpy(newfilename, ptr);
+    if (hashbang[0] == '#' && hashbang[1] == '!') {
+        hashbang[i] = hashbang[i+1] = 0;
+        for (i = j = 2; (hashbang[i] == ' ' || hashbang[i] == '\t') && i < FAKECHROOT_PATH_MAX; i++, j++);
+        for (n = 0; i < FAKECHROOT_PATH_MAX; i++) {
+            c = hashbang[i];
+            if (hashbang[i] == 0 || hashbang[i] == ' ' || hashbang[i] == '\t' || hashbang[i] == '\n') {
+                hashbang[i] = 0;
+                if (i > j) {
+                    if (n == 0) {
+                        ptr = &hashbang[j];
+                        expand_chroot_path(ptr);
+                        strcpy(newfilename, ptr);
+                    }
+                    newargv[n++] = &hashbang[j];
                 }
-                newargv[n++] = &hashbang[j];
+                j = i + 1;
             }
-            j = i + 1;
+            if (c == '\n' || c == 0)
+                break;
         }
-        if (c == '\n' || c == 0)
-            break;
+    }
+    else {    /* default old behavior no hashbang in first line is shell */
+        char *ptr2;
+        ptr = ptr2 = "/bin/sh";
+        expand_chroot_path(ptr);
+        strcpy(newfilename, ptr);
+        n = 0;
+        newargv[n++] = ptr2;
     }
 
     newargv[n++] = argv0;
@@ -242,6 +301,9 @@
         newargv[n++] = argv[i++];
     }
 
+    /* Indigo udocker */
+    fakechroot_upatch_elf(newfilename);
+
     newargv[n] = 0;
 
     if (!elfloader) {
@@ -265,6 +327,7 @@
         newargv[n++] = argv0;
     }
     newargv[n] = newfilename;
+
     debug("nextcall(posix_spawn)(\"%s\", {\"%s\", \"%s\", \"%s\", ...}, {\"%s\", ...})", elfloader, newargv[0], newargv[1], newargv[n], newenvp[0]);
     status = nextcall(posix_spawn)(pid, elfloader, file_actions, attrp, (char * const *)newargv, newenvp);
 
diff -Naur fakechroot-2.18.orig/src/posix_spawn.c.orig fakechroot/src/posix_spawn.c.orig
--- fakechroot-2.18.orig/src/posix_spawn.c.orig	1970-01-01 01:00:00.000000000 +0100
+++ fakechroot/src/posix_spawn.c.orig	2017-03-13 19:29:33.925927685 +0000
@@ -0,0 +1,288 @@
+/*
+    libfakechroot -- fake chroot environment
+    Copyright (c) 2010, 2013 Piotr Roszatycki <dexter@debian.org>
+
+    This library is free software; you can redistribute it and/or
+    modify it under the terms of the GNU Lesser General Public
+    License as published by the Free Software Foundation; either
+    version 2.1 of the License, or (at your option) any later version.
+
+    This library is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+    Lesser General Public License for more details.
+
+    You should have received a copy of the GNU Lesser General Public
+    License along with this library; if not, write to the Free Software
+    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307  USA
+*/
+
+
+#include <config.h>
+
+#ifdef HAVE_POSIX_SPAWN
+#define _GNU_SOURCE
+#include <errno.h>
+#include <stddef.h>
+#include <unistd.h>
+#include <spawn.h>
+#include <stdlib.h>
+#include <fcntl.h>
+#include <alloca.h>
+#include "strchrnul.h"
+#include "libfakechroot.h"
+#include "open.h"
+#include "setenv.h"
+#include "readlink.h"
+
+
+wrapper(posix_spawn, int, (pid_t* pid, const char * filename, 
+        const posix_spawn_file_actions_t* file_actions,
+        const posix_spawnattr_t* attrp, char* const argv[],
+        char * const envp []))
+{
+    int status;
+    int file;
+    int is_base_orig = 0;
+    char hashbang[FAKECHROOT_PATH_MAX];
+    size_t argv_max = 1024;
+    const char **newargv = alloca(argv_max * sizeof (const char *));
+    char **newenvp, **ep;
+    char *key, *env;
+    char tmpkey[1024], *tp;
+    char *cmdorig;
+    char tmp[FAKECHROOT_PATH_MAX];
+    char substfilename[FAKECHROOT_PATH_MAX];
+    char newfilename[FAKECHROOT_PATH_MAX];
+    char argv0[FAKECHROOT_PATH_MAX];
+    char *ptr;
+    unsigned int i, j, n, newenvppos;
+    unsigned int do_cmd_subst = 0;
+    size_t sizeenvp;
+    char c;
+
+    char *elfloader = getenv("FAKECHROOT_ELFLOADER");
+    char *elfloader_opt_argv0 = getenv("FAKECHROOT_ELFLOADER_OPT_ARGV0");
+
+    if (elfloader && !*elfloader) elfloader = NULL;
+    if (elfloader_opt_argv0 && !*elfloader_opt_argv0) elfloader_opt_argv0 = NULL;
+
+    debug("posix_spawn(\"%s\", {\"%s\", ...}, {\"%s\", ...})", filename, argv[0], envp ? envp[0] : "(null)");
+
+    strncpy(argv0, filename, FAKECHROOT_PATH_MAX);
+
+    /* Substitute command only if FAKECHROOT_CMD_ORIG is not set. Unset variable if it is empty. */
+    cmdorig = getenv("FAKECHROOT_CMD_ORIG");
+    if (cmdorig == NULL)
+        do_cmd_subst = fakechroot_try_cmd_subst(getenv("FAKECHROOT_CMD_SUBST"), argv0, substfilename);
+    else if (!*cmdorig)
+        unsetenv("FAKECHROOT_CMD_ORIG");
+
+    /* Scan envp and check its size */
+    sizeenvp = 0;
+    if (envp) {
+        for (ep = (char **)envp; *ep != NULL; ++ep) {
+            sizeenvp++;
+        }
+    }
+
+    /* Copy envp to newenvp */
+    newenvp = malloc( (sizeenvp + preserve_env_list_count + 1) * sizeof (char *) );
+    if (newenvp == NULL) {
+        __set_errno(ENOMEM);
+        return errno;
+    }
+    newenvppos = 0;
+
+    /* Create new envp */
+    newenvp[newenvppos] = malloc(strlen("FAKECHROOT=true") + 1);
+    strcpy(newenvp[newenvppos], "FAKECHROOT=true");
+    newenvppos++;
+
+    /* Preserve old environment variables if not overwritten by new */
+    for (j = 0; j < preserve_env_list_count; j++) {
+        key = preserve_env_list[j];
+        env = getenv(key);
+        if (env != NULL && *env) {
+            if (do_cmd_subst && strcmp(key, "FAKECHROOT_BASE") == 0) {
+                key = "FAKECHROOT_BASE_ORIG";
+                is_base_orig = 1;
+            }
+            if (envp) {
+                for (ep = (char **) envp; *ep != NULL; ++ep) {
+                    strncpy(tmpkey, *ep, 1024);
+                    tmpkey[1023] = 0;
+                    if ((tp = strchr(tmpkey, '=')) != NULL) {
+                        *tp = 0;
+                        if (strcmp(tmpkey, key) == 0) {
+                            goto skip1;
+                        }
+                    }
+                }
+            }
+            newenvp[newenvppos] = malloc(strlen(key) + strlen(env) + 3);
+            strcpy(newenvp[newenvppos], key);
+            strcat(newenvp[newenvppos], "=");
+            strcat(newenvp[newenvppos], env);
+            newenvppos++;
+        skip1: ;
+        }
+    }
+
+    /* Append old envp to new envp */
+    if (envp) {
+        for (ep = (char **) envp; *ep != NULL; ++ep) {
+            strncpy(tmpkey, *ep, 1024);
+            tmpkey[1023] = 0;
+            if ((tp = strchr(tmpkey, '=')) != NULL) {
+                *tp = 0;
+                if (strcmp(tmpkey, "FAKECHROOT") == 0 ||
+                    (is_base_orig && strcmp(tmpkey, "FAKECHROOT_BASE") == 0))
+                {
+                    goto skip2;
+                }
+            }
+            newenvp[newenvppos] = *ep;
+            newenvppos++;
+        skip2: ;
+        }
+    }
+
+    newenvp[newenvppos] = NULL;
+
+    if (newenvp == NULL) {
+        __set_errno(ENOMEM);
+        return errno;
+    }
+
+    if (do_cmd_subst) {
+        newenvp[newenvppos] = malloc(strlen("FAKECHROOT_CMD_ORIG=") + strlen(filename) + 1);
+        strcpy(newenvp[newenvppos], "FAKECHROOT_CMD_ORIG=");
+        strcat(newenvp[newenvppos], filename);
+        newenvppos++;
+    }
+
+    newenvp[newenvppos] = NULL;
+
+    /* Exec substituded command */
+    if (do_cmd_subst) {
+        debug("nextcall(posix_spawn)(\"%s\", {\"%s\", ...}, {\"%s\", ...})", substfilename, argv[0], newenvp[0]);
+
+        /* Indigo udocker */
+        fakechroot_upatch_elf(substfilename);
+
+        status = nextcall(posix_spawn)(pid, substfilename, file_actions, attrp, (char * const *)argv, newenvp);
+        goto error;
+    }
+
+    /* Check hashbang */
+    expand_chroot_path(filename);
+    strcpy(tmp, filename);
+    filename = tmp;
+
+    if ((file = nextcall(open)(filename, O_RDONLY)) == -1) {
+        __set_errno(ENOENT);
+        return errno;
+    }
+
+    i = read(file, hashbang, FAKECHROOT_PATH_MAX-2);
+    close(file);
+    if (i == -1) {
+        __set_errno(ENOENT);
+        return errno;
+    }
+
+    /* No hashbang in argv */
+    if (hashbang[0] != '#' || hashbang[1] != '!') {
+
+        /* Indigo udocker */
+        fakechroot_upatch_elf(filename);
+
+        if (!elfloader) {
+            status = nextcall(posix_spawn)(pid, filename, file_actions, attrp, argv, newenvp);
+            goto error;
+        }
+
+        /* Run via elfloader */
+        for (i = 0, n = (elfloader_opt_argv0 ? 3 : 1); argv[i] != NULL && i < argv_max; ) {
+            newargv[n++] = argv[i++];
+        }
+
+        newargv[n] = 0;
+
+        n = 0;
+        newargv[n++] = elfloader;
+        if (elfloader_opt_argv0) {
+            newargv[n++] = elfloader_opt_argv0;
+            newargv[n++] = argv0;
+        }
+        newargv[n] = filename;
+
+        debug("nextcall(posix_spawn)(\"%s\", {\"%s\", \"%s\", ...}, {\"%s\", ...})", elfloader, newargv[0], newargv[n], newenvp[0]);
+        status = nextcall(posix_spawn)(pid, elfloader, file_actions, attrp, (char * const *)newargv, newenvp);
+        goto error;
+    }
+
+    /* For hashbang we must fix argv[0] */
+    hashbang[i] = hashbang[i+1] = 0;
+    for (i = j = 2; (hashbang[i] == ' ' || hashbang[i] == '\t') && i < FAKECHROOT_PATH_MAX; i++, j++);
+    for (n = 0; i < FAKECHROOT_PATH_MAX; i++) {
+        c = hashbang[i];
+        if (hashbang[i] == 0 || hashbang[i] == ' ' || hashbang[i] == '\t' || hashbang[i] == '\n') {
+            hashbang[i] = 0;
+            if (i > j) {
+                if (n == 0) {
+                    ptr = &hashbang[j];
+                    expand_chroot_path(ptr);
+                    strcpy(newfilename, ptr);
+                }
+                newargv[n++] = &hashbang[j];
+            }
+            j = i + 1;
+        }
+        if (c == '\n' || c == 0)
+            break;
+    }
+
+    newargv[n++] = argv0;
+
+    for (i = 1; argv[i] != NULL && i < argv_max; ) {
+        newargv[n++] = argv[i++];
+    }
+
+    /* Indigo udocker */
+    fakechroot_upatch_elf(newfilename);
+
+    newargv[n] = 0;
+
+    if (!elfloader) {
+        status = nextcall(posix_spawn)(pid, newfilename, file_actions, attrp, (char * const *)newargv, newenvp);
+        goto error;
+    }
+
+    /* Run via elfloader */
+    j = elfloader_opt_argv0 ? 3 : 1;
+    if (n >= argv_max - 1) {
+        n = argv_max - j - 1;
+    }
+    newargv[n+j] = 0;
+    for (i = n; i >= j; i--) {
+        newargv[i] = newargv[i-j];
+    }
+    n = 0;
+    newargv[n++] = elfloader;
+    if (elfloader_opt_argv0) {
+        newargv[n++] = elfloader_opt_argv0;
+        newargv[n++] = argv0;
+    }
+    newargv[n] = newfilename;
+    debug("nextcall(posix_spawn)(\"%s\", {\"%s\", \"%s\", \"%s\", ...}, {\"%s\", ...})", elfloader, newargv[0], newargv[1], newargv[n], newenvp[0]);
+    status = nextcall(posix_spawn)(pid, elfloader, file_actions, attrp, (char * const *)newargv, newenvp);
+
+error:
+    free(newenvp);
+
+    return status;
+}
+
+#endif
diff -Naur fakechroot-2.18.orig/src/rel2absat.c fakechroot/src/rel2absat.c
--- fakechroot-2.18.orig/src/rel2absat.c	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/src/rel2absat.c	2017-04-04 22:24:26.663135804 +0100
@@ -59,6 +59,8 @@
         if (! getcwd(cwd, FAKECHROOT_PATH_MAX)) {
             goto error;
         }
+        /* Indigo udocker */
+        udocker_host_narrow_chroot_path(cwd);
         snprintf(resolved, FAKECHROOT_PATH_MAX, "%s/%s", cwd, name);
     } else {
         if ((cwdfd = nextcall(open)(".", O_RDONLY|O_DIRECTORY)) == -1) {
@@ -76,6 +78,8 @@
         }
         (void)close(cwdfd);
 
+        /* Indigo udocker */
+        udocker_host_narrow_chroot_path(cwd);
         snprintf(resolved, FAKECHROOT_PATH_MAX, "%s/%s", cwd, name);
     }
 
diff -Naur fakechroot-2.18.orig/src/rel2abs.c fakechroot/src/rel2abs.c
--- fakechroot-2.18.orig/src/rel2abs.c	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/src/rel2abs.c	2017-04-04 22:09:37.777456222 +0100
@@ -46,13 +46,16 @@
         goto end;
     }
 
-    getcwd_real(cwd, FAKECHROOT_PATH_MAX);
-    narrow_chroot_path(cwd);
 
     if (*name == '/') {
         strlcpy(resolved, name, FAKECHROOT_PATH_MAX);
+        /* Indigo udocker */
+        narrow_chroot_path(resolved);
     }
     else {
+        getcwd_real(cwd, FAKECHROOT_PATH_MAX);
+        /* Indigo udocker */
+        udocker_host_narrow_chroot_path(cwd);
         snprintf(resolved, FAKECHROOT_PATH_MAX, "%s/%s", cwd, name);
     }
 
diff -Naur fakechroot-2.18.orig/test/Makefile.in fakechroot/test/Makefile.in
--- fakechroot-2.18.orig/test/Makefile.in	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/test/Makefile.in	2016-11-04 19:09:27.366972491 +0000
@@ -1,7 +1,7 @@
-# Makefile.in generated by automake 1.15 from Makefile.am.
+# Makefile.in generated by automake 1.13.4 from Makefile.am.
 # @configure_input@
 
-# Copyright (C) 1994-2014 Free Software Foundation, Inc.
+# Copyright (C) 1994-2013 Free Software Foundation, Inc.
 
 # This Makefile.in is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -14,17 +14,7 @@
 
 @SET_MAKE@
 VPATH = @srcdir@
-am__is_gnu_make = { \
-  if test -z '$(MAKELEVEL)'; then \
-    false; \
-  elif test -n '$(MAKE_HOST)'; then \
-    true; \
-  elif test -n '$(MAKE_VERSION)' && test -n '$(CURDIR)'; then \
-    true; \
-  else \
-    false; \
-  fi; \
-}
+am__is_gnu_make = test -n '$(MAKEFILE_LIST)' && test -n '$(MAKELEVEL)'
 am__make_running_with_option = \
   case $${target_option-} in \
       ?) ;; \
@@ -88,6 +78,8 @@
 build_triplet = @build@
 host_triplet = @host@
 subdir = test
+DIST_COMMON = $(srcdir)/Makefile.in $(srcdir)/Makefile.am \
+	$(top_srcdir)/build-aux/test-driver
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
 am__aclocal_m4_deps = $(top_srcdir)/m4/check_c_alignof.m4 \
 	$(top_srcdir)/m4/check_c_attribute.m4 \
@@ -104,7 +96,6 @@
 	$(top_srcdir)/m4/prog_prove_opt.m4 $(top_srcdir)/configure.ac
 am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
 	$(ACLOCAL_M4)
-DIST_COMMON = $(srcdir)/Makefile.am $(am__DIST_COMMON)
 mkinstalldirs = $(install_sh) -d
 CONFIG_HEADER = $(top_builddir)/config.h
 CONFIG_CLEAN_FILES =
@@ -367,8 +358,6 @@
 TEST_LOG_COMPILE = $(TEST_LOG_COMPILER) $(AM_TEST_LOG_FLAGS) \
 	$(TEST_LOG_FLAGS)
 DIST_SUBDIRS = $(SUBDIRS)
-am__DIST_COMMON = $(srcdir)/Makefile.in \
-	$(top_srcdir)/build-aux/test-driver
 DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
 am__relativize = \
   dir0=`pwd`; \
@@ -522,7 +511,6 @@
 prefix = @prefix@
 program_transform_name = @program_transform_name@
 psdir = @psdir@
-runstatedir = @runstatedir@
 sbindir = @sbindir@
 sharedstatedir = @sharedstatedir@
 srcdir = @srcdir@
@@ -604,6 +592,7 @@
 	echo ' cd $(top_srcdir) && $(AUTOMAKE) --foreign test/Makefile'; \
 	$(am__cd) $(top_srcdir) && \
 	  $(AUTOMAKE) --foreign test/Makefile
+.PRECIOUS: Makefile
 Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
 	@case '$?' in \
 	  *config.status*) \
@@ -757,7 +746,7 @@
 	if test -n "$$am__remaking_logs"; then \
 	  echo "fatal: making $(TEST_SUITE_LOG): possible infinite" \
 	       "recursion detected" >&2; \
-	elif test -n "$$redo_logs"; then \
+	else \
 	  am__remaking_logs=yes $(MAKE) $(AM_MAKEFLAGS) $$redo_logs; \
 	fi; \
 	if $(am__make_dryrun); then :; else \
@@ -1305,8 +1294,6 @@
 	mostlyclean-generic mostlyclean-libtool pdf pdf-am ps ps-am \
 	recheck tags tags-am uninstall uninstall-am
 
-.PRECIOUS: Makefile
-
 
 clean-local:
 	-rm -rf testtree-*
diff -Naur fakechroot-2.18.orig/test/src/Makefile.in fakechroot/test/src/Makefile.in
--- fakechroot-2.18.orig/test/src/Makefile.in	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/test/src/Makefile.in	2016-11-04 19:09:27.429972786 +0000
@@ -1,7 +1,7 @@
-# Makefile.in generated by automake 1.15 from Makefile.am.
+# Makefile.in generated by automake 1.13.4 from Makefile.am.
 # @configure_input@
 
-# Copyright (C) 1994-2014 Free Software Foundation, Inc.
+# Copyright (C) 1994-2013 Free Software Foundation, Inc.
 
 # This Makefile.in is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -14,17 +14,7 @@
 
 @SET_MAKE@
 VPATH = @srcdir@
-am__is_gnu_make = { \
-  if test -z '$(MAKELEVEL)'; then \
-    false; \
-  elif test -n '$(MAKE_HOST)'; then \
-    true; \
-  elif test -n '$(MAKE_VERSION)' && test -n '$(CURDIR)'; then \
-    true; \
-  else \
-    false; \
-  fi; \
-}
+am__is_gnu_make = test -n '$(MAKEFILE_LIST)' && test -n '$(MAKELEVEL)'
 am__make_running_with_option = \
   case $${target_option-} in \
       ?) ;; \
@@ -101,6 +91,8 @@
 	test-socket-af_unix-server$(EXEEXT) test-statfs$(EXEEXT) \
 	test-statvfs$(EXEEXT) test-system$(EXEEXT)
 subdir = test/src
+DIST_COMMON = $(srcdir)/Makefile.in $(srcdir)/Makefile.am \
+	$(top_srcdir)/build-aux/depcomp
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
 am__aclocal_m4_deps = $(top_srcdir)/m4/check_c_alignof.m4 \
 	$(top_srcdir)/m4/check_c_attribute.m4 \
@@ -117,7 +109,6 @@
 	$(top_srcdir)/m4/prog_prove_opt.m4 $(top_srcdir)/configure.ac
 am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
 	$(ACLOCAL_M4)
-DIST_COMMON = $(srcdir)/Makefile.am $(am__DIST_COMMON)
 mkinstalldirs = $(install_sh) -d
 CONFIG_HEADER = $(top_builddir)/config.h
 CONFIG_CLEAN_FILES =
@@ -278,8 +269,6 @@
   done | $(am__uniquify_input)`
 ETAGS = etags
 CTAGS = ctags
-am__DIST_COMMON = $(srcdir)/Makefile.in \
-	$(top_srcdir)/build-aux/depcomp
 DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
 ACLOCAL = @ACLOCAL@
 ALLOCA = @ALLOCA@
@@ -408,7 +397,6 @@
 prefix = @prefix@
 program_transform_name = @program_transform_name@
 psdir = @psdir@
-runstatedir = @runstatedir@
 sbindir = @sbindir@
 sharedstatedir = @sharedstatedir@
 srcdir = @srcdir@
@@ -435,6 +423,7 @@
 	echo ' cd $(top_srcdir) && $(AUTOMAKE) --foreign test/src/Makefile'; \
 	$(am__cd) $(top_srcdir) && \
 	  $(AUTOMAKE) --foreign test/src/Makefile
+.PRECIOUS: Makefile
 Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
 	@case '$?' in \
 	  *config.status*) \
@@ -599,14 +588,14 @@
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(COMPILE) -c -o $@ $<
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(COMPILE) -c $<
 
 .c.obj:
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(COMPILE) -c -o $@ `$(CYGPATH_W) '$<'`
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(COMPILE) -c `$(CYGPATH_W) '$<'`
 
 .c.lo:
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(LTCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
@@ -825,8 +814,6 @@
 	mostlyclean-generic mostlyclean-libtool pdf pdf-am ps ps-am \
 	tags tags-am uninstall uninstall-am
 
-.PRECIOUS: Makefile
-
 
 # Tell versions [3.59,3.63) of GNU make to not export all variables.
 # Otherwise a system limit (for SysV at least) may be exceeded.
diff -Naur fakechroot-2.18.orig/test/t/java.t fakechroot/test/t/java.t
--- fakechroot-2.18.orig/test/t/java.t	2015-10-26 17:29:26.000000000 +0000
+++ fakechroot/test/t/java.t	2016-10-28 16:46:25.000000000 +0100
@@ -6,20 +6,21 @@
 command -v dpkg >/dev/null 2>&1 || skip_all 'dpkg command is missing'
 arch=`dpkg --print-architecture`
 
+JAVA_HOME=/usr/lib/jvm/java-7-openjdk-$arch
+
 command -v javac >/dev/null 2>&1 || skip_all 'javac command is missing (sudo apt-get install openjdk-7-jdk)'
-test -d /usr/lib/jvm/java-7-openjdk-$arch >/dev/null 2>&1 || skip_all "/usr/lib/jvm/java-7-openjdk-$arch directory is missing (sudo apt-get install openjdk-7-jdk)"
+test -d $JAVA_HOME >/dev/null 2>&1 || skip_all "$JAVA_HOME directory is missing (sudo apt-get install openjdk-7-jdk)"
 
 unset JAVA_TOOL_OPTIONS
 
 (
-    set -x
-    java -version
-    javac -version
-    javac java/Hello.java
-    ( cd java && jar cvfm hello.jar manifest.txt Hello.class )
-) 2>&1 | while read line; do
-    echo "# $line"
-done
+    $JAVA_HOME/bin/java -version
+    $JAVA_HOME/bin/javac -version
+) 2>&1 | diag
+(
+    $JAVA_HOME/bin/javac java/Hello.java >/dev/null
+    ( cd java && $JAVA_HOME/bin/jar cvfm hello.jar manifest.txt Hello.class )
+) >/dev/null 2>&1
 
 test -f java/hello.jar >/dev/null 2>&1 || skip_all "java/hello.jar is missing: some problem with java compiler"
 
diff -Naur fakechroot-2.18.orig/.travis.yml fakechroot/.travis.yml
--- fakechroot-2.18.orig/.travis.yml	1970-01-01 01:00:00.000000000 +0100
+++ fakechroot/.travis.yml	2016-10-28 16:46:25.000000000 +0100
@@ -0,0 +1,31 @@
+sudo: false
+addons:
+  apt:
+    packages:
+    - automake
+    - colorgcc
+    - debootstrap
+    - libjemalloc1
+    - libtool
+    - lsb-release
+    - openjdk-7-jdk
+language: c
+before_script:
+  - lsb_release -a
+  - $TRAVIS_CC --version
+script:
+  - ./autogen.sh
+  - ./configure CC=$TRAVIS_CC
+  - make
+  - make test
+env:
+  global:
+    - TEST_DEBOOTSTRAP=1
+    - TEST_DEBOOTSTRAP_CACHE=cache
+  matrix:
+    - TRAVIS_CC=colorgcc EXTRA_CFLAGS='-Wall -Werror'
+    - TRAVIS_CC=clang EXTRA_CFLAGS='-Wall -Werror'
+    - TRAVIS_CC=clang EXTRA_CFLAGS='-std=c11 -Wall -Werror'
+cache:
+  directories:
+    - test/cache
